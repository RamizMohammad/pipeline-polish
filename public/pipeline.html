<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OCR Accuracy Pipeline ¬∑ v7</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600;700&family=Syne:wght@400;500;600;700;800&display=swap');

:root{
  --bg:#050710;
  --s1:#0b0d1a;
  --s2:#0f1222;
  --border:#181b2e;
  --border2:#1e2235;
  --c-p:#a78bfa;
  --c-g:#34d399;
  --c-e:#6ee7b7;
  --c-b:#38bdf8;
  --c-a:#fbbf24;
  --c-c:#22d3ee;
  --c-r:#fb7185;
  --c-o:#f97316;
  --text:#f0f4ff;
  --dim:#ccd8f0;
  --muted:#8896b3;
  --mono:'IBM Plex Mono',monospace;
  --sans:'Syne',sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:var(--sans);display:flex;flex-direction:column;}

body::before{
  content:'';position:fixed;inset:0;z-index:0;
  background-image:
    linear-gradient(rgba(167,139,250,0.018) 1px,transparent 1px),
    linear-gradient(90deg,rgba(167,139,250,0.018) 1px,transparent 1px),
    linear-gradient(rgba(34,211,238,0.009) 1px,transparent 1px),
    linear-gradient(90deg,rgba(34,211,238,0.009) 1px,transparent 1px);
  background-size:80px 80px,80px 80px,20px 20px,20px 20px;
  pointer-events:none;
}

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
.topbar{
  position:relative;z-index:100;flex-shrink:0;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 20px;height:52px;
  background:rgba(5,7,16,0.98);
  border-bottom:1px solid var(--border);
}
.tb-left{display:flex;align-items:center;gap:10px;}
.tb-logo{
  width:30px;height:30px;border-radius:8px;flex-shrink:0;
  background:linear-gradient(135deg,var(--c-p),var(--c-c));
  display:flex;align-items:center;justify-content:center;font-size:13px;
  box-shadow:0 0 16px rgba(167,139,250,0.4);
}
.tb-title{font-size:0.95rem;font-weight:800;letter-spacing:-0.01em;}
.tb-sub{font-family:var(--mono);font-size:0.58rem;color:var(--muted);margin-top:1px;}
.tb-right{display:flex;align-items:center;gap:7px;}

.top-btn{
  display:flex;align-items:center;gap:5px;padding:5px 13px;
  background:var(--s1);border:1px solid var(--border2);border-radius:30px;
  cursor:pointer;font-family:var(--mono);font-size:0.62rem;color:var(--muted);transition:all 0.2s;
}
.top-btn:hover{border-color:rgba(167,139,250,0.4);color:var(--c-p);}
.pip{width:6px;height:6px;border-radius:50%;}
.pip-g{background:var(--c-g);}
.pip-p{background:var(--c-p);}
.flow-on .pip-g{animation:blink 1.1s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.25}}

.mode-tog{display:flex;background:var(--s1);border:1px solid var(--border2);border-radius:30px;padding:3px;gap:2px;}
.mbtn{padding:5px 17px;border-radius:24px;border:none;cursor:pointer;font-family:var(--sans);font-size:0.73rem;font-weight:700;background:transparent;color:var(--muted);transition:all 0.2s;}
.mbtn.active{background:linear-gradient(135deg,var(--c-p),var(--c-c));color:#fff;box-shadow:0 0 14px rgba(167,139,250,0.3);}

/* ‚îÄ‚îÄ VIEWS ‚îÄ‚îÄ */
.view{position:relative;z-index:10;flex:1;overflow-y:auto;overflow-x:auto;display:none;}
.view.active{display:block;}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ARCH / BQ SCHEMA BLOCK
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.arch-block{
  width:100%;max-width:960px;
  border-radius:16px;
  border:1px solid rgba(34,211,238,0.22);
  background:var(--s1);
  overflow:hidden;
  box-shadow:0 0 50px rgba(34,211,238,0.06);
}
.arch-block-top{
  padding:13px 20px;
  background:rgba(34,211,238,0.04);
  border-bottom:1px solid rgba(34,211,238,0.1);
  display:flex;align-items:center;gap:10px;flex-wrap:wrap;
}
.arch-block-icon{width:34px;height:34px;border-radius:8px;background:rgba(34,211,238,0.1);border:1px solid rgba(34,211,238,0.2);display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;}
.arch-block-title{font-size:0.9rem;font-weight:700;color:var(--c-c);}
.arch-block-sub{font-family:var(--mono);font-size:0.52rem;color:var(--muted);margin-top:1px;}
.arch-pills{margin-left:auto;display:flex;gap:6px;flex-wrap:wrap;}
.arch-pill{font-family:var(--mono);font-size:0.5rem;font-weight:600;padding:2px 8px;border-radius:20px;border:1px solid;}

.colflow{display:flex;align-items:stretch;background:rgba(0,0,0,0.18);min-height:480px;}
.cf-sources{width:160px;flex-shrink:0;padding:16px 12px;border-right:1px solid rgba(255,255,255,0.05);display:flex;flex-direction:column;gap:0;justify-content:space-around;}
.cf-src{padding:10px 10px;border-radius:9px;border:1px solid;cursor:default;transition:transform 0.18s,box-shadow 0.18s;flex:1;display:flex;flex-direction:column;justify-content:center;margin:4px 0;}
.cf-src:hover{transform:translateX(3px);}
.cf-src-icon{font-size:0.95rem;margin-bottom:3px;}
.cf-src-name{font-family:var(--mono);font-size:0.65rem;font-weight:700;}
.cf-src-cols{font-family:var(--mono);font-size:0.47rem;margin-top:2px;opacity:0.8;}
.cf-src-k{border-color:rgba(52,211,153,0.3);background:rgba(52,211,153,0.04);}.cf-src-k .cf-src-name{color:#34d399;}
.cf-src-m{border-color:rgba(110,231,183,0.3);background:rgba(110,231,183,0.04);}.cf-src-m .cf-src-name{color:#6ee7b7;}
.cf-src-s{border-color:rgba(251,191,36,0.3);background:rgba(251,191,36,0.04);}.cf-src-s .cf-src-name{color:#fbbf24;}
.cf-src-p{border-color:rgba(167,139,250,0.3);background:rgba(167,139,250,0.04);}.cf-src-p .cf-src-name{color:#a78bfa;}

.cf-wires{flex:0 0 120px;position:relative;background:rgba(0,0,0,0.1);}
.cf-wires svg{position:absolute;inset:0;width:100%;height:100%;overflow:visible;}

.cf-cols{flex:1;min-width:0;padding:12px 16px 12px 8px;display:flex;flex-direction:column;gap:0;overflow-y:visible;}
.cf-col{display:flex;align-items:center;gap:7px;padding:4px 7px;border-radius:7px;border:1px solid rgba(255,255,255,0.04);margin-bottom:3px;transition:background 0.15s,transform 0.15s;cursor:default;}
.cf-col:hover{background:rgba(255,255,255,0.04);transform:translateX(3px);}
.cf-col.col-flash{animation:colFlash 0.5s ease forwards;}
@keyframes colFlash{0%{background:rgba(255,255,255,0.1);}100%{background:transparent;}}
.cf-col-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.cf-col-name{font-family:var(--mono);font-size:0.62rem;font-weight:700;white-space:nowrap;min-width:180px;}
.cf-col-type{font-family:var(--mono);font-size:0.46rem;font-weight:600;padding:1px 5px;border-radius:4px;flex-shrink:0;}
.ct-str{background:rgba(167,139,250,0.15);color:#c4b5fd;}
.ct-int{background:rgba(34,211,238,0.15);color:#67e8f9;}
.ct-fl{background:rgba(251,191,36,0.15);color:#fde68a;}
.ct-bl{background:rgba(52,211,153,0.15);color:#6ee7b7;}
.ct-ts{background:rgba(251,113,133,0.15);color:#fda4af;}
.cf-col-val{font-family:var(--mono);font-size:0.6rem;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;opacity:0.75;}
.cf-col-src{font-family:var(--mono);font-size:0.44rem;font-weight:600;padding:1px 6px;border-radius:20px;border:1px solid;flex-shrink:0;white-space:nowrap;}
.cf-part{font-family:var(--mono);font-size:0.43rem;font-weight:700;padding:1px 5px;border-radius:4px;background:rgba(251,113,133,0.15);color:#fda4af;border:1px solid rgba(251,113,133,0.3);flex-shrink:0;}

@keyframes wireDash{to{stroke-dashoffset:-20;}}
@keyframes flowPulse{0%,100%{opacity:0.85;stroke-width:2;}50%{opacity:1;stroke-width:3;}}

/* ‚îÄ‚îÄ LIVE CSV TABLE ‚îÄ‚îÄ */
.csv-section{border-top:1px solid rgba(255,255,255,0.06);}
.csv-hdr{display:flex;align-items:center;gap:8px;padding:8px 18px;border-bottom:1px solid rgba(255,255,255,0.05);background:rgba(0,0,0,0.2);}
.live-dot{width:7px;height:7px;border-radius:50%;background:#34d399;animation:blink 1s infinite;box-shadow:0 0 6px #34d399;flex-shrink:0;}
.csv-lbl{font-family:var(--mono);font-size:0.56rem;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;color:var(--c-c);}
.csv-sub{font-family:var(--mono);font-size:0.5rem;color:var(--muted);}
.csv-scroll{overflow-x:auto;padding:8px 16px 14px;}
.csv-table{font-family:var(--mono);font-size:0.64rem;border-collapse:separate;border-spacing:0;white-space:nowrap;}
.csv-table th{padding:5px 10px;text-align:left;font-size:0.52rem;font-weight:700;letter-spacing:0.06em;text-transform:uppercase;border-bottom:1px solid rgba(255,255,255,0.08);position:sticky;top:0;background:rgba(11,13,26,0.97);}
.csv-table td{padding:4px 10px;border-bottom:1px solid rgba(255,255,255,0.04);}
.csv-table tbody tr.fresh-row{animation:freshIn 0.4s ease forwards;}
@keyframes freshIn{from{background:rgba(34,211,238,0.07);opacity:0;transform:translateX(-6px);}to{background:transparent;opacity:1;transform:none;}}
.cv-k{color:#6ee7b7;}.cv-m{color:#a7f3d0;}.cv-p{color:#c4b5fd;}.cv-ts{color:#fda4af;}
.cv-ok{color:#86efac;font-weight:600;}.cv-err{color:#fca5a5;}.cv-warn{color:#fcd34d;}.cv-null{color:rgba(255,255,255,0.25);font-style:italic;}.cv-num{color:#93c5fd;}

/* Architecture overlay */
.arch-overlay{position:fixed;inset:0;z-index:500;display:flex;align-items:center;justify-content:center;background:rgba(3,4,12,0.93);backdrop-filter:blur(20px);opacity:0;pointer-events:none;transition:opacity 0.25s;}
.arch-overlay.open{opacity:1;pointer-events:all;}
.arch-panel{width:min(1060px,95vw);max-height:90vh;overflow-y:auto;background:var(--s1);border:1px solid rgba(167,139,250,0.28);border-radius:20px;box-shadow:0 0 80px rgba(167,139,250,0.14),0 40px 100px rgba(0,0,0,0.8);transform:scale(0.93) translateY(20px);transition:transform 0.3s cubic-bezier(0.34,1.4,0.64,1);overflow:hidden;}
.arch-overlay.open .arch-panel{transform:scale(1) translateY(0);}
.arch-panel-top{padding:18px 24px;background:linear-gradient(135deg,rgba(167,139,250,0.08),rgba(34,211,238,0.03));border-bottom:1px solid rgba(255,255,255,0.07);display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:10;backdrop-filter:blur(20px);}
.arch-panel-title{font-size:1rem;font-weight:700;color:#fff;}
.arch-panel-sub{font-family:var(--mono);font-size:0.54rem;color:var(--muted);margin-top:2px;}
.arch-close{margin-left:auto;width:30px;height:30px;border-radius:50%;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:0.85rem;transition:all 0.18s;color:#fff;}
.arch-close:hover{background:rgba(251,113,133,0.2);border-color:var(--c-r);}
.arch-body{padding:22px 24px 28px;}
.arch-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;}
.arch-node{border-radius:12px;border:1px solid;padding:13px 12px;transition:transform 0.2s,box-shadow 0.2s;cursor:default;}
.arch-node:hover{transform:translateY(-3px);}
.arch-node-icon{font-size:1.2rem;margin-bottom:5px;}
.arch-node-name{font-size:0.82rem;font-weight:700;margin-bottom:3px;}
.arch-node-tech{font-family:var(--mono);font-size:0.52rem;color:var(--muted);margin-bottom:7px;}
.arch-node-detail{font-family:var(--mono);font-size:0.53rem;color:var(--dim);line-height:1.65;}
.an-k{border-color:rgba(52,211,153,0.35);background:rgba(52,211,153,0.04);}.an-k .arch-node-name{color:var(--c-g);}
.an-m{border-color:rgba(110,231,183,0.35);background:rgba(110,231,183,0.04);}.an-m .arch-node-name{color:var(--c-e);}
.an-s{border-color:rgba(251,191,36,0.35);background:rgba(251,191,36,0.04);}.an-s .arch-node-name{color:var(--c-a);}
.an-b{border-color:rgba(34,211,238,0.35);background:rgba(34,211,238,0.04);}.an-b .arch-node-name{color:var(--c-c);}
.arch-divider{font-family:var(--mono);font-size:0.54rem;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted);padding:14px 0 10px;display:flex;align-items:center;gap:10px;}
.arch-divider::before,.arch-divider::after{content:'';flex:1;height:1px;background:var(--border);}
.arch-opts{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
.arch-opt{padding:12px 13px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);}
.arch-opt-badge{display:inline-flex;align-items:center;gap:4px;font-family:var(--mono);font-size:0.49rem;font-weight:700;padding:2px 7px;border-radius:20px;margin-bottom:6px;border:1px solid;}
.arch-opt-title{font-size:0.72rem;font-weight:700;color:#fff;margin-bottom:4px;}
.arch-opt-body{font-family:var(--mono);font-size:0.55rem;color:var(--dim);line-height:1.6;}
.arch-statuses{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;}
.arch-status{padding:9px 11px;border-radius:10px;border:1px solid;}
.arch-status-name{font-family:var(--mono);font-size:0.62rem;font-weight:700;margin-bottom:3px;}
.arch-status-desc{font-family:var(--mono);font-size:0.51rem;color:var(--dim);line-height:1.55;}

/* BIZ VIEW */
.biz-hero{text-align:center;padding:6px 0 18px;}
.biz-h{font-size:1.75rem;font-weight:800;letter-spacing:-0.04em;background:linear-gradient(135deg,var(--c-c),var(--c-p));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:5px;}
.biz-sub{font-family:var(--mono);font-size:0.64rem;color:var(--muted);}
.pill-row{display:flex;gap:7px;flex-wrap:wrap;justify-content:center;margin-bottom:20px;}
.pill{display:flex;align-items:center;gap:5px;padding:5px 12px;border-radius:30px;border:1px solid;font-family:var(--mono);font-size:0.6rem;font-weight:600;}
.biz-phase{width:100%;max-width:820px;border-radius:14px;border:1.5px solid;overflow:hidden;margin-bottom:0;}
.biz-phase-bar{height:3px;width:100%;}
.biz-phase-hdr{display:flex;align-items:center;gap:10px;padding:11px 18px;border-bottom:1px solid rgba(255,255,255,0.06);}
.biz-phase-icon{font-size:1.1rem;}
.biz-phase-title{font-size:0.9rem;font-weight:700;}
.biz-phase-sub{font-family:var(--mono);font-size:0.56rem;color:var(--muted);margin-top:1px;}
.biz-phase-badge{margin-left:auto;font-family:var(--mono);font-size:0.54rem;font-weight:600;padding:3px 10px;border-radius:20px;border:1px solid;white-space:nowrap;}
.biz-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:14px 16px 0;}
.biz-card{padding:12px 13px;border-radius:10px;background:rgba(255,255,255,0.025);border:1px solid rgba(255,255,255,0.06);}
.biz-card-icon{font-size:1.2rem;margin-bottom:6px;}
.biz-card-title{font-size:0.78rem;font-weight:700;margin-bottom:5px;}
.biz-card-text{font-size:0.69rem;color:var(--dim);line-height:1.65;}
.biz-outcomes{display:flex;gap:8px;padding:10px 16px 14px;flex-wrap:wrap;}
.biz-outcome{flex:1;min-width:110px;padding:8px 10px;border-radius:9px;border:1px solid;text-align:center;}
.biz-outcome-val{font-size:0.82rem;font-weight:700;margin-bottom:2px;}
.biz-outcome-lbl{font-family:var(--mono);font-size:0.52rem;color:var(--muted);}
.biz-mini-row{display:flex;gap:8px;padding:0 16px 14px;flex-wrap:wrap;}
.biz-mini{flex:1;min-width:80px;padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04);text-align:center;}
.biz-mini-v{font-size:1rem;font-weight:700;}
.biz-mini-l{font-family:var(--mono);font-size:0.5rem;color:var(--muted);margin-top:2px;}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FLOWCHART ‚Äî HTML/CSS REDESIGN v2
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

.fc-container {
  width: 100%;
  max-width: 1100px;
  margin: 0 auto;
  padding: 0 20px 80px;
  position: relative;
}

/* Vertical spine */
.fc-spine {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0;
}

/* Animated vertical connector */
.fc-line {
  width: 3px;
  height: 40px;
  position: relative;
  overflow: hidden;
  border-radius: 2px;
}
.fc-line::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(180deg, var(--line-c, #a78bfa), transparent);
  opacity: 0.4;
}
.fc-line::after {
  content: '';
  position: absolute;
  width: 100%;
  height: 12px;
  background: var(--line-c, #a78bfa);
  border-radius: 50%;
  filter: blur(1px);
  animation: flowDot 1.6s ease-in-out infinite;
  box-shadow: 0 0 8px var(--line-c, #a78bfa);
}
@keyframes flowDot {
  0% { top: -12px; opacity: 0; }
  20% { opacity: 1; }
  80% { opacity: 1; }
  100% { top: 100%; opacity: 0; }
}

/* Arrow tip */
.fc-arrow {
  width: 0; height: 0;
  border-left: 7px solid transparent;
  border-right: 7px solid transparent;
  border-top: 10px solid var(--line-c, #a78bfa);
  margin-top: -2px;
  filter: drop-shadow(0 0 4px var(--line-c, #a78bfa));
}

/* ‚îÄ‚îÄ Section divider ‚îÄ‚îÄ */
.fc-section {
  display: flex;
  align-items: center;
  gap: 14px;
  width: 100%;
  max-width: 900px;
  margin: 8px 0;
}
.fc-section::before,
.fc-section::after {
  content: '';
  flex: 1;
  height: 1px;
}
.fc-section-label {
  font-family: var(--mono);
  font-size: 0.72rem;
  font-weight: 800;
  letter-spacing: 0.14em;
  text-transform: uppercase;
  padding: 6px 20px;
  border-radius: 20px;
  border: 1px solid;
  white-space: nowrap;
  text-align: center;
}

/* ‚îÄ‚îÄ Terminal (start/end) pill ‚îÄ‚îÄ */
.fc-terminal {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 14px 40px;
  border-radius: 50px;
  font-family: var(--sans);
  font-size: 1rem;
  font-weight: 800;
  letter-spacing: 0.02em;
  border: 2.5px solid;
  position: relative;
  text-align: center;
}
.fc-terminal::before {
  content: '';
  position: absolute;
  inset: -6px;
  border-radius: 56px;
  border: 2px solid;
  opacity: 0;
  animation: termPulse 2.5s ease-in-out infinite;
}
@keyframes termPulse {
  0%, 100% { opacity: 0; transform: scale(1); }
  50% { opacity: 0.4; transform: scale(1.02); }
}

/* ‚îÄ‚îÄ Process box ‚îÄ‚îÄ */
.fc-process {
  width: 100%;
  max-width: 640px;
  border-radius: 14px;
  border: 1.5px solid;
  overflow: hidden;
  position: relative;
  transition: transform 0.2s, box-shadow 0.2s;
}
.fc-process:hover {
  transform: translateY(-2px);
}
.fc-process-stripe {
  padding: 10px 20px;
  font-family: var(--mono);
  font-size: 0.68rem;
  font-weight: 700;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  border-bottom: 1px solid rgba(255,255,255,0.06);
}
.fc-process-body {
  padding: 18px 22px 20px;
}
.fc-process-title {
  font-family: var(--sans);
  font-size: 1.15rem;
  font-weight: 800;
  margin-bottom: 14px;
  letter-spacing: -0.01em;
}
.fc-process-lines {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.fc-process-line {
  font-family: var(--mono);
  font-size: 0.78rem;
  line-height: 1.5;
  color: #c5d4ea;
  padding-left: 14px;
  border-left: 2px solid;
  border-color: inherit;
  opacity: 0.85;
}
.fc-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 16px;
}
.fc-chip {
  font-family: var(--mono);
  font-size: 0.68rem;
  font-weight: 700;
  padding: 4px 12px;
  border-radius: 6px;
  border: 1.2px solid;
}

/* ‚îÄ‚îÄ Diamond ‚îÄ‚îÄ */
.fc-diamond-wrap {
  display: flex;
  align-items: center;
  gap: 16px;
  width: 100%;
  max-width: 900px;
  justify-content: center;
  position: relative;
}
.fc-diamond {
  width: 220px;
  height: 130px;
  position: relative;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}
.fc-diamond-bg {
  position: absolute;
  inset: 0;
  transform: rotate(45deg);
  border-radius: 14px;
  border: 2px solid;
}
.fc-diamond-text {
  position: relative;
  z-index: 1;
  font-family: var(--sans);
  font-size: 0.95rem;
  font-weight: 800;
  text-align: center;
  line-height: 1.4;
}

/* ‚îÄ‚îÄ DB cylinder ‚îÄ‚îÄ */
.fc-db {
  width: 100%;
  max-width: 640px;
  border-radius: 0 0 14px 14px;
  border: 1.5px solid;
  overflow: hidden;
  position: relative;
}
.fc-db-disk {
  height: 32px;
  border-radius: 50%;
  margin: -1px -1px 0;
  border: 1.5px solid;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--mono);
  font-size: 0.68rem;
  font-weight: 800;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  position: relative;
  z-index: 2;
}
.fc-db-body {
  padding: 14px 22px 20px;
  margin-top: -4px;
}
.fc-db-title {
  font-family: var(--sans);
  font-size: 1.1rem;
  font-weight: 800;
  margin-bottom: 12px;
}
.fc-db-lines {
  display: flex;
  flex-direction: column;
  gap: 7px;
}
.fc-db-line {
  font-family: var(--mono);
  font-size: 0.76rem;
  line-height: 1.5;
  color: #c5d4ea;
  opacity: 0.85;
}

/* ‚îÄ‚îÄ IO parallelogram (simplified as rounded box) ‚îÄ‚îÄ */
.fc-io {
  width: 100%;
  max-width: 640px;
  padding: 16px 28px;
  border-radius: 12px;
  border: 1.5px solid;
  text-align: center;
  position: relative;
  overflow: hidden;
}
.fc-io::before {
  content: '';
  position: absolute;
  top: 0; left: -20%; right: -20%; bottom: 0;
  transform: skewX(-8deg);
  border-radius: 12px;
  opacity: 0.06;
}
.fc-io-title {
  font-family: var(--sans);
  font-size: 1rem;
  font-weight: 800;
  margin-bottom: 6px;
  position: relative;
}
.fc-io-sub {
  font-family: var(--mono);
  font-size: 0.72rem;
  color: #b0cce8;
  position: relative;
}

/* ‚îÄ‚îÄ Side exit box ‚îÄ‚îÄ */
.fc-side {
  padding: 12px 16px;
  border-radius: 10px;
  border: 1.5px dashed;
  min-width: 180px;
  max-width: 220px;
  flex-shrink: 0;
}
.fc-side-title {
  font-family: var(--sans);
  font-size: 0.82rem;
  font-weight: 800;
  margin-bottom: 6px;
}
.fc-side-line {
  font-family: var(--mono);
  font-size: 0.68rem;
  color: #8896b3;
  line-height: 1.5;
}

/* ‚îÄ‚îÄ Branch tag (YES/NO) ‚îÄ‚îÄ */
.fc-tag {
  font-family: var(--sans);
  font-size: 0.75rem;
  font-weight: 800;
  padding: 3px 14px;
  border-radius: 20px;
  border: 1.5px solid;
  white-space: nowrap;
}

/* ‚îÄ‚îÄ Horizontal branch line ‚îÄ‚îÄ */
.fc-branch-line {
  flex: 1;
  height: 2px;
  min-width: 20px;
  max-width: 80px;
  position: relative;
  overflow: hidden;
}
.fc-branch-line::before {
  content: '';
  position: absolute;
  inset: 0;
  opacity: 0.5;
}
.fc-branch-line::after {
  content: '';
  position: absolute;
  width: 10px;
  height: 100%;
  border-radius: 50%;
  filter: blur(1px);
  animation: hDot 1.4s linear infinite;
}
@keyframes hDot {
  0% { left: -10px; opacity: 0; }
  20% { opacity: 1; }
  80% { opacity: 1; }
  100% { left: 100%; opacity: 0; }
}

/* ‚îÄ‚îÄ 7-status grid ‚îÄ‚îÄ */
.fc-status-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
  width: 100%;
  max-width: 900px;
}
.fc-status-grid.row2 {
  grid-template-columns: repeat(3, 1fr);
  max-width: 680px;
}
.fc-status-card {
  padding: 14px 12px;
  border-radius: 10px;
  border: 1.5px solid;
  text-align: center;
  transition: transform 0.2s;
}
.fc-status-card:hover {
  transform: translateY(-3px);
}
.fc-status-label {
  font-family: var(--sans);
  font-size: 0.82rem;
  font-weight: 800;
  margin-bottom: 6px;
}
.fc-status-desc {
  font-family: var(--mono);
  font-size: 0.64rem;
  color: #8896b3;
  line-height: 1.5;
}

/* ‚îÄ‚îÄ Color helpers ‚îÄ‚îÄ */
.clr-purple { --clr: #a78bfa; --clr-fill: rgba(167,139,250,0.1); --clr-dim: rgba(167,139,250,0.25); }
.clr-green  { --clr: #34d399; --clr-fill: rgba(52,211,153,0.1);  --clr-dim: rgba(52,211,153,0.25); }
.clr-teal   { --clr: #6ee7b7; --clr-fill: rgba(110,231,183,0.1); --clr-dim: rgba(110,231,183,0.25); }
.clr-blue   { --clr: #38bdf8; --clr-fill: rgba(56,189,248,0.1);  --clr-dim: rgba(56,189,248,0.25); }
.clr-amber  { --clr: #fbbf24; --clr-fill: rgba(251,191,36,0.1);  --clr-dim: rgba(251,191,36,0.25); }
.clr-cyan   { --clr: #22d3ee; --clr-fill: rgba(34,211,238,0.1);  --clr-dim: rgba(34,211,238,0.25); }
.clr-red    { --clr: #fb7185; --clr-fill: rgba(251,113,133,0.1);  --clr-dim: rgba(251,113,133,0.25); }
.clr-slate  { --clr: #94a3b8; --clr-fill: rgba(148,163,184,0.08); --clr-dim: rgba(148,163,184,0.2); }


::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:#1e2545;border-radius:3px;}
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="tb-left">
    <div class="tb-logo">‚ü®/‚ü©</div>
    <div>
      <div class="tb-title">OCR Accuracy Pipeline</div>
      <div class="tb-sub">Kafka ‚Üí MongoDB ‚Üí Vendor Classification ‚Üí BigQuery ¬∑ 25-field schema</div>
    </div>
  </div>
  <div class="tb-right">
    <div class="top-btn flow-on" id="flowBtn" onclick="toggleFlow()">
      <div class="pip pip-g" id="flowPip"></div>
      <span>Flow</span>
    </div>
    <div class="top-btn" style="border-color:rgba(167,139,250,0.4);color:var(--c-p);" onclick="openArch()">
      <div class="pip pip-p"></div>
      <span>Architecture</span>
      <span style="font-size:0.7rem;opacity:0.7;">‚§¢</span>
    </div>
    <div class="mode-tog">
      <button class="mbtn active" id="btnDev" onclick="setMode('dev')">‚ü®/‚ü© Developer</button>
      <button class="mbtn" id="btnBiz" onclick="setMode('biz')">üìä Business</button>
    </div>
  </div>
</div>

<!-- ARCHITECTURE OVERLAY -->
<div class="arch-overlay" id="archOverlay" onclick="closeArchOutside(event)">
  <div class="arch-panel">
    <div class="arch-panel-top">
      <div style="font-size:1.4rem;">üèõÔ∏è</div>
      <div>
        <div class="arch-panel-title">System Architecture Overview</div>
        <div class="arch-panel-sub">OCR Accuracy Pipeline ¬∑ 4 systems ¬∑ 5 phases ¬∑ 25 BQ columns ¬∑ 7 status values</div>
      </div>
      <div class="arch-close" onclick="closeArch()">‚úï</div>
    </div>
    <div class="arch-body">
      <div class="arch-grid">
        <div class="arch-node an-k">
          <div class="arch-node-icon">üì°</div>
          <div class="arch-node-name">Apache Kafka</div>
          <div class="arch-node-tech">confluent_kafka ¬∑ consumer</div>
          <div class="arch-node-detail">
            <div>Topic: invoice scan events</div><div>poll timeout: 50ms</div>
            <div>fetch.min.bytes: 64KB</div><div>max.partition: 4MB</div>
            <div>queued.min: 200k msgs</div><div>Window: T-1 full day</div>
          </div>
        </div>
        <div class="arch-node an-m">
          <div class="arch-node-icon">üóÑÔ∏è</div>
          <div class="arch-node-name">MongoDB</div>
          <div class="arch-node-tech">motor / asyncio.to_thread</div>
          <div class="arch-node-detail">
            <div>Pool: 20‚Äì100 connections</div><div>Index: po_id_idx</div>
            <div>Query: $in (batch 100)</div><div>Project: req/res bodies</div>
            <div>LRU cache: 5000 entries</div><div>Cache None = no re-query</div>
          </div>
        </div>
        <div class="arch-node an-s">
          <div class="arch-node-icon">üóÉÔ∏è</div>
          <div class="arch-node-name">MySQL</div>
          <div class="arch-node-tech">PyMySQL ¬∑ connection pool</div>
          <div class="arch-node-detail">
            <div>Pool size: 3 connections</div><div>Table: Dim_Sys_Plant</div>
            <div>Only NOT_FOUND rows</div><div>Deduped GSTINs ‚Üí 1 query</div>
            <div>Vertical filter applied</div><div>Company_ID ‚â† 1 filter</div>
          </div>
        </div>
        <div class="arch-node an-b">
          <div class="arch-node-icon">‚òÅÔ∏è</div>
          <div class="arch-node-name">Google BigQuery</div>
          <div class="arch-node-tech">google-cloud-bigquery</div>
          <div class="arch-node-detail">
            <div>Table: ocr_accuracy_results</div><div>25-column schema</div>
            <div>DAY partition on proc_ts</div><div>Streaming insert (async)</div>
            <div>Batch size: 500 rows</div><div>Auto-created if missing</div>
          </div>
        </div>
      </div>
      <div class="arch-divider">‚ö° Key Optimisations</div>
      <div class="arch-opts">
        <div class="arch-opt">
          <div class="arch-opt-badge" style="color:var(--c-g);border-color:rgba(52,211,153,0.3);background:rgba(52,211,153,0.08);">‚ö° N‚Üí1 Mongo Queries</div>
          <div class="arch-opt-title">Batch $in instead of N find_one</div>
          <div class="arch-opt-body">Collect 100 msgs ‚Üí one find({$in:[...]}) = 1 round-trip. Up to 100√ó fewer DB calls.</div>
        </div>
        <div class="arch-opt">
          <div class="arch-opt-badge" style="color:var(--c-b);border-color:rgba(56,189,248,0.3);background:rgba(56,189,248,0.08);">‚ö° O(1) LRU Cache</div>
          <div class="arch-opt-title">OrderedDict replaces list-scan</div>
          <div class="arch-opt-body">move_to_end() and popitem(last=False) ‚Äî both O(1). Caches None to prevent re-querying missing po_ids.</div>
        </div>
        <div class="arch-opt">
          <div class="arch-opt-badge" style="color:var(--c-a);border-color:rgba(251,191,36,0.3);background:rgba(251,191,36,0.08);">‚ö° MySQL Skip Logic</div>
          <div class="arch-opt-title">Legit rows never touch MySQL</div>
          <div class="arch-opt-body">Only PO_ID_NOT_FOUND rows query MySQL. GSTINs deduplicated ‚Äî always 1 query per batch regardless of count.</div>
        </div>
        <div class="arch-opt">
          <div class="arch-opt-badge" style="color:var(--c-c);border-color:rgba(34,211,238,0.3);background:rgba(34,211,238,0.08);">‚ö° Rolling BQ Writes</div>
          <div class="arch-opt-title">Writes throughout, not at end</div>
          <div class="arch-opt-body">Every 500 rows ‚Üí classify + write to BQ ‚Üí clear buffer. RAM always bounded regardless of daily volume.</div>
        </div>
        <div class="arch-opt">
          <div class="arch-opt-badge" style="color:var(--c-p);border-color:rgba(167,139,250,0.3);background:rgba(167,139,250,0.08);">‚ö° Idempotent Resume</div>
          <div class="arch-opt-title">MAX(kafka_timestamp) offset</div>
          <div class="arch-opt-body">Safe to restart mid-run. start_from_ms = MAX(ts)+1ms. Never re-inserts already-written rows.</div>
        </div>
        <div class="arch-opt">
          <div class="arch-opt-badge" style="color:var(--c-r);border-color:rgba(251,113,133,0.3);background:rgba(251,113,133,0.08);">‚ö° Sync Post-Batch</div>
          <div class="arch-opt-title">No await inside row builder</div>
          <div class="arch-opt-body">build_bq_row() and determine_status() are synchronous ‚Äî eliminates per-row thread dispatch overhead at high throughput.</div>
        </div>
      </div>
      <div class="arch-divider">üìã 7 Match Status Values</div>
      <div class="arch-statuses">
        <div class="arch-status" style="border-color:rgba(52,211,153,0.3);background:rgba(52,211,153,0.05);">
          <div class="arch-status-name" style="color:var(--c-g);">‚úÖ MATCHED</div>
          <div class="arch-status-desc">OCR doc found. Date + total present. time_diff within threshold.</div>
        </div>
        <div class="arch-status" style="border-color:rgba(251,113,133,0.3);background:rgba(251,113,133,0.05);">
          <div class="arch-status-name" style="color:var(--c-r);">‚ùå PO_ID_NOT_FOUND</div>
          <div class="arch-status-desc">po_id in Kafka but no matching MongoDB doc. Triggers MySQL classification.</div>
        </div>
        <div class="arch-status" style="border-color:rgba(251,113,133,0.3);background:rgba(251,113,133,0.05);">
          <div class="arch-status-name" style="color:var(--c-r);">‚ö†Ô∏è PO_ID_MISSING_KAFKA</div>
          <div class="arch-status-desc">Kafka message had no po_id field at all. Skips Mongo ‚Üí empty row stored.</div>
        </div>
        <div class="arch-status" style="border-color:rgba(251,191,36,0.3);background:rgba(251,191,36,0.05);">
          <div class="arch-status-name" style="color:var(--c-a);">‚ö†Ô∏è MONGO_ALL_EMPTY</div>
          <div class="arch-status-desc">Doc found but all critical fields (date, total, GSTIN) are blank strings.</div>
        </div>
        <div class="arch-status" style="border-color:rgba(251,191,36,0.3);background:rgba(251,191,36,0.05);">
          <div class="arch-status-name" style="color:var(--c-a);">‚ö†Ô∏è INVOICE_DATE_MISSING</div>
          <div class="arch-status-desc">OCR doc found but ocr_invoice_date is empty ‚Äî OCR failed to extract date.</div>
        </div>
        <div class="arch-status" style="border-color:rgba(251,191,36,0.3);background:rgba(251,191,36,0.05);">
          <div class="arch-status-name" style="color:var(--c-a);">‚ö†Ô∏è INVOICE_TOTAL_MISSING</div>
          <div class="arch-status-desc">OCR doc found but ocr_invoice_total is empty ‚Äî OCR missed the amount.</div>
        </div>
        <div class="arch-status" style="border-color:rgba(167,139,250,0.3);background:rgba(167,139,250,0.05);">
          <div class="arch-status-name" style="color:var(--c-p);">‚è±Ô∏è TIME_BUFFER_EXCEEDED</div>
          <div class="arch-status-desc">time_diff_seconds exceeds configured threshold. SLA breach detected.</div>
        </div>
        <div class="arch-status" style="border-color:rgba(56,189,248,0.3);background:rgba(56,189,248,0.05);">
          <div class="arch-status-name" style="color:var(--c-b);">üè∑Ô∏è vendor_type values</div>
          <div class="arch-status-desc"><b style="color:var(--c-g);">Legit</b>: OCR worked. <b style="color:var(--c-a);">Manual</b>: External. <b style="color:var(--c-r);">Moglix</b>: Gap to fix.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DEVELOPER VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="view active" id="viewDev">
<div style="display:flex;flex-direction:column;align-items:center;padding:24px 16px 16px;gap:20px;">

  <!-- BQ SCHEMA BLOCK ‚Äî UNTOUCHED -->
  <div class="arch-block" style="margin-bottom:10px;">
    <div class="arch-block-top">
      <div class="arch-block-icon">üèõÔ∏è</div>
      <div>
        <div class="arch-block-title">ocr_accuracy_results ¬∑ BigQuery Schema</div>
        <div class="arch-block-sub">project.dataset.ocr_accuracy_results ¬∑ DAY partition on processing_timestamp ¬∑ 25 columns from 4 sources</div>
      </div>
      <div class="arch-pills">
        <div class="arch-pill" style="color:#34d399;border-color:rgba(52,211,153,0.3);background:rgba(52,211,153,0.07);">üì° Kafka: 7</div>
        <div class="arch-pill" style="color:#6ee7b7;border-color:rgba(110,231,183,0.3);background:rgba(110,231,183,0.07);">üóÑÔ∏è Mongo: 10</div>
        <div class="arch-pill" style="color:#fbbf24;border-color:rgba(251,191,36,0.3);background:rgba(251,191,36,0.07);">üóÉÔ∏è MySQL: 1</div>
        <div class="arch-pill" style="color:#a78bfa;border-color:rgba(167,139,250,0.3);background:rgba(167,139,250,0.07);">‚öôÔ∏è Pipeline: 7</div>
      </div>
    </div>
    <div class="colflow">
      <div class="cf-sources" id="cf-sources">
        <div class="cf-src cf-src-k" id="cf-src-k"><div class="cf-src-icon">üì°</div><div class="cf-src-name">Kafka</div><div class="cf-src-cols" style="color:#34d399;">7 cols ¬∑ msg payload</div></div>
        <div class="cf-src cf-src-m" id="cf-src-m"><div class="cf-src-icon">üóÑÔ∏è</div><div class="cf-src-name">MongoDB</div><div class="cf-src-cols" style="color:#6ee7b7;">10 cols ¬∑ req + resp</div></div>
        <div class="cf-src cf-src-s" id="cf-src-s"><div class="cf-src-icon">üóÉÔ∏è</div><div class="cf-src-name">MySQL</div><div class="cf-src-cols" style="color:#fbbf24;">1 col ¬∑ Dim_Sys_Plant</div></div>
        <div class="cf-src cf-src-p" id="cf-src-p"><div class="cf-src-icon">‚öôÔ∏è</div><div class="cf-src-name">Pipeline</div><div class="cf-src-cols" style="color:#a78bfa;">7 cols ¬∑ computed</div></div>
      </div>
      <div class="cf-wires" id="cf-wires">
        <svg id="cf-svg" width="100%" height="100%"></svg>
      </div>
      <div class="cf-cols" id="cf-cols">
        <div class="cf-col" id="cf-col-0"><div class="cf-col-dot" id="cf-dot-0" style="background:#34d399;box-shadow:0 0 5px #34d39966;"></div><div class="cf-col-name" style="color:#34d399;">kafka_timestamp</div><div class="cf-col-type ct-int">INT</div><div class="cf-col-val" id="cf-val-0">1729123456789</div><div class="cf-col-src" style="color:#34d399;border-color:#34d39944;background:#34d39911;">Kafka</div></div>
        <div class="cf-col" id="cf-col-1"><div class="cf-col-dot" id="cf-dot-1" style="background:#34d399;box-shadow:0 0 5px #34d39966;"></div><div class="cf-col-name" style="color:#34d399;">po_id</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-1">PO-2024-88421</div><div class="cf-col-src" style="color:#34d399;border-color:#34d39944;background:#34d39911;">Kafka</div></div>
        <div class="cf-col" id="cf-col-2"><div class="cf-col-dot" id="cf-dot-2" style="background:#34d399;box-shadow:0 0 5px #34d39966;"></div><div class="cf-col-name" style="color:#34d399;">kafka_final_gstin</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-2">27AABCM1596J1ZQ</div><div class="cf-col-src" style="color:#34d399;border-color:#34d39944;background:#34d39911;">Kafka</div></div>
        <div class="cf-col" id="cf-col-3"><div class="cf-col-dot" id="cf-dot-3" style="background:#34d399;box-shadow:0 0 5px #34d39966;"></div><div class="cf-col-name" style="color:#34d399;">invoice_number_kafka</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-3">INV/2024/10091</div><div class="cf-col-src" style="color:#34d399;border-color:#34d39944;background:#34d39911;">Kafka</div></div>
        <div class="cf-col" id="cf-col-4"><div class="cf-col-dot" id="cf-dot-4" style="background:#34d399;box-shadow:0 0 5px #34d39966;"></div><div class="cf-col-name" style="color:#34d399;">invoice_amount_kafka</div><div class="cf-col-type ct-fl">FLT</div><div class="cf-col-val" id="cf-val-4">14250.00</div><div class="cf-col-src" style="color:#34d399;border-color:#34d39944;background:#34d39911;">Kafka</div></div>
        <div class="cf-col" id="cf-col-5"><div class="cf-col-dot" id="cf-dot-5" style="background:#34d399;box-shadow:0 0 5px #34d39966;"></div><div class="cf-col-name" style="color:#34d399;">invoice_date_kafka</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-5">2024-10-15</div><div class="cf-col-src" style="color:#34d399;border-color:#34d39944;background:#34d39911;">Kafka</div></div>
        <div class="cf-col" id="cf-col-6"><div class="cf-col-dot" id="cf-dot-6" style="background:#34d399;box-shadow:0 0 5px #34d39966;"></div><div class="cf-col-name" style="color:#34d399;">file_url</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-6">https://cdn.moglix.com/‚Ä¶</div><div class="cf-col-src" style="color:#34d399;border-color:#34d39944;background:#34d39911;">Kafka</div></div>
        <div class="cf-col" id="cf-col-7"><div class="cf-col-dot" id="cf-dot-7" style="background:#6ee7b7;box-shadow:0 0 5px #6ee7b766;"></div><div class="cf-col-name" style="color:#6ee7b7;">ocr_invoice_date</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-7">2024-10-15</div><div class="cf-col-src" style="color:#6ee7b7;border-color:#6ee7b744;background:#6ee7b711;">MongoDB</div></div>
        <div class="cf-col" id="cf-col-8"><div class="cf-col-dot" id="cf-dot-8" style="background:#6ee7b7;box-shadow:0 0 5px #6ee7b766;"></div><div class="cf-col-name" style="color:#6ee7b7;">ocr_invoice_total</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-8">14250.00</div><div class="cf-col-src" style="color:#6ee7b7;border-color:#6ee7b744;background:#6ee7b711;">MongoDB</div></div>
        <div class="cf-col" id="cf-col-9"><div class="cf-col-dot" id="cf-dot-9" style="background:#6ee7b7;box-shadow:0 0 5px #6ee7b766;"></div><div class="cf-col-name" style="color:#6ee7b7;">ocr_gstin</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-9">27AABCM1596J1ZQ</div><div class="cf-col-src" style="color:#6ee7b7;border-color:#6ee7b744;background:#6ee7b711;">MongoDB</div></div>
        <div class="cf-col" id="cf-col-10"><div class="cf-col-dot" id="cf-dot-10" style="background:#6ee7b7;box-shadow:0 0 5px #6ee7b766;"></div><div class="cf-col-name" style="color:#6ee7b7;">ocr_qr_detected</div><div class="cf-col-type ct-bl">BOOL</div><div class="cf-col-val" id="cf-val-10">true</div><div class="cf-col-src" style="color:#6ee7b7;border-color:#6ee7b744;background:#6ee7b711;">MongoDB</div></div>
        <div class="cf-col" id="cf-col-11"><div class="cf-col-dot" id="cf-dot-11" style="background:#6ee7b7;box-shadow:0 0 5px #6ee7b766;"></div><div class="cf-col-name" style="color:#6ee7b7;">mongo_created_at</div><div class="cf-col-type ct-ts">TS</div><div class="cf-col-val" id="cf-val-11">2024-10-15 09:32:41</div><div class="cf-col-src" style="color:#6ee7b7;border-color:#6ee7b744;background:#6ee7b711;">MongoDB</div></div>
        <div class="cf-col" id="cf-col-12"><div class="cf-col-dot" id="cf-dot-12" style="background:#6ee7b7;box-shadow:0 0 5px #6ee7b766;"></div><div class="cf-col-name" style="color:#6ee7b7;">mongo_doc_id</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-12">670e4f2a3b8c1d00e9f44a12</div><div class="cf-col-src" style="color:#6ee7b7;border-color:#6ee7b744;background:#6ee7b711;">MongoDB</div></div>
        <div class="cf-col" id="cf-col-13"><div class="cf-col-dot" id="cf-dot-13" style="background:#6ee7b7;box-shadow:0 0 5px #6ee7b766;"></div><div class="cf-col-name" style="color:#6ee7b7;">request_gstin</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-13">27AABCM1596J1ZQ</div><div class="cf-col-src" style="color:#6ee7b7;border-color:#6ee7b744;background:#6ee7b711;">MongoDB</div></div>
        <div class="cf-col" id="cf-col-14"><div class="cf-col-dot" id="cf-dot-14" style="background:#6ee7b7;box-shadow:0 0 5px #6ee7b766;"></div><div class="cf-col-name" style="color:#6ee7b7;">request_invoice_no</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-14">INV/2024/10091</div><div class="cf-col-src" style="color:#6ee7b7;border-color:#6ee7b744;background:#6ee7b711;">MongoDB</div></div>
        <div class="cf-col" id="cf-col-15"><div class="cf-col-dot" id="cf-dot-15" style="background:#6ee7b7;box-shadow:0 0 5px #6ee7b766;"></div><div class="cf-col-name" style="color:#6ee7b7;">request_invoice_date</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-15">2024-10-15</div><div class="cf-col-src" style="color:#6ee7b7;border-color:#6ee7b744;background:#6ee7b711;">MongoDB</div></div>
        <div class="cf-col" id="cf-col-16"><div class="cf-col-dot" id="cf-dot-16" style="background:#6ee7b7;box-shadow:0 0 5px #6ee7b766;"></div><div class="cf-col-name" style="color:#6ee7b7;">request_total</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-16">14250.00</div><div class="cf-col-src" style="color:#6ee7b7;border-color:#6ee7b744;background:#6ee7b711;">MongoDB</div></div>
        <div class="cf-col" id="cf-col-17"><div class="cf-col-dot" id="cf-dot-17" style="background:#fbbf24;box-shadow:0 0 5px #fbbf2466;"></div><div class="cf-col-name" style="color:#fbbf24;">vendor_type</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-17">Legit</div><div class="cf-col-src" style="color:#fbbf24;border-color:#fbbf2444;background:#fbbf2411;">MySQL</div></div>
        <div class="cf-col" id="cf-col-18"><div class="cf-col-dot" id="cf-dot-18" style="background:#a78bfa;box-shadow:0 0 5px #a78bfa66;"></div><div class="cf-col-name" style="color:#a78bfa;">status</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-18">MATCHED</div><div class="cf-col-src" style="color:#a78bfa;border-color:#a78bfa44;background:#a78bfa11;">Pipeline</div></div>
        <div class="cf-col" id="cf-col-19"><div class="cf-col-dot" id="cf-dot-19" style="background:#a78bfa;box-shadow:0 0 5px #a78bfa66;"></div><div class="cf-col-name" style="color:#a78bfa;">time_diff_seconds</div><div class="cf-col-type ct-fl">FLT</div><div class="cf-col-val" id="cf-val-19">3.21</div><div class="cf-col-src" style="color:#a78bfa;border-color:#a78bfa44;background:#a78bfa11;">Pipeline</div></div>
        <div class="cf-col" id="cf-col-20"><div class="cf-col-dot" id="cf-dot-20" style="background:#a78bfa;box-shadow:0 0 5px #a78bfa66;"></div><div class="cf-col-name" style="color:#a78bfa;">processing_timestamp</div><div class="cf-col-type ct-ts">TS</div><span class="cf-part">‚öë PARTITION</span><div class="cf-col-val" id="cf-val-20">2024-10-16 06:14:22</div><div class="cf-col-src" style="color:#a78bfa;border-color:#a78bfa44;background:#a78bfa11;">Pipeline</div></div>
        <div class="cf-col" id="cf-col-21"><div class="cf-col-dot" id="cf-dot-21" style="background:#a78bfa;box-shadow:0 0 5px #a78bfa66;"></div><div class="cf-col-name" style="color:#a78bfa;">pipeline_run_date</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-21">2024-10-15</div><div class="cf-col-src" style="color:#a78bfa;border-color:#a78bfa44;background:#a78bfa11;">Pipeline</div></div>
        <div class="cf-col" id="cf-col-22"><div class="cf-col-dot" id="cf-dot-22" style="background:#a78bfa;box-shadow:0 0 5px #a78bfa66;"></div><div class="cf-col-name" style="color:#a78bfa;">batch_id</div><div class="cf-col-type ct-int">INT</div><div class="cf-col-val" id="cf-val-22">42</div><div class="cf-col-src" style="color:#a78bfa;border-color:#a78bfa44;background:#a78bfa11;">Pipeline</div></div>
        <div class="cf-col" id="cf-col-23"><div class="cf-col-dot" id="cf-dot-23" style="background:#a78bfa;box-shadow:0 0 5px #a78bfa66;"></div><div class="cf-col-name" style="color:#a78bfa;">start_from_ms</div><div class="cf-col-type ct-int">INT</div><div class="cf-col-val" id="cf-val-23">1729036800000</div><div class="cf-col-src" style="color:#a78bfa;border-color:#a78bfa44;background:#a78bfa11;">Pipeline</div></div>
        <div class="cf-col" id="cf-col-24"><div class="cf-col-dot" id="cf-dot-24" style="background:#a78bfa;box-shadow:0 0 5px #a78bfa66;"></div><div class="cf-col-name" style="color:#a78bfa;">t1_end_ms</div><div class="cf-col-type ct-int">INT</div><div class="cf-col-val" id="cf-val-24">1729123199999</div><div class="cf-col-src" style="color:#a78bfa;border-color:#a78bfa44;background:#a78bfa11;">Pipeline</div></div>
      </div>
    </div>
    <!-- LIVE CSV TABLE -->
    <div class="csv-section">
      <div class="csv-hdr">
        <div class="live-dot"></div>
        <div class="csv-lbl">Live Streaming Rows</div>
        <div class="csv-sub">¬∑ insert_rows_json() ¬∑ batch_size=500 ¬∑ rolling mid-pipeline writes</div>
      </div>
      <div class="csv-scroll">
        <table class="csv-table">
          <thead><tr>
            <th style="color:#888;">#</th>
            <th style="color:#34d399;">kafka_timestamp</th>
            <th style="color:#34d399;">po_id</th>
            <th style="color:#34d399;">kafka_final_gstin</th>
            <th style="color:#34d399;">invoice_amount_kafka</th>
            <th style="color:#34d399;">invoice_date_kafka</th>
            <th style="color:#6ee7b7;">ocr_invoice_date</th>
            <th style="color:#6ee7b7;">ocr_invoice_total</th>
            <th style="color:#6ee7b7;">ocr_qr_detected</th>
            <th style="color:#fbbf24;">vendor_type</th>
            <th style="color:#a78bfa;">status</th>
            <th style="color:#a78bfa;">time_diff_seconds</th>
            <th style="color:#fda4af;">processing_timestamp ‚öë</th>
          </tr></thead>
          <tbody id="dev-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê FLOWCHART ‚Äî HTML/CSS v2 ‚ïê‚ïê -->
  <div style="width:100%;border-top:1px solid rgba(167,139,250,0.12);padding-top:40px;margin-top:16px;">
    <div style="text-align:center;margin-bottom:32px;">
      <span style="font-family:var(--sans);font-size:0.9rem;font-weight:800;letter-spacing:0.18em;text-transform:uppercase;color:var(--c-p);background:rgba(167,139,250,0.06);border:1px solid rgba(167,139,250,0.18);padding:10px 32px;border-radius:10px;box-shadow:0 0 30px rgba(167,139,250,0.1);">
        ‚ú¶ &nbsp; PIPELINE EXECUTION FLOW &nbsp; ‚ú¶
      </span>
    </div>

    <div class="fc-container">
    <div class="fc-spine">

      <!-- ‚ïê‚ïê‚ïê PHASE 0 ‚ïê‚ïê‚ïê -->
      <div class="fc-section"><div class="fc-section-label" style="color:#a78bfa;border-color:rgba(167,139,250,0.25);background:rgba(167,139,250,0.1);">‚öô  PHASE 0  ¬∑  PIPELINE STARTUP</div></div>
      <div class="fc-line" style="--line-c:#a78bfa;height:24px;"></div><div class="fc-arrow" style="--line-c:#a78bfa;"></div>

      <div class="fc-terminal" style="color:#d4bbff;border-color:#a78bfa;background:rgba(167,139,250,0.1);box-shadow:0 0 30px rgba(167,139,250,0.15);">üöÄ run_pipeline() ¬∑ Pipeline Start</div>

      <div class="fc-line" style="--line-c:#a78bfa;"></div><div class="fc-arrow" style="--line-c:#a78bfa;"></div>

      <div class="fc-process" style="border-color:#a78bfa;background:rgba(167,139,250,0.06);box-shadow:0 0 30px rgba(167,139,250,0.06);">
        <div class="fc-process-stripe" style="color:#d4bbff;background:rgba(167,139,250,0.12);">‚öôÔ∏è  PROCESS ¬∑ PHASE 0</div>
        <div class="fc-process-body">
          <div class="fc-process-title" style="color:#d4bbff;">PipelineConfig()</div>
          <div class="fc-process-lines">
            <div class="fc-process-line" style="border-color:rgba(167,139,250,0.3);">Load .env ¬∑ Compute T-1 window (yesterday 00:00‚Üí23:59 IST)</div>
            <div class="fc-process-line" style="border-color:rgba(167,139,250,0.3);">Query BQ MAX(kafka_timestamp) ‚Üí start_from_ms = ts+1ms</div>
            <div class="fc-process-line" style="border-color:rgba(167,139,250,0.3);">Idempotent: safe to restart at any point mid-run</div>
          </div>
          <div class="fc-chips">
            <span class="fc-chip" style="color:#d4bbff;border-color:rgba(167,139,250,0.4);background:rgba(167,139,250,0.12);">pipeline_run_date</span>
            <span class="fc-chip" style="color:#d4bbff;border-color:rgba(167,139,250,0.4);background:rgba(167,139,250,0.12);">start_from_ms</span>
            <span class="fc-chip" style="color:#d4bbff;border-color:rgba(167,139,250,0.4);background:rgba(167,139,250,0.12);">t1_end_ms</span>
          </div>
        </div>
      </div>

      <div class="fc-line" style="--line-c:#a78bfa;"></div><div class="fc-arrow" style="--line-c:#a78bfa;"></div>

      <div class="fc-db" style="border-color:#a78bfa;background:rgba(167,139,250,0.06);">
        <div class="fc-db-disk" style="border-color:#a78bfa;background:rgba(167,139,250,0.15);color:#d4bbff;">üîå  DATABASE INIT</div>
        <div class="fc-db-body">
          <div class="fc-db-title" style="color:#d4bbff;">DatabaseConnections.initialize()</div>
          <div class="fc-db-lines">
            <div class="fc-db-line">MongoDB: pool 20‚Äì100 connections ¬∑ index po_id_idx</div>
            <div class="fc-db-line">BigQuery: 25-col table auto-create ¬∑ DAY partition</div>
            <div class="fc-db-line">MySQL: pool=3 ¬∑ Kafka: fetch 64KB min / 4MB max</div>
          </div>
        </div>
      </div>

      <div class="fc-line" style="--line-c:#a78bfa;"></div><div class="fc-arrow" style="--line-c:#a78bfa;"></div>

      <div class="fc-process" style="border-color:#a78bfa;background:rgba(167,139,250,0.06);">
        <div class="fc-process-stripe" style="color:#d4bbff;background:rgba(167,139,250,0.12);">‚öôÔ∏è  PROCESS</div>
        <div class="fc-process-body">
          <div class="fc-process-title" style="color:#d4bbff;">PipelineProcessor.__init__()</div>
          <div class="fc-process-lines">
            <div class="fc-process-line" style="border-color:rgba(167,139,250,0.3);">PipelineStats() ¬∑ MongoCache(OrderedDict, max=5000)</div>
            <div class="fc-process-line" style="border-color:rgba(167,139,250,0.3);">VendorTypeClassifier ¬∑ Init kafka_pending=[] bq_pending=[]</div>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê‚ïê PHASE 1 ‚ïê‚ïê‚ïê -->
      <div class="fc-line" style="--line-c:#34d399;height:50px;"></div><div class="fc-arrow" style="--line-c:#34d399;"></div>
      <div class="fc-section"><div class="fc-section-label" style="color:#34d399;border-color:rgba(52,211,153,0.25);background:rgba(52,211,153,0.1);">üì°  PHASE 1  ¬∑  KAFKA POLL LOOP</div></div>
      <div class="fc-line" style="--line-c:#34d399;height:24px;"></div><div class="fc-arrow" style="--line-c:#34d399;"></div>

      <div class="fc-io" style="border-color:#34d399;background:rgba(52,211,153,0.06);box-shadow:0 0 20px rgba(52,211,153,0.06);">
        <div class="fc-io-title" style="color:#7fffd4;">üì° consumer.poll( timeout = 0.05 s )</div>
        <div class="fc-io-sub">fetch.min.bytes=64KB ¬∑ max.partition=4MB ¬∑ queued.min=200k msgs</div>
      </div>

      <div class="fc-line" style="--line-c:#34d399;"></div><div class="fc-arrow" style="--line-c:#34d399;"></div>

      <!-- Decision: msg is None? -->
      <div class="fc-diamond-wrap">
        <div class="fc-diamond"><div class="fc-diamond-bg" style="border-color:#34d399;background:rgba(52,211,153,0.08);box-shadow:0 0 20px rgba(52,211,153,0.1);"></div><div class="fc-diamond-text" style="color:#7fffd4;">msg<br>is None?</div></div>
        <div class="fc-tag" style="color:#fecdd3;border-color:#fb7185;background:rgba(251,113,133,0.12);">YES ‚Üí</div>
        <div class="fc-branch-line" style="--line-c:#fb7185;"><div style="position:absolute;inset:0;background:#fb7185;"></div></div>
        <div class="fc-side" style="border-color:#fb7185;background:rgba(251,113,133,0.06);"><div class="fc-side-title" style="color:#fecdd3;">empty_polls++</div><div class="fc-side-line">&gt;100 polls + processed&gt;0 ‚Üí END STREAM</div></div>
      </div>

      <div class="fc-tag" style="color:#7fffd4;border-color:#34d399;background:rgba(52,211,153,0.12);margin:4px 0;">‚Üì NO</div>
      <div class="fc-line" style="--line-c:#34d399;height:20px;"></div><div class="fc-arrow" style="--line-c:#34d399;"></div>

      <!-- Decision: msg.error()? -->
      <div class="fc-diamond-wrap">
        <div class="fc-diamond"><div class="fc-diamond-bg" style="border-color:#34d399;background:rgba(52,211,153,0.08);box-shadow:0 0 20px rgba(52,211,153,0.1);"></div><div class="fc-diamond-text" style="color:#7fffd4;">msg<br>.error()?</div></div>
        <div class="fc-tag" style="color:#fecdd3;border-color:#fb7185;background:rgba(251,113,133,0.12);">YES ‚Üí</div>
        <div class="fc-branch-line" style="--line-c:#fb7185;"><div style="position:absolute;inset:0;background:#fb7185;"></div></div>
        <div class="fc-side" style="border-color:#fb7185;background:rgba(251,113,133,0.06);"><div class="fc-side-title" style="color:#fecdd3;">log WARNING</div><div class="fc-side-line">skip msg ¬∑ continue loop ‚Üí poll()</div></div>
      </div>

      <div class="fc-tag" style="color:#7fffd4;border-color:#34d399;background:rgba(52,211,153,0.12);margin:4px 0;">‚Üì NO</div>
      <div class="fc-line" style="--line-c:#34d399;height:20px;"></div><div class="fc-arrow" style="--line-c:#34d399;"></div>

      <!-- Timestamp filter -->
      <div class="fc-process" style="border-color:#34d399;background:rgba(52,211,153,0.06);box-shadow:0 0 20px rgba(52,211,153,0.06);">
        <div class="fc-process-stripe" style="color:#7fffd4;background:rgba(52,211,153,0.12);">üïê  TIMESTAMP WINDOW FILTER</div>
        <div class="fc-process-body">
          <div class="fc-process-title" style="color:#7fffd4;">Timestamp Filter</div>
          <div class="fc-process-lines">
            <div class="fc-process-line" style="border-color:rgba(52,211,153,0.3);">ts ‚â§ 0 ‚Üí skip invalid epoch</div>
            <div class="fc-process-line" style="border-color:rgba(52,211,153,0.3);">ts ‚â§ start_from_ms ‚Üí skipped_old++ ¬∑ log every 500</div>
            <div class="fc-process-line" style="border-color:rgba(52,211,153,0.3);">ts > t1_end_ms ‚Üí STOP LOOP (exit condition)</div>
            <div class="fc-process-line" style="border-color:rgba(52,211,153,0.3);">Else ‚Üí valid event ‚Üí append to buffer</div>
          </div>
          <div class="fc-chips"><span class="fc-chip" style="color:#7fffd4;border-color:rgba(52,211,153,0.4);background:rgba(52,211,153,0.12);">kafka_timestamp</span></div>
        </div>
      </div>

      <div class="fc-line" style="--line-c:#34d399;"></div><div class="fc-arrow" style="--line-c:#34d399;"></div>

      <div class="fc-io" style="border-color:#34d399;background:rgba(52,211,153,0.06);">
        <div class="fc-io-title" style="color:#7fffd4;">üì• Parse JSON ‚Üí kafka_pending.append()</div>
        <div class="fc-io-sub">Extract: po_id ¬∑ gstin ¬∑ inv_date ¬∑ inv_total ¬∑ file_url ¬∑ ts_ms</div>
      </div>

      <div class="fc-line" style="--line-c:#34d399;"></div><div class="fc-arrow" style="--line-c:#34d399;"></div>

      <!-- Decision: buffer >= 100? -->
      <div class="fc-diamond-wrap">
        <div class="fc-diamond"><div class="fc-diamond-bg" style="border-color:#34d399;background:rgba(52,211,153,0.08);box-shadow:0 0 20px rgba(52,211,153,0.1);"></div><div class="fc-diamond-text" style="color:#7fffd4;">len(pending)<br>‚â• 100?</div></div>
        <div class="fc-tag" style="color:#e2e8f0;border-color:#94a3b8;background:rgba(148,163,184,0.12);">NO ‚Üí</div>
        <div class="fc-branch-line" style="--line-c:#94a3b8;"><div style="position:absolute;inset:0;background:#94a3b8;"></div></div>
        <div class="fc-side" style="border-color:#94a3b8;background:rgba(148,163,184,0.06);"><div class="fc-side-title" style="color:#e2e8f0;">‚Üê poll next msg</div><div class="fc-side-line">loop back to consumer.poll()</div></div>
      </div>

      <div class="fc-tag" style="color:#b2fce4;border-color:#6ee7b7;background:rgba(110,231,183,0.12);margin:4px 0;">‚Üì YES</div>

      <!-- ‚ïê‚ïê‚ïê PHASE 1b ‚ïê‚ïê‚ïê -->
      <div class="fc-line" style="--line-c:#6ee7b7;height:40px;"></div><div class="fc-arrow" style="--line-c:#6ee7b7;"></div>
      <div class="fc-section"><div class="fc-section-label" style="color:#6ee7b7;border-color:rgba(110,231,183,0.25);background:rgba(110,231,183,0.1);">‚úÇ  PHASE 1b  ¬∑  BATCH PROCESSING (100 msgs)</div></div>
      <div class="fc-line" style="--line-c:#6ee7b7;height:24px;"></div><div class="fc-arrow" style="--line-c:#6ee7b7;"></div>

      <!-- Split on po_id with side exit -->
      <div class="fc-diamond-wrap">
        <div class="fc-side" style="border-color:#fb7185;background:rgba(251,113,133,0.06);"><div class="fc-side-title" style="color:#fecdd3;">‚ö† MISSING_KAFKA</div><div class="fc-side-line">po_id absent ‚Üí empty BQ row</div></div>
        <div class="fc-branch-line" style="--line-c:#fb7185;"><div style="position:absolute;inset:0;background:#fb7185;"></div></div>
        <div class="fc-tag" style="color:#fecdd3;border-color:#fb7185;background:rgba(251,113,133,0.12);">‚Üê no po_id</div>
        <div class="fc-process" style="border-color:#6ee7b7;background:rgba(110,231,183,0.06);box-shadow:0 0 20px rgba(110,231,183,0.06);flex:1;max-width:440px;">
          <div class="fc-process-stripe" style="color:#b2fce4;background:rgba(110,231,183,0.12);">‚úÇÔ∏è  SPLIT ON po_id</div>
          <div class="fc-process-body">
            <div class="fc-process-title" style="color:#b2fce4;">process_kafka_batch() ‚Üí split</div>
            <div class="fc-process-lines">
              <div class="fc-process-line" style="border-color:rgba(110,231,183,0.3);">Partition: has_po_id vs missing_po list</div>
              <div class="fc-process-line" style="border-color:rgba(110,231,183,0.3);">missing_po ‚Üí _empty_row(PO_ID_MISSING) immediately</div>
              <div class="fc-process-line" style="border-color:rgba(110,231,183,0.3);">Zero MongoDB cost for missing po_id rows</div>
            </div>
          </div>
        </div>
      </div>

      <div class="fc-line" style="--line-c:#6ee7b7;"></div><div class="fc-arrow" style="--line-c:#6ee7b7;"></div>

      <!-- LRU Cache -->
      <div class="fc-process" style="border-color:#38bdf8;background:rgba(56,189,248,0.06);box-shadow:0 0 20px rgba(56,189,248,0.06);">
        <div class="fc-process-stripe" style="color:#bae6fd;background:rgba(56,189,248,0.12);">üíæ  CACHE ¬∑ O(1) LRU ‚Äî MongoCache</div>
        <div class="fc-process-body">
          <div class="fc-process-title" style="color:#bae6fd;">MongoCache._cache_lookup( po_id )</div>
          <div class="fc-process-lines">
            <div class="fc-process-line" style="border-color:rgba(56,189,248,0.3);">OrderedDict LRU max=5,000 entries</div>
            <div class="fc-process-line" style="border-color:rgba(56,189,248,0.3);">HIT ‚Üí move_to_end() O(1) ‚Üí return cached doc</div>
            <div class="fc-process-line" style="border-color:rgba(56,189,248,0.3);">MISS ‚Üí add to to_fetch[] for batch query</div>
            <div class="fc-process-line" style="border-color:rgba(56,189,248,0.3);">Caches None sentinel ‚Üí prevents re-querying missing</div>
          </div>
        </div>
      </div>

      <div class="fc-line" style="--line-c:#6ee7b7;"></div><div class="fc-arrow" style="--line-c:#6ee7b7;"></div>

      <!-- MongoDB -->
      <div class="fc-db" style="border-color:#6ee7b7;background:rgba(110,231,183,0.06);">
        <div class="fc-db-disk" style="border-color:#6ee7b7;background:rgba(110,231,183,0.15);color:#b2fce4;">üóÑ  MONGODB ¬∑ ‚ö° 1 QUERY / 100 MSGS</div>
        <div class="fc-db-body">
          <div class="fc-db-title" style="color:#b2fce4;">fetch_mongo_batch() ‚Äî single $in query</div>
          <div class="fc-db-lines">
            <div class="fc-db-line">find({request_body.po_id:{$in:[...ids]}}) ¬∑ asyncio.to_thread</div>
            <div class="fc-db-line">Project: request_body, response_body, created_at, _id</div>
            <div class="fc-db-line">Was N separate find_one calls ‚Äî now 1 round-trip</div>
          </div>
        </div>
      </div>

      <div class="fc-line" style="--line-c:#6ee7b7;"></div><div class="fc-arrow" style="--line-c:#6ee7b7;"></div>

      <!-- build_bq_row -->
      <div class="fc-process" style="border-color:#6ee7b7;background:rgba(110,231,183,0.06);box-shadow:0 0 20px rgba(110,231,183,0.06);">
        <div class="fc-process-stripe" style="color:#b2fce4;background:rgba(110,231,183,0.12);">üèó  SYNCHRONOUS ‚Äî build_bq_row</div>
        <div class="fc-process-body">
          <div class="fc-process-title" style="color:#b2fce4;">build_bq_row() ‚Üí determine_status()</div>
          <div class="fc-process-lines">
            <div class="fc-process-line" style="border-color:rgba(110,231,183,0.3);">Compute time_diff_seconds = mongo_created_at ‚àí kafka_ts_ms</div>
            <div class="fc-process-line" style="border-color:rgba(110,231,183,0.3);">Determine one of 7 status values (see fan-out below)</div>
            <div class="fc-process-line" style="border-color:rgba(110,231,183,0.3);">vendor_type = None initially (stamped in Phase 2)</div>
          </div>
          <div class="fc-chips">
            <span class="fc-chip" style="color:#b2fce4;border-color:rgba(110,231,183,0.4);background:rgba(110,231,183,0.12);">status</span>
            <span class="fc-chip" style="color:#b2fce4;border-color:rgba(110,231,183,0.4);background:rgba(110,231,183,0.12);">time_diff_seconds</span>
            <span class="fc-chip" style="color:#b2fce4;border-color:rgba(110,231,183,0.4);background:rgba(110,231,183,0.12);">batch_id</span>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê‚ïê 7 STATUS OUTCOMES ‚ïê‚ïê‚ïê -->
      <div class="fc-line" style="--line-c:#6ee7b7;height:30px;"></div>
      <div class="fc-section"><div class="fc-section-label" style="color:#6ee7b7;border-color:rgba(110,231,183,0.25);background:rgba(110,231,183,0.1);">‚Üô  7 STATUS OUTCOMES  ‚Üò</div></div>
      <div style="height:14px;"></div>

      <div class="fc-status-grid">
        <div class="fc-status-card" style="border-color:rgba(52,211,153,0.4);background:rgba(52,211,153,0.06);"><div class="fc-status-label" style="color:#34d399;">‚úÖ MATCHED</div><div class="fc-status-desc">Date+total present ¬∑ time_diff within SLA</div></div>
        <div class="fc-status-card" style="border-color:rgba(251,191,36,0.4);background:rgba(251,191,36,0.06);"><div class="fc-status-label" style="color:#fbbf24;">‚ö† MONGO_EMPTY</div><div class="fc-status-desc">Doc found but all critical fields blank</div></div>
        <div class="fc-status-card" style="border-color:rgba(251,191,36,0.4);background:rgba(251,191,36,0.06);"><div class="fc-status-label" style="color:#fbbf24;">‚ö† DATE_MISSING</div><div class="fc-status-desc">OCR failed to extract invoice date</div></div>
        <div class="fc-status-card" style="border-color:rgba(251,191,36,0.4);background:rgba(251,191,36,0.06);"><div class="fc-status-label" style="color:#fbbf24;">‚ö† TOTAL_MISSING</div><div class="fc-status-desc">OCR missed invoice amount field</div></div>
      </div>
      <div style="height:10px;"></div>
      <div class="fc-status-grid row2">
        <div class="fc-status-card" style="border-color:rgba(167,139,250,0.4);background:rgba(167,139,250,0.06);"><div class="fc-status-label" style="color:#a78bfa;">‚è± TIME_EXCEEDED</div><div class="fc-status-desc">time_diff > threshold ¬∑ SLA breach</div></div>
        <div class="fc-status-card" style="border-color:rgba(251,113,133,0.4);background:rgba(251,113,133,0.06);"><div class="fc-status-label" style="color:#fb7185;">‚ùå NOT_FOUND</div><div class="fc-status-desc">No MongoDB doc ‚Üí MySQL Phase 2</div></div>
        <div class="fc-status-card" style="border-color:rgba(251,113,133,0.4);background:rgba(251,113,133,0.06);"><div class="fc-status-label" style="color:#fb7185;">‚ö† PO_MISSING</div><div class="fc-status-desc">Kafka msg has no po_id field</div></div>
      </div>

      <div style="height:14px;"></div>
      <div style="font-family:var(--mono);font-size:0.72rem;font-weight:700;color:#5a6480;text-align:center;">bq_pending ‚â• 500 ‚Üí classify_and_write()</div>

      <!-- ‚ïê‚ïê‚ïê PHASE 2 ‚ïê‚ïê‚ïê -->
      <div class="fc-line" style="--line-c:#fbbf24;height:50px;"></div><div class="fc-arrow" style="--line-c:#fbbf24;"></div>
      <div class="fc-section"><div class="fc-section-label" style="color:#fbbf24;border-color:rgba(251,191,36,0.25);background:rgba(251,191,36,0.1);">üè∑  PHASE 2  ¬∑  VENDOR CLASSIFICATION</div></div>
      <div class="fc-line" style="--line-c:#fbbf24;height:24px;"></div><div class="fc-arrow" style="--line-c:#fbbf24;"></div>

      <div class="fc-process" style="border-color:#fbbf24;background:rgba(251,191,36,0.06);box-shadow:0 0 20px rgba(251,191,36,0.06);">
        <div class="fc-process-stripe" style="color:#fef08a;background:rgba(251,191,36,0.12);">‚úÇÔ∏è  VENDOR CLASSIFY</div>
        <div class="fc-process-body">
          <div class="fc-process-title" style="color:#fef08a;">classify_and_write( batch ) ‚Üí split</div>
          <div class="fc-process-lines">
            <div class="fc-process-line" style="border-color:rgba(251,191,36,0.3);">legit_rows (status ‚â† NOT_FOUND) ‚Üí tagged Legit instantly</div>
            <div class="fc-process-line" style="border-color:rgba(251,191,36,0.3);">not_found_rows ‚Üí GSTIN dedup + MySQL query</div>
            <div class="fc-process-line" style="border-color:rgba(251,191,36,0.3);">Zero MySQL cost for all matched / incomplete rows</div>
          </div>
        </div>
      </div>

      <div class="fc-line" style="--line-c:#fbbf24;"></div><div class="fc-arrow" style="--line-c:#fbbf24;"></div>

      <!-- Decision: NOT_FOUND? -->
      <div class="fc-diamond-wrap">
        <div class="fc-side" style="border-color:#34d399;background:rgba(52,211,153,0.06);"><div class="fc-side-title" style="color:#7fffd4;">‚úÖ vendor_type = Legit</div><div class="fc-side-line">OCR pipeline worked ¬∑ no MySQL</div></div>
        <div class="fc-branch-line" style="--line-c:#34d399;"><div style="position:absolute;inset:0;background:#34d399;"></div></div>
        <div class="fc-tag" style="color:#7fffd4;border-color:#34d399;background:rgba(52,211,153,0.12);">‚Üê NO</div>
        <div class="fc-diamond"><div class="fc-diamond-bg" style="border-color:#fbbf24;background:rgba(251,191,36,0.08);box-shadow:0 0 20px rgba(251,191,36,0.1);"></div><div class="fc-diamond-text" style="color:#fef08a;">status ==<br>NOT_FOUND?</div></div>
      </div>

      <div class="fc-tag" style="color:#fef08a;border-color:#fbbf24;background:rgba(251,191,36,0.12);margin:4px 0;">‚Üì YES</div>
      <div class="fc-line" style="--line-c:#fbbf24;height:20px;"></div><div class="fc-arrow" style="--line-c:#fbbf24;"></div>

      <!-- MySQL -->
      <div class="fc-db" style="border-color:#fbbf24;background:rgba(251,191,36,0.06);">
        <div class="fc-db-disk" style="border-color:#fbbf24;background:rgba(251,191,36,0.15);color:#fef08a;">üóÉ  MYSQL ¬∑ Dim_Sys_Plant ¬∑ ‚ö° 1 QUERY / BATCH</div>
        <div class="fc-db-body">
          <div class="fc-db-title" style="color:#fef08a;">Dedup GSTINs ‚Üí Dim_Sys_Plant query</div>
          <div class="fc-db-lines">
            <div class="fc-db-line">Set comprehension on not_found_rows.final_gstin ‚Üí dedup</div>
            <div class="fc-db-line">SELECT DISTINCT WHERE GSTIN IN (%s)</div>
            <div class="fc-db-line">AND Vertical NOT IN (ALL, ABFRL) AND Company_ID &lt;&gt; 1</div>
          </div>
        </div>
      </div>

      <div class="fc-line" style="--line-c:#fbbf24;"></div><div class="fc-arrow" style="--line-c:#fbbf24;"></div>

      <!-- Stamp vendor_type with 3-way exits -->
      <div class="fc-diamond-wrap" style="gap:12px;">
        <div class="fc-side" style="border-color:#34d399;background:rgba(52,211,153,0.06);min-width:140px;"><div class="fc-side-title" style="color:#7fffd4;">‚úÖ Legit</div><div class="fc-side-line">status ‚â† NOT_FOUND</div></div>
        <div class="fc-process" style="border-color:#fbbf24;background:rgba(251,191,36,0.06);flex:1;max-width:380px;">
          <div class="fc-process-stripe" style="color:#fef08a;background:rgba(251,191,36,0.12);">üè∑Ô∏è  STAMP vendor_type</div>
          <div class="fc-process-body">
            <div class="fc-process-title" style="color:#fef08a;">row["vendor_type"] = ?</div>
            <div class="fc-process-lines">
              <div class="fc-process-line" style="border-color:rgba(251,191,36,0.3);">‚â† NOT_FOUND ‚Üí Legit</div>
              <div class="fc-process-line" style="border-color:rgba(251,191,36,0.3);">NOT_FOUND + GSTIN in manual_set ‚Üí Manual</div>
              <div class="fc-process-line" style="border-color:rgba(251,191,36,0.3);">NOT_FOUND + not in set ‚Üí Moglix</div>
              <div class="fc-process-line" style="border-color:rgba(251,191,36,0.3);">MySQL ERROR ‚Üí fallback ‚Üí Moglix</div>
            </div>
            <div class="fc-chips">
              <span class="fc-chip" style="color:#7fffd4;border-color:rgba(52,211,153,0.4);background:rgba(52,211,153,0.12);">‚úÖ Legit</span>
              <span class="fc-chip" style="color:#fef08a;border-color:rgba(251,191,36,0.4);background:rgba(251,191,36,0.12);">üìã Manual</span>
              <span class="fc-chip" style="color:#fecdd3;border-color:rgba(251,113,133,0.4);background:rgba(251,113,133,0.12);">üî¥ Moglix</span>
            </div>
          </div>
        </div>
        <div class="fc-side" style="border-color:#fb7185;background:rgba(251,113,133,0.06);min-width:140px;"><div class="fc-side-title" style="color:#fecdd3;">üî¥ Moglix</div><div class="fc-side-line">GSTIN not in manual_set</div></div>
      </div>

      <!-- ‚ïê‚ïê‚ïê PHASE 3 ‚ïê‚ïê‚ïê -->
      <div class="fc-line" style="--line-c:#22d3ee;height:50px;"></div><div class="fc-arrow" style="--line-c:#22d3ee;"></div>
      <div class="fc-section"><div class="fc-section-label" style="color:#22d3ee;border-color:rgba(34,211,238,0.25);background:rgba(34,211,238,0.1);">‚òÅ  PHASE 3  ¬∑  BIGQUERY STREAMING INSERT</div></div>
      <div class="fc-line" style="--line-c:#22d3ee;height:24px;"></div><div class="fc-arrow" style="--line-c:#22d3ee;"></div>

      <div class="fc-process" style="border-color:#22d3ee;background:rgba(34,211,238,0.06);box-shadow:0 0 20px rgba(34,211,238,0.06);">
        <div class="fc-process-stripe" style="color:#cffafe;background:rgba(34,211,238,0.12);">üîÑ  SERIALIZE</div>
        <div class="fc-process-body">
          <div class="fc-process-title" style="color:#cffafe;">serialize_for_json()</div>
          <div class="fc-process-lines">
            <div class="fc-process-line" style="border-color:rgba(34,211,238,0.3);">datetime ‚Üí ISO 8601 string ¬∑ None ‚Üí JSON null</div>
            <div class="fc-process-line" style="border-color:rgba(34,211,238,0.3);">Primitives pass-through ¬∑ Dicts/lists recurse</div>
            <div class="fc-process-line" style="border-color:rgba(34,211,238,0.3);">Prepares complete BQ streaming insert payload</div>
          </div>
        </div>
      </div>

      <div class="fc-line" style="--line-c:#22d3ee;"></div><div class="fc-arrow" style="--line-c:#22d3ee;"></div>

      <!-- BQ Insert with side exits -->
      <div class="fc-diamond-wrap" style="gap:12px;">
        <div class="fc-side" style="border-color:#fb7185;background:rgba(251,113,133,0.06);min-width:160px;"><div class="fc-side-title" style="color:#fecdd3;">‚ö† Insert Error</div><div class="fc-side-line">log + stats.errors+=N ¬∑ non-fatal</div></div>
        <div class="fc-db" style="border-color:#22d3ee;background:rgba(34,211,238,0.06);flex:1;max-width:420px;">
          <div class="fc-db-disk" style="border-color:#22d3ee;background:rgba(34,211,238,0.15);color:#cffafe;">‚òÅ  BIGQUERY ¬∑ STREAMING INSERT</div>
          <div class="fc-db-body">
            <div class="fc-db-title" style="color:#cffafe;">insert_rows_json() ‚Äî 500-row batch</div>
            <div class="fc-db-lines">
              <div class="fc-db-line">BQ streaming ‚Üí project.dataset.ocr_accuracy_results</div>
              <div class="fc-db-line">Partitioned by processing_timestamp (DAY)</div>
              <div class="fc-db-line">‚ö° Rolling mid-pipeline ‚Üí flat RAM at any volume</div>
            </div>
          </div>
        </div>
        <div class="fc-side" style="border-color:#34d399;background:rgba(52,211,153,0.06);min-width:160px;"><div class="fc-side-title" style="color:#7fffd4;">‚úÖ Batch Written</div><div class="fc-side-line">total_batches++ ¬∑ hook</div></div>
      </div>

      <div class="fc-line" style="--line-c:#22d3ee;"></div><div class="fc-arrow" style="--line-c:#22d3ee;"></div>

      <!-- Finalise -->
      <div class="fc-process" style="border-color:#22d3ee;background:rgba(34,211,238,0.06);box-shadow:0 0 20px rgba(34,211,238,0.06);">
        <div class="fc-process-stripe" style="color:#cffafe;background:rgba(34,211,238,0.12);">üîö  FINALISE</div>
        <div class="fc-process-body">
          <div class="fc-process-title" style="color:#cffafe;">Drain + connections.close()</div>
          <div class="fc-process-lines">
            <div class="fc-process-line" style="border-color:rgba(34,211,238,0.3);">on_batch_written() hook ‚Üí override for Slack / metrics</div>
            <div class="fc-process-line" style="border-color:rgba(34,211,238,0.3);">Flush remaining kafka_pending + bq_pending buffers</div>
            <div class="fc-process-line" style="border-color:rgba(34,211,238,0.3);">stats.log_summary() ‚Üí totals, cache ratio, vendor counts</div>
            <div class="fc-process-line" style="border-color:rgba(34,211,238,0.3);">finally block cleanly closes all 4 connections</div>
          </div>
        </div>
      </div>

      <div class="fc-line" style="--line-c:#94a3b8;"></div><div class="fc-arrow" style="--line-c:#94a3b8;"></div>

      <!-- END -->
      <div class="fc-terminal" style="color:#e2e8f0;border-color:#94a3b8;background:rgba(148,163,184,0.08);box-shadow:0 0 20px rgba(148,163,184,0.1);">‚úÖ Pipeline Complete ¬∑ All connections closed</div>

    </div>
    </div>
  </div>

</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BUSINESS VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="view" id="viewBiz">
<div style="display:flex;flex-direction:column;align-items:center;padding:24px 16px 60px;gap:0;">

  <div class="biz-hero">
    <div class="biz-h">Invoice OCR Accuracy Pipeline</div>
    <div class="biz-sub">Automated daily run ¬∑ Processes yesterday's invoice scan events ¬∑ Results in BigQuery by morning</div>
  </div>
  <div class="pill-row">
    <div class="pill" style="border-color:rgba(52,211,153,0.3);color:var(--c-g);background:rgba(52,211,153,0.05);">‚úÖ Fully Automated</div>
    <div class="pill" style="border-color:rgba(34,211,238,0.3);color:var(--c-c);background:rgba(34,211,238,0.05);">üìÖ Daily ¬∑ T-1 Window</div>
    <div class="pill" style="border-color:rgba(167,139,250,0.3);color:var(--c-p);background:rgba(167,139,250,0.05);">üîÑ Idempotent Resume</div>
    <div class="pill" style="border-color:rgba(251,191,36,0.3);color:var(--c-a);background:rgba(251,191,36,0.05);">‚ö° High Throughput</div>
    <div class="pill" style="border-color:rgba(251,113,133,0.3);color:var(--c-r);background:rgba(251,113,133,0.05);">üõ°Ô∏è Fault Tolerant</div>
  </div>

  <div style="font-family:var(--mono);font-size:0.6rem;font-weight:800;letter-spacing:0.2em;text-transform:uppercase;color:#3a4060;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.05);padding:5px 20px;border-radius:4px;margin-bottom:20px;text-align:center;">
    üåÖ &nbsp;Pipeline Starts Every Morning ¬∑ Fully Automated
  </div>

  <div class="biz-phase" style="border-color:rgba(167,139,250,0.28);max-width:860px;">
    <div class="biz-phase-bar" style="background:linear-gradient(90deg,var(--c-p),transparent);"></div>
    <div class="biz-phase-hdr"><div class="biz-phase-icon">‚öôÔ∏è</div><div><div class="biz-phase-title" style="color:var(--c-p);">System Startup</div><div class="biz-phase-sub">Phase 0 ¬∑ Initialisation ¬∑ ~5 seconds</div></div><div class="biz-phase-badge" style="color:var(--c-p);border-color:rgba(167,139,250,0.3);background:rgba(167,139,250,0.08);">Automated</div></div>
    <div class="biz-cards">
      <div class="biz-card"><div class="biz-card-icon">üìÖ</div><div class="biz-card-title" style="color:var(--c-p);">Sets the Processing Window</div><div class="biz-card-text">Automatically targets yesterday's data (00:00‚Äì23:59 IST). Remembers exactly where the last run stopped ‚Äî nothing is ever processed twice, even after a crash or restart.</div></div>
      <div class="biz-card"><div class="biz-card-icon">üîå</div><div class="biz-card-title" style="color:var(--c-p);">Opens All 4 Connections</div><div class="biz-card-text">Connects simultaneously to Kafka (event stream), MongoDB (OCR results), MySQL (vendor master), and BigQuery (reporting warehouse) using optimised connection pools.</div></div>
      <div class="biz-card"><div class="biz-card-icon">üìã</div><div class="biz-card-title" style="color:var(--c-p);">Prepares the Report Table</div><div class="biz-card-text">Verifies the BigQuery 25-column table exists. Creates it automatically if missing ‚Äî zero manual setup required, even on first ever run.</div></div>
    </div>
    <div class="biz-mini-row">
      <div class="biz-mini"><div class="biz-mini-v" style="color:var(--c-p);">4</div><div class="biz-mini-l">systems connected</div></div>
      <div class="biz-mini"><div class="biz-mini-v" style="color:var(--c-p);">25</div><div class="biz-mini-l">BQ columns</div></div>
      <div class="biz-mini"><div class="biz-mini-v" style="color:var(--c-p);">0</div><div class="biz-mini-l">duplicate rows ever</div></div>
      <div class="biz-mini"><div class="biz-mini-v" style="color:var(--c-p);">~5s</div><div class="biz-mini-l">startup time</div></div>
    </div>
  </div>
  <div style="width:3px;height:30px;background:linear-gradient(180deg,rgba(167,139,250,0.8),rgba(52,211,153,0.8));margin:0 auto;"></div>

  <div class="biz-phase" style="border-color:rgba(52,211,153,0.28);max-width:860px;">
    <div class="biz-phase-bar" style="background:linear-gradient(90deg,var(--c-g),transparent);"></div>
    <div class="biz-phase-hdr"><div class="biz-phase-icon">üì®</div><div><div class="biz-phase-title" style="color:var(--c-g);">Read Invoice Scan Events</div><div class="biz-phase-sub">Phase 1 ¬∑ Kafka Consumer ¬∑ Streaming ¬∑ Batched in groups of 100</div></div><div class="biz-phase-badge" style="color:var(--c-g);border-color:rgba(52,211,153,0.3);background:rgba(52,211,153,0.08);">High Throughput</div></div>
    <div class="biz-cards">
      <div class="biz-card"><div class="biz-card-icon">üì•</div><div class="biz-card-title" style="color:var(--c-g);">What Comes In</div><div class="biz-card-text">Each event represents a completed invoice scan ‚Äî contains PO ID, vendor GSTIN, invoice number, expected amount, expected date, and the file URL of the scanned image.</div></div>
      <div class="biz-card"><div class="biz-card-icon">üîç</div><div class="biz-card-title" style="color:var(--c-g);">Smart Filtering</div><div class="biz-card-text">Automatically skips events already processed in prior runs. Only reads events within yesterday's window. Stops precisely at midnight ‚Äî no cross-day data bleed ever occurs.</div></div>
      <div class="biz-card"><div class="biz-card-icon">‚ö°</div><div class="biz-card-title" style="color:var(--c-g);">Batched ‚Äî Not One-by-One</div><div class="biz-card-text">Events collected in groups of 100 before any DB lookup. This reduces MongoDB queries by up to 100√ó versus the original design, dramatically speeding up the daily run.</div></div>
    </div>
    <div class="biz-outcomes">
      <div class="biz-outcome" style="border-color:rgba(52,211,153,0.3);background:rgba(52,211,153,0.04);"><div class="biz-outcome-val" style="color:var(--c-g);">‚úÖ Valid</div><div class="biz-outcome-lbl">Has PO ID ¬∑ In time window</div></div>
      <div class="biz-outcome" style="border-color:rgba(251,113,133,0.3);background:rgba(251,113,133,0.04);"><div class="biz-outcome-val" style="color:var(--c-r);">‚ö†Ô∏è No PO ID</div><div class="biz-outcome-lbl">Recorded as MISSING, skipped</div></div>
      <div class="biz-outcome" style="border-color:rgba(148,163,184,0.3);background:rgba(148,163,184,0.04);"><div class="biz-outcome-val" style="color:#94a3b8;">‚è≠Ô∏è Already Done</div><div class="biz-outcome-lbl">Silently skipped</div></div>
    </div>
  </div>
  <div style="width:3px;height:30px;background:linear-gradient(180deg,rgba(52,211,153,0.8),rgba(110,231,183,0.8));margin:0 auto;"></div>

  <div class="biz-phase" style="border-color:rgba(110,231,183,0.28);max-width:860px;">
    <div class="biz-phase-bar" style="background:linear-gradient(90deg,var(--c-e),transparent);"></div>
    <div class="biz-phase-hdr"><div class="biz-phase-icon">üîé</div><div><div class="biz-phase-title" style="color:var(--c-e);">Look Up OCR Scan Results</div><div class="biz-phase-sub">Phase 1b ¬∑ MongoDB + Smart In-Memory Cache ¬∑ 1 DB query per 100 events</div></div><div class="biz-phase-badge" style="color:var(--c-e);border-color:rgba(110,231,183,0.3);background:rgba(110,231,183,0.08);">Intelligent Caching</div></div>
    <div class="biz-cards">
      <div class="biz-card"><div class="biz-card-icon">üóÑÔ∏è</div><div class="biz-card-title" style="color:var(--c-e);">What We Match</div><div class="biz-card-text">For each scan event, we find the matching OCR result in MongoDB ‚Äî contains what the OCR engine extracted from the invoice image: date, total amount, GSTIN, and QR code status.</div></div>
      <div class="biz-card"><div class="biz-card-icon">‚ö°</div><div class="biz-card-title" style="color:var(--c-e);">In-Memory Smart Cache</div><div class="biz-card-text">Recent lookups cached in memory (5,000 entries). Same PO ID appearing again = zero database queries. O(1) eviction ‚Äî always fast, never stale, never wastes memory.</div></div>
      <div class="biz-card"><div class="biz-card-icon">üìä</div><div class="biz-card-title" style="color:var(--c-e);">Quality Assessment</div><div class="biz-card-text">Each matched result assessed: Was the invoice date extracted? Was the total captured? Was the scan within the SLA time? Determines one of 7 match quality statuses for reporting.</div></div>
    </div>
    <div class="biz-outcomes">
      <div class="biz-outcome" style="border-color:rgba(52,211,153,0.3);background:rgba(52,211,153,0.04);"><div class="biz-outcome-val" style="color:var(--c-g);">‚úÖ MATCHED</div><div class="biz-outcome-lbl">OCR found and complete</div></div>
      <div class="biz-outcome" style="border-color:rgba(251,113,133,0.3);background:rgba(251,113,133,0.04);"><div class="biz-outcome-val" style="color:var(--c-r);">‚ùå NOT FOUND</div><div class="biz-outcome-lbl">No OCR result in database</div></div>
      <div class="biz-outcome" style="border-color:rgba(251,191,36,0.3);background:rgba(251,191,36,0.04);"><div class="biz-outcome-val" style="color:var(--c-a);">‚ö†Ô∏è INCOMPLETE</div><div class="biz-outcome-lbl">Missing date / total / slow</div></div>
    </div>
    <div class="biz-mini-row">
      <div class="biz-mini"><div class="biz-mini-v" style="color:var(--c-e);">5,000</div><div class="biz-mini-l">LRU cache entries</div></div>
      <div class="biz-mini"><div class="biz-mini-v" style="color:var(--c-e);">O(1)</div><div class="biz-mini-l">eviction complexity</div></div>
      <div class="biz-mini"><div class="biz-mini-v" style="color:var(--c-e);">1</div><div class="biz-mini-l">Mongo query / batch</div></div>
      <div class="biz-mini"><div class="biz-mini-v" style="color:var(--c-e);">7</div><div class="biz-mini-l">match status types</div></div>
    </div>
  </div>
  <div style="width:3px;height:30px;background:linear-gradient(180deg,rgba(110,231,183,0.8),rgba(251,191,36,0.8));margin:0 auto;"></div>

  <div class="biz-phase" style="border-color:rgba(251,191,36,0.28);max-width:860px;">
    <div class="biz-phase-bar" style="background:linear-gradient(90deg,var(--c-a),transparent);"></div>
    <div class="biz-phase-hdr"><div class="biz-phase-icon">üè∑Ô∏è</div><div><div class="biz-phase-title" style="color:var(--c-a);">Classify Vendor Type</div><div class="biz-phase-sub">Phase 2 ¬∑ Business Intelligence ¬∑ MySQL Dim_Sys_Plant ¬∑ Only NOT FOUND rows</div></div><div class="biz-phase-badge" style="color:var(--c-a);border-color:rgba(251,191,36,0.3);background:rgba(251,191,36,0.08);">Zero-cost for most rows</div></div>
    <div class="biz-cards">
      <div class="biz-card"><div class="biz-card-icon">ü§î</div><div class="biz-card-title" style="color:var(--c-a);">Why Classify?</div><div class="biz-card-text">When OCR result is missing, we need to understand why. Is this a Moglix vendor ‚Äî an OCR gap to investigate? Or a Manual/external vendor where no OCR result is expected at all?</div></div>
      <div class="biz-card"><div class="biz-card-icon">üîç</div><div class="biz-card-title" style="color:var(--c-a);">How It Works</div><div class="biz-card-text">Vendor's GSTIN cross-checked against Dim_Sys_Plant vendor master with business filters (vertical, company ID). Match ‚Üí Manual vendor (expected gap). No match ‚Üí Moglix vendor (OCR gap to fix).</div></div>
      <div class="biz-card"><div class="biz-card-icon">‚ö°</div><div class="biz-card-title" style="color:var(--c-a);">Zero-Cost for Most Rows</div><div class="biz-card-text">Only NOT FOUND invoices trigger a MySQL query. All matched and incomplete rows tagged "Legit" instantly at zero DB cost. GSTINs are deduplicated ‚Äî always 1 query per batch.</div></div>
    </div>
    <div class="biz-outcomes">
      <div class="biz-outcome" style="border-color:rgba(52,211,153,0.3);background:rgba(52,211,153,0.04);"><div class="biz-outcome-val" style="color:var(--c-g);">‚úÖ Legit</div><div class="biz-outcome-lbl">OCR found ‚Äî working as expected</div></div>
      <div class="biz-outcome" style="border-color:rgba(251,191,36,0.3);background:rgba(251,191,36,0.04);"><div class="biz-outcome-val" style="color:var(--c-a);">üìã Manual</div><div class="biz-outcome-lbl">External vendor ‚Äî expected gap</div></div>
      <div class="biz-outcome" style="border-color:rgba(167,139,250,0.3);background:rgba(167,139,250,0.04);"><div class="biz-outcome-val" style="color:var(--c-p);">üî¥ Moglix</div><div class="biz-outcome-lbl">OCR gap ‚Äî investigate</div></div>
    </div>
  </div>
  <div style="width:3px;height:30px;background:linear-gradient(180deg,rgba(251,191,36,0.8),rgba(34,211,238,0.8));margin:0 auto;"></div>

  <div class="biz-phase" style="border-color:rgba(34,211,238,0.28);max-width:860px;">
    <div class="biz-phase-bar" style="background:linear-gradient(90deg,var(--c-c),transparent);"></div>
    <div class="biz-phase-hdr"><div class="biz-phase-icon">üì§</div><div><div class="biz-phase-title" style="color:var(--c-c);">Store in Reporting Warehouse</div><div class="biz-phase-sub">Phase 3 ¬∑ BigQuery Streaming Insert ¬∑ DAY Partitioned ¬∑ Rolling writes throughout run</div></div><div class="biz-phase-badge" style="color:var(--c-c);border-color:rgba(34,211,238,0.3);background:rgba(34,211,238,0.08);">Memory Efficient</div></div>
    <div class="biz-cards">
      <div class="biz-card"><div class="biz-card-icon">üìä</div><div class="biz-card-title" style="color:var(--c-c);">What Gets Stored</div><div class="biz-card-text">Every invoice event stored with 25 data points: 7 raw Kafka fields, 10 OCR results from MongoDB, 1 vendor classification from MySQL, and 7 pipeline-computed fields.</div></div>
      <div class="biz-card"><div class="biz-card-icon">‚ö°</div><div class="biz-card-title" style="color:var(--c-c);">Always Rolling, Never Blocking</div><div class="biz-card-text">Records written in batches of 500 throughout the run ‚Äî not accumulated until end. RAM usage stays flat whether processing 10,000 or 10 million records per day. Fully scalable.</div></div>
      <div class="biz-card"><div class="biz-card-icon">üåÖ</div><div class="biz-card-title" style="color:var(--c-c);">Analyst-Ready by Morning</div><div class="biz-card-text">Table partitioned by processing date. Dashboards query only yesterday's partition ‚Äî fast, cheap queries. Results available the moment the pipeline finishes, ready when your team starts work.</div></div>
    </div>
    <div class="biz-outcomes">
      <div class="biz-outcome" style="border-color:rgba(34,211,238,0.3);background:rgba(34,211,238,0.04);"><div class="biz-outcome-val" style="color:var(--c-c);">üìà Full Day Report</div><div class="biz-outcome-lbl">Every invoice event recorded</div></div>
      <div class="biz-outcome" style="border-color:rgba(52,211,153,0.3);background:rgba(52,211,153,0.04);"><div class="biz-outcome-val" style="color:var(--c-g);">üéØ OCR Accuracy</div><div class="biz-outcome-lbl">Match rates by vendor & status</div></div>
      <div class="biz-outcome" style="border-color:rgba(167,139,250,0.3);background:rgba(167,139,250,0.04);"><div class="biz-outcome-val" style="color:var(--c-p);">üè∑Ô∏è Vendor Split</div><div class="biz-outcome-lbl">Legit / Manual / Moglix</div></div>
    </div>
    <div class="biz-mini-row">
      <div class="biz-mini"><div class="biz-mini-v" style="color:var(--c-c);">500</div><div class="biz-mini-l">rows per BQ write</div></div>
      <div class="biz-mini"><div class="biz-mini-v" style="color:var(--c-c);">DAY</div><div class="biz-mini-l">partition granularity</div></div>
      <div class="biz-mini"><div class="biz-mini-v" style="color:var(--c-c);">Flat</div><div class="biz-mini-l">RAM at any volume</div></div>
      <div class="biz-mini"><div class="biz-mini-v" style="color:var(--c-c);">25</div><div class="biz-mini-l">columns per row</div></div>
    </div>
  </div>

  <div style="width:3px;height:30px;background:rgba(148,163,184,0.3);margin:0 auto;"></div>
  <div style="font-family:var(--mono);font-size:0.75rem;font-weight:800;color:#4a5580;text-align:center;padding:12px 24px;border:1px solid rgba(255,255,255,0.06);border-radius:30px;margin-bottom:60px;">
    ‚úÖ Run Complete ¬∑ Data Ready ¬∑ Dashboards refresh automatically
  </div>

</div>
</div>

<script>
// ‚îÄ‚îÄ Mode ‚îÄ‚îÄ
function setMode(m){
  ['Dev','Biz'].forEach(v=>{
    document.getElementById('view'+v).classList.toggle('active',v.toLowerCase()===m);
    document.getElementById('btn'+v).classList.toggle('active',v.toLowerCase()===m);
  });
  if(m==='dev'){setTimeout(()=>{drawWires();},200);}
}

// ‚îÄ‚îÄ Flow toggle ‚îÄ‚îÄ
let flowOn=true;
function toggleFlow(){
  flowOn=!flowOn;
  document.getElementById('flowBtn').classList.toggle('flow-on',flowOn);
  document.querySelectorAll('.anim-dot').forEach(el=>el.style.animationPlayState=flowOn?'running':'paused');
  document.querySelectorAll('.flow-anim').forEach(el=>el.style.animationPlayState=flowOn?'running':'paused');
}

// ‚îÄ‚îÄ Arch overlay ‚îÄ‚îÄ
function openArch(){document.getElementById('archOverlay').classList.add('open');}
function closeArch(){document.getElementById('archOverlay').classList.remove('open');}
function closeArchOutside(e){if(e.target===document.getElementById('archOverlay'))closeArch();}

// ‚îÄ‚îÄ Wire diagram (schema) ‚îÄ‚îÄ
const COL_DEFS=[
  [0,'k','#34d399'],[1,'k','#34d399'],[2,'k','#34d399'],[3,'k','#34d399'],[4,'k','#34d399'],[5,'k','#34d399'],[6,'k','#34d399'],
  [7,'m','#6ee7b7'],[8,'m','#6ee7b7'],[9,'m','#6ee7b7'],[10,'m','#6ee7b7'],[11,'m','#6ee7b7'],[12,'m','#6ee7b7'],[13,'m','#6ee7b7'],[14,'m','#6ee7b7'],[15,'m','#6ee7b7'],[16,'m','#6ee7b7'],
  [17,'s','#fbbf24'],
  [18,'p','#a78bfa'],[19,'p','#a78bfa'],[20,'p','#a78bfa'],[21,'p','#a78bfa'],[22,'p','#a78bfa'],[23,'p','#a78bfa'],[24,'p','#a78bfa'],
];

function drawWires(){
  const svg=document.getElementById('cf-svg');
  const wiresDiv=document.getElementById('cf-wires');
  if(!svg||!wiresDiv)return;
  const wRect=wiresDiv.getBoundingClientRect();
  const W=wRect.width||120,H=wRect.height||480;
  svg.setAttribute('viewBox',`0 0 ${W} ${H}`);
  svg.setAttribute('width',W);svg.setAttribute('height',H);
  svg.innerHTML='';
  const defs=document.createElementNS('http://www.w3.org/2000/svg','defs');
  ['k','m','s','p'].forEach(sk=>{
    const f=document.createElementNS('http://www.w3.org/2000/svg','filter');
    f.setAttribute('id','glow-'+sk);f.setAttribute('x','-50%');f.setAttribute('y','-50%');
    f.setAttribute('width','200%');f.setAttribute('height','200%');
    const blur=document.createElementNS('http://www.w3.org/2000/svg','feGaussianBlur');
    blur.setAttribute('stdDeviation','2.5');blur.setAttribute('result','coloredBlur');
    const merge=document.createElementNS('http://www.w3.org/2000/svg','feMerge');
    const mn1=document.createElementNS('http://www.w3.org/2000/svg','feMergeNode');mn1.setAttribute('in','coloredBlur');
    const mn2=document.createElementNS('http://www.w3.org/2000/svg','feMergeNode');mn2.setAttribute('in','SourceGraphic');
    merge.appendChild(mn1);merge.appendChild(mn2);f.appendChild(blur);f.appendChild(merge);defs.appendChild(f);
  });
  svg.appendChild(defs);
  const srcEls={k:document.getElementById('cf-src-k'),m:document.getElementById('cf-src-m'),s:document.getElementById('cf-src-s'),p:document.getElementById('cf-src-p')};
  const srcColors={k:'#34d399',m:'#6ee7b7',s:'#fbbf24',p:'#a78bfa'};
  function relY(el){if(!el)return H/2;const r=el.getBoundingClientRect();return(r.top+r.height/2)-wRect.top;}
  function dotY(i){const el=document.getElementById('cf-dot-'+i);if(!el)return H/2;const r=el.getBoundingClientRect();return(r.top+r.height/2)-wRect.top;}
  COL_DEFS.forEach(([i,sk,color])=>{
    const srcEl=srcEls[sk];if(!srcEl)return;
    const y0=relY(srcEl),y1=dotY(i);
    if(y1<-10||y1>H+10)return;
    const x0=0,x1=W-2,cx0=x0+W*0.4,cx1=x1-W*0.4;
    const pathD=`M${x0},${y0} C${cx0},${y0} ${cx1},${y1} ${x1},${y1}`;
    const pid=`wire-${i}`;
    const g=document.createElementNS('http://www.w3.org/2000/svg','path');
    g.setAttribute('d',pathD);g.setAttribute('stroke',color);g.setAttribute('stroke-width','3');
    g.setAttribute('fill','none');g.setAttribute('opacity','0.07');g.setAttribute('filter',`url(#glow-${sk})`);
    svg.appendChild(g);
    const w=document.createElementNS('http://www.w3.org/2000/svg','path');
    w.setAttribute('id',pid);w.setAttribute('d',pathD);w.setAttribute('stroke',color);
    w.setAttribute('stroke-width','1.2');w.setAttribute('fill','none');w.setAttribute('opacity','0.5');
    w.setAttribute('stroke-dasharray','4 3');
    w.style.animation=`wireDash ${1.2+i*0.04}s linear infinite`;
    w.style.animationDelay=(i*0.05)+'s';
    svg.appendChild(w);
    const dot=document.createElementNS('http://www.w3.org/2000/svg','circle');
    dot.setAttribute('r','2.3');dot.setAttribute('fill',color);dot.setAttribute('opacity','0.95');
    dot.setAttribute('filter',`url(#glow-${sk})`);
    const am=document.createElementNS('http://www.w3.org/2000/svg','animateMotion');
    am.setAttribute('dur',(1.5+i*0.08)+'s');am.setAttribute('repeatCount','indefinite');
    am.setAttribute('calcMode','spline');am.setAttribute('keyTimes','0;1');
    am.setAttribute('keySplines','0.4 0 0.6 1');am.setAttribute('begin',(i*0.06)+'s');
    const mp=document.createElementNS('http://www.w3.org/2000/svg','mpath');
    mp.setAttribute('href','#'+pid);am.appendChild(mp);dot.appendChild(am);svg.appendChild(dot);
    const td=document.createElementNS('http://www.w3.org/2000/svg','circle');
    td.setAttribute('cx',x1);td.setAttribute('cy',y1);td.setAttribute('r','2');
    td.setAttribute('fill',color);td.setAttribute('opacity','0.65');svg.appendChild(td);
  });
  ['k','m','s','p'].forEach(sk=>{
    const el=srcEls[sk];if(!el)return;
    const sy=relY(el),color=srcColors[sk];
    const od=document.createElementNS('http://www.w3.org/2000/svg','circle');
    od.setAttribute('cx','0');od.setAttribute('cy',sy);od.setAttribute('r','4');
    od.setAttribute('fill',color);od.setAttribute('opacity','0.9');
    od.setAttribute('filter',`url(#glow-${sk})`);
    const pa=document.createElementNS('http://www.w3.org/2000/svg','animate');
    pa.setAttribute('attributeName','r');pa.setAttribute('values','3;5.5;3');
    pa.setAttribute('dur','1.8s');pa.setAttribute('repeatCount','indefinite');
    od.appendChild(pa);svg.appendChild(od);
  });
}

// drawFlowchart removed ‚Äî now pure HTML/CSS


// ‚îÄ‚îÄ CSV streaming ‚îÄ‚îÄ
const STATUSES=['MATCHED','MATCHED','MATCHED','PO_ID_NOT_FOUND','INVOICE_DATE_MISSING','INVOICE_TOTAL_MISSING','TIME_BUFFER_EXCEEDED','MONGO_ALL_EMPTY'];
const GSTINS=['27AABCM1596J1ZQ','29AABCP6984L1ZS','07AAACT2727Q1Z4','33AABCE4747C1ZN'];
const PO_IDS=['PO-2024-88421','PO-2024-88422','PO-2024-88423','PO-2024-88424','PO-2024-88425'];
const AMTS=[14250.00,87300.50,3400.00,126000.00,9875.25];
let rowCtrs={dev:1,biz:1};
function rnd(a){return a[Math.floor(Math.random()*a.length)];}
function fmtTs(ms){return new Date(ms).toISOString().replace('T',' ').slice(0,19);}

function makeRow(){
  const st=rnd(STATUSES),ok=st==='MATCHED';
  const vt=st==='PO_ID_NOT_FOUND'?(Math.random()>0.5?'Moglix':'Manual'):'Legit';
  const kts=Date.now()-Math.floor(Math.random()*3600000);
  const mts=kts+Math.floor(Math.random()*30000);
  return{kts:String(kts),po:rnd(PO_IDS),gstin:rnd(GSTINS),amt:rnd(AMTS).toFixed(2),invDate:'2024-10-15',
    ocrDate:ok?'2024-10-15':'',ocrTotal:ok?rnd(AMTS).toFixed(2):'',qr:ok?(Math.random()>0.35?'true':'false'):'false',
    vt,status:st,diff:((mts-kts)/1000).toFixed(2),pts:fmtTs(Date.now())};
}
function sc(s){if(s==='MATCHED')return'cv-ok';if(s.includes('MISSING')||s.includes('EMPTY')||s.includes('EXCEEDED'))return'cv-warn';return'cv-err';}
function vc(v){if(v==='Legit')return'cv-ok';if(v==='Manual')return'cv-warn';return'cv-err';}

function appendRow(tbodyId,key){
  const tbody=document.getElementById(tbodyId);if(!tbody)return;
  const d=makeRow(),n=rowCtrs[key]++;
  const tr=document.createElement('tr');tr.className='fresh-row';
  tr.innerHTML=`
    <td style="color:rgba(255,255,255,0.3);width:26px;">${n}</td>
    <td class="cv-k">${d.kts}</td><td class="cv-k">${d.po}</td><td class="cv-k">${d.gstin}</td>
    <td class="cv-num">${d.amt}</td><td class="cv-k">${d.invDate}</td>
    <td class="${d.ocrDate?'cv-m':'cv-null'}">${d.ocrDate||'null'}</td>
    <td class="${d.ocrTotal?'cv-m':'cv-null'}">${d.ocrTotal||'null'}</td>
    <td class="cv-m">${d.qr}</td>
    <td class="${vc(d.vt)}">${d.vt}</td>
    <td class="${sc(d.status)}">${d.status}</td>
    <td class="cv-num">${d.diff}</td>
    <td class="cv-ts">${d.pts}</td>`;
  tbody.insertBefore(tr,tbody.firstChild);
  for(let i=0;i<25;i++){const r=document.getElementById('cf-col-'+i);if(r){r.classList.remove('col-flash');void r.offsetWidth;r.classList.add('col-flash');}}
  while(tbody.children.length>6)tbody.removeChild(tbody.lastChild);
}

window.addEventListener('load',()=>{
  setTimeout(()=>{
    for(let i=0;i<5;i++){appendRow('dev-tbody','dev');appendRow('biz-tbody','biz');}
    drawWires();
    drawWires();
    setInterval(()=>appendRow('dev-tbody','dev'),2000);
    setInterval(()=>appendRow('biz-tbody','biz'),2400);
  },500);
});
window.addEventListener('resize',()=>{clearTimeout(window._rt);window._rt=setTimeout(()=>{drawWires();},200);});
</script>
</body>
</html>