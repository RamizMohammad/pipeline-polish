<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OCR Accuracy Pipeline Â· v7</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600;700&family=Syne:wght@400;500;600;700;800&display=swap');

:root{
  --bg:#050710;
  --s1:#0b0d1a;
  --s2:#0f1222;
  --border:#181b2e;
  --border2:#1e2235;
  --c-p:#a78bfa;
  --c-g:#34d399;
  --c-e:#6ee7b7;
  --c-b:#38bdf8;
  --c-a:#fbbf24;
  --c-c:#22d3ee;
  --c-r:#fb7185;
  --c-o:#f97316;
  --text:#f0f4ff;
  --dim:#ccd8f0;
  --muted:#8896b3;
  --mono:'IBM Plex Mono',monospace;
  --sans:'Syne',sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:var(--sans);display:flex;flex-direction:column;}

body::before{
  content:'';position:fixed;inset:0;z-index:0;
  background-image:
    linear-gradient(rgba(167,139,250,0.018) 1px,transparent 1px),
    linear-gradient(90deg,rgba(167,139,250,0.018) 1px,transparent 1px),
    linear-gradient(rgba(34,211,238,0.009) 1px,transparent 1px),
    linear-gradient(90deg,rgba(34,211,238,0.009) 1px,transparent 1px);
  background-size:80px 80px,80px 80px,20px 20px,20px 20px;
  pointer-events:none;
}

/* â”€â”€ TOPBAR â”€â”€ */
.topbar{
  position:relative;z-index:100;flex-shrink:0;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 20px;height:52px;
  background:rgba(5,7,16,0.98);
  border-bottom:1px solid var(--border);
}
.tb-left{display:flex;align-items:center;gap:10px;}
.tb-logo{
  width:30px;height:30px;border-radius:8px;flex-shrink:0;
  background:linear-gradient(135deg,var(--c-p),var(--c-c));
  display:flex;align-items:center;justify-content:center;font-size:13px;
  box-shadow:0 0 16px rgba(167,139,250,0.4);
}
.tb-title{font-size:0.95rem;font-weight:800;letter-spacing:-0.01em;}
.tb-sub{font-family:var(--mono);font-size:0.58rem;color:var(--muted);margin-top:1px;}
.tb-right{display:flex;align-items:center;gap:7px;}

.top-btn{
  display:flex;align-items:center;gap:5px;padding:5px 13px;
  background:var(--s1);border:1px solid var(--border2);border-radius:30px;
  cursor:pointer;font-family:var(--mono);font-size:0.62rem;color:var(--muted);transition:all 0.2s;
}
.top-btn:hover{border-color:rgba(167,139,250,0.4);color:var(--c-p);}
.pip{width:6px;height:6px;border-radius:50%;}
.pip-g{background:var(--c-g);}
.pip-p{background:var(--c-p);}
.flow-on .pip-g{animation:blink 1.1s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.25}}

.mode-tog{display:flex;background:var(--s1);border:1px solid var(--border2);border-radius:30px;padding:3px;gap:2px;}
.mbtn{padding:5px 17px;border-radius:24px;border:none;cursor:pointer;font-family:var(--sans);font-size:0.73rem;font-weight:700;background:transparent;color:var(--muted);transition:all 0.2s;}
.mbtn.active{background:linear-gradient(135deg,var(--c-p),var(--c-c));color:#fff;box-shadow:0 0 14px rgba(167,139,250,0.3);}

/* â”€â”€ VIEWS â”€â”€ */
.view{position:relative;z-index:10;flex:1;overflow-y:auto;overflow-x:auto;display:none;}
.view.active{display:block;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ARCH / BQ SCHEMA BLOCK
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.arch-block{
  width:100%;max-width:960px;
  border-radius:16px;
  border:1px solid rgba(34,211,238,0.22);
  background:var(--s1);
  overflow:hidden;
  box-shadow:0 0 50px rgba(34,211,238,0.06);
}
.arch-block-top{
  padding:13px 20px;
  background:rgba(34,211,238,0.04);
  border-bottom:1px solid rgba(34,211,238,0.1);
  display:flex;align-items:center;gap:10px;flex-wrap:wrap;
}
.arch-block-icon{width:34px;height:34px;border-radius:8px;background:rgba(34,211,238,0.1);border:1px solid rgba(34,211,238,0.2);display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;}
.arch-block-title{font-size:0.9rem;font-weight:700;color:var(--c-c);}
.arch-block-sub{font-family:var(--mono);font-size:0.52rem;color:var(--muted);margin-top:1px;}
.arch-pills{margin-left:auto;display:flex;gap:6px;flex-wrap:wrap;}
.arch-pill{font-family:var(--mono);font-size:0.5rem;font-weight:600;padding:2px 8px;border-radius:20px;border:1px solid;}

.colflow{display:flex;align-items:stretch;background:rgba(0,0,0,0.18);min-height:480px;}
.cf-sources{width:160px;flex-shrink:0;padding:16px 12px;border-right:1px solid rgba(255,255,255,0.05);display:flex;flex-direction:column;gap:0;justify-content:space-around;}
.cf-src{padding:10px 10px;border-radius:9px;border:1px solid;cursor:default;transition:transform 0.18s,box-shadow 0.18s;flex:1;display:flex;flex-direction:column;justify-content:center;margin:4px 0;}
.cf-src:hover{transform:translateX(3px);}
.cf-src-icon{font-size:0.95rem;margin-bottom:3px;}
.cf-src-name{font-family:var(--mono);font-size:0.65rem;font-weight:700;}
.cf-src-cols{font-family:var(--mono);font-size:0.47rem;margin-top:2px;opacity:0.8;}
.cf-src-k{border-color:rgba(52,211,153,0.3);background:rgba(52,211,153,0.04);}.cf-src-k .cf-src-name{color:#34d399;}
.cf-src-m{border-color:rgba(110,231,183,0.3);background:rgba(110,231,183,0.04);}.cf-src-m .cf-src-name{color:#6ee7b7;}
.cf-src-s{border-color:rgba(251,191,36,0.3);background:rgba(251,191,36,0.04);}.cf-src-s .cf-src-name{color:#fbbf24;}
.cf-src-p{border-color:rgba(167,139,250,0.3);background:rgba(167,139,250,0.04);}.cf-src-p .cf-src-name{color:#a78bfa;}

.cf-wires{flex:0 0 120px;position:relative;background:rgba(0,0,0,0.1);}
.cf-wires svg{position:absolute;inset:0;width:100%;height:100%;overflow:visible;}

.cf-cols{flex:1;min-width:0;padding:12px 16px 12px 8px;display:flex;flex-direction:column;gap:0;overflow-y:visible;}
.cf-col{display:flex;align-items:center;gap:7px;padding:4px 7px;border-radius:7px;border:1px solid rgba(255,255,255,0.04);margin-bottom:3px;transition:background 0.15s,transform 0.15s;cursor:default;}
.cf-col:hover{background:rgba(255,255,255,0.04);transform:translateX(3px);}
.cf-col.col-flash{animation:colFlash 0.5s ease forwards;}
@keyframes colFlash{0%{background:rgba(255,255,255,0.1);}100%{background:transparent;}}
.cf-col-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.cf-col-name{font-family:var(--mono);font-size:0.62rem;font-weight:700;white-space:nowrap;min-width:180px;}
.cf-col-type{font-family:var(--mono);font-size:0.46rem;font-weight:600;padding:1px 5px;border-radius:4px;flex-shrink:0;}
.ct-str{background:rgba(167,139,250,0.15);color:#c4b5fd;}
.ct-int{background:rgba(34,211,238,0.15);color:#67e8f9;}
.ct-fl{background:rgba(251,191,36,0.15);color:#fde68a;}
.ct-bl{background:rgba(52,211,153,0.15);color:#6ee7b7;}
.ct-ts{background:rgba(251,113,133,0.15);color:#fda4af;}
.cf-col-val{font-family:var(--mono);font-size:0.6rem;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;opacity:0.75;}
.cf-col-src{font-family:var(--mono);font-size:0.44rem;font-weight:600;padding:1px 6px;border-radius:20px;border:1px solid;flex-shrink:0;white-space:nowrap;}
.cf-part{font-family:var(--mono);font-size:0.43rem;font-weight:700;padding:1px 5px;border-radius:4px;background:rgba(251,113,133,0.15);color:#fda4af;border:1px solid rgba(251,113,133,0.3);flex-shrink:0;}

@keyframes wireDash{to{stroke-dashoffset:-20;}}
@keyframes flowPulse{0%,100%{opacity:0.85;stroke-width:2;}50%{opacity:1;stroke-width:3;}}

/* â”€â”€ LIVE CSV TABLE â”€â”€ */
.csv-section{border-top:1px solid rgba(255,255,255,0.06);}
.csv-hdr{display:flex;align-items:center;gap:8px;padding:8px 18px;border-bottom:1px solid rgba(255,255,255,0.05);background:rgba(0,0,0,0.2);}
.live-dot{width:7px;height:7px;border-radius:50%;background:#34d399;animation:blink 1s infinite;box-shadow:0 0 6px #34d399;flex-shrink:0;}
.csv-lbl{font-family:var(--mono);font-size:0.56rem;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;color:var(--c-c);}
.csv-sub{font-family:var(--mono);font-size:0.5rem;color:var(--muted);}
.csv-scroll{overflow-x:auto;padding:8px 16px 14px;}
.csv-table{font-family:var(--mono);font-size:0.64rem;border-collapse:separate;border-spacing:0;white-space:nowrap;}
.csv-table th{padding:5px 10px;text-align:left;font-size:0.52rem;font-weight:700;letter-spacing:0.06em;text-transform:uppercase;border-bottom:1px solid rgba(255,255,255,0.08);position:sticky;top:0;background:rgba(11,13,26,0.97);}
.csv-table td{padding:4px 10px;border-bottom:1px solid rgba(255,255,255,0.04);}
.csv-table tbody tr.fresh-row{animation:freshIn 0.4s ease forwards;}
@keyframes freshIn{from{background:rgba(34,211,238,0.07);opacity:0;transform:translateX(-6px);}to{background:transparent;opacity:1;transform:none;}}
.cv-k{color:#6ee7b7;}.cv-m{color:#a7f3d0;}.cv-p{color:#c4b5fd;}.cv-ts{color:#fda4af;}
.cv-ok{color:#86efac;font-weight:600;}.cv-err{color:#fca5a5;}.cv-warn{color:#fcd34d;}.cv-null{color:rgba(255,255,255,0.25);font-style:italic;}.cv-num{color:#93c5fd;}

/* Architecture overlay */
.arch-overlay{position:fixed;inset:0;z-index:500;display:flex;align-items:center;justify-content:center;background:rgba(3,4,12,0.93);backdrop-filter:blur(20px);opacity:0;pointer-events:none;transition:opacity 0.25s;}
.arch-overlay.open{opacity:1;pointer-events:all;}
.arch-panel{width:min(1060px,95vw);max-height:90vh;overflow-y:auto;background:var(--s1);border:1px solid rgba(167,139,250,0.28);border-radius:20px;box-shadow:0 0 80px rgba(167,139,250,0.14),0 40px 100px rgba(0,0,0,0.8);transform:scale(0.93) translateY(20px);transition:transform 0.3s cubic-bezier(0.34,1.4,0.64,1);overflow:hidden;}
.arch-overlay.open .arch-panel{transform:scale(1) translateY(0);}
.arch-panel-top{padding:18px 24px;background:linear-gradient(135deg,rgba(167,139,250,0.08),rgba(34,211,238,0.03));border-bottom:1px solid rgba(255,255,255,0.07);display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:10;backdrop-filter:blur(20px);}
.arch-panel-title{font-size:1rem;font-weight:700;color:#fff;}
.arch-panel-sub{font-family:var(--mono);font-size:0.54rem;color:var(--muted);margin-top:2px;}
.arch-close{margin-left:auto;width:30px;height:30px;border-radius:50%;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:0.85rem;transition:all 0.18s;color:#fff;}
.arch-close:hover{background:rgba(251,113,133,0.2);border-color:var(--c-r);}
.arch-body{padding:22px 24px 28px;}
.arch-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;}
.arch-node{border-radius:12px;border:1px solid;padding:13px 12px;transition:transform 0.2s,box-shadow 0.2s;cursor:default;}
.arch-node:hover{transform:translateY(-3px);}
.arch-node-icon{font-size:1.2rem;margin-bottom:5px;}
.arch-node-name{font-size:0.82rem;font-weight:700;margin-bottom:3px;}
.arch-node-tech{font-family:var(--mono);font-size:0.52rem;color:var(--muted);margin-bottom:7px;}
.arch-node-detail{font-family:var(--mono);font-size:0.53rem;color:var(--dim);line-height:1.65;}
.an-k{border-color:rgba(52,211,153,0.35);background:rgba(52,211,153,0.04);}.an-k .arch-node-name{color:var(--c-g);}
.an-m{border-color:rgba(110,231,183,0.35);background:rgba(110,231,183,0.04);}.an-m .arch-node-name{color:var(--c-e);}
.an-s{border-color:rgba(251,191,36,0.35);background:rgba(251,191,36,0.04);}.an-s .arch-node-name{color:var(--c-a);}
.an-b{border-color:rgba(34,211,238,0.35);background:rgba(34,211,238,0.04);}.an-b .arch-node-name{color:var(--c-c);}
.arch-divider{font-family:var(--mono);font-size:0.54rem;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted);padding:14px 0 10px;display:flex;align-items:center;gap:10px;}
.arch-divider::before,.arch-divider::after{content:'';flex:1;height:1px;background:var(--border);}
.arch-opts{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
.arch-opt{padding:12px 13px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);}
.arch-opt-badge{display:inline-flex;align-items:center;gap:4px;font-family:var(--mono);font-size:0.49rem;font-weight:700;padding:2px 7px;border-radius:20px;margin-bottom:6px;border:1px solid;}
.arch-opt-title{font-size:0.72rem;font-weight:700;color:#fff;margin-bottom:4px;}
.arch-opt-body{font-family:var(--mono);font-size:0.55rem;color:var(--dim);line-height:1.6;}
.arch-statuses{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;}
.arch-status{padding:9px 11px;border-radius:10px;border:1px solid;}
.arch-status-name{font-family:var(--mono);font-size:0.62rem;font-weight:700;margin-bottom:3px;}
.arch-status-desc{font-family:var(--mono);font-size:0.51rem;color:var(--dim);line-height:1.55;}

/* BIZ VIEW */
.biz-hero{text-align:center;padding:6px 0 18px;}
.biz-h{font-size:1.75rem;font-weight:800;letter-spacing:-0.04em;background:linear-gradient(135deg,var(--c-c),var(--c-p));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:5px;}
.biz-sub{font-family:var(--mono);font-size:0.64rem;color:var(--muted);}
.pill-row{display:flex;gap:7px;flex-wrap:wrap;justify-content:center;margin-bottom:20px;}
.pill{display:flex;align-items:center;gap:5px;padding:5px 12px;border-radius:30px;border:1px solid;font-family:var(--mono);font-size:0.6rem;font-weight:600;}
.biz-phase{width:100%;max-width:820px;border-radius:14px;border:1.5px solid;overflow:hidden;margin-bottom:0;}
.biz-phase-bar{height:3px;width:100%;}
.biz-phase-hdr{display:flex;align-items:center;gap:10px;padding:11px 18px;border-bottom:1px solid rgba(255,255,255,0.06);}
.biz-phase-icon{font-size:1.1rem;}
.biz-phase-title{font-size:0.9rem;font-weight:700;}
.biz-phase-sub{font-family:var(--mono);font-size:0.56rem;color:var(--muted);margin-top:1px;}
.biz-phase-badge{margin-left:auto;font-family:var(--mono);font-size:0.54rem;font-weight:600;padding:3px 10px;border-radius:20px;border:1px solid;white-space:nowrap;}
.biz-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:14px 16px 0;}
.biz-card{padding:12px 13px;border-radius:10px;background:rgba(255,255,255,0.025);border:1px solid rgba(255,255,255,0.06);}
.biz-card-icon{font-size:1.2rem;margin-bottom:6px;}
.biz-card-title{font-size:0.78rem;font-weight:700;margin-bottom:5px;}
.biz-card-text{font-size:0.69rem;color:var(--dim);line-height:1.65;}
.biz-outcomes{display:flex;gap:8px;padding:10px 16px 14px;flex-wrap:wrap;}
.biz-outcome{flex:1;min-width:110px;padding:8px 10px;border-radius:9px;border:1px solid;text-align:center;}
.biz-outcome-val{font-size:0.82rem;font-weight:700;margin-bottom:2px;}
.biz-outcome-lbl{font-family:var(--mono);font-size:0.52rem;color:var(--muted);}
.biz-mini-row{display:flex;gap:8px;padding:0 16px 14px;flex-wrap:wrap;}
.biz-mini{flex:1;min-width:80px;padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04);text-align:center;}
.biz-mini-v{font-size:1rem;font-weight:700;}
.biz-mini-l{font-family:var(--mono);font-size:0.5rem;color:var(--muted);margin-top:2px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FLOWCHART â€” COMPLETE REDESIGN
   SVG-based proper branching flowchart
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

#fc-svg-container {
  width: 100%;
  min-width: 1300px;
  padding: 40px 20px 80px;
  display: flex;
  justify-content: center;
}

#pipeline-svg {
  font-family: 'IBM Plex Mono', monospace;
  overflow: visible;
}

/* Node hover effects */
.fc-node { cursor: default; transition: all 0.2s; }
.fc-node:hover .node-bg { filter: brightness(1.15); }

/* Animated flow dots on connectors */
.flow-dot { animation: flowMove 1.8s linear infinite; opacity: 0; }
@keyframes flowMove {
  0%   { offset-distance: 0%;   opacity: 0; }
  5%   { opacity: 1; }
  95%  { opacity: 1; }
  100% { offset-distance: 100%; opacity: 0; }
}

::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:#1e2545;border-radius:3px;}
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="tb-left">
    <div class="tb-logo">âŸ¨/âŸ©</div>
    <div>
      <div class="tb-title">OCR Accuracy Pipeline</div>
      <div class="tb-sub">Kafka â†’ MongoDB â†’ Vendor Classification â†’ BigQuery Â· 25-field schema</div>
    </div>
  </div>
  <div class="tb-right">
    <div class="top-btn flow-on" id="flowBtn" onclick="toggleFlow()">
      <div class="pip pip-g" id="flowPip"></div>
      <span>Flow</span>
    </div>
    <div class="top-btn" style="border-color:rgba(167,139,250,0.4);color:var(--c-p);" onclick="openArch()">
      <div class="pip pip-p"></div>
      <span>Architecture</span>
      <span style="font-size:0.7rem;opacity:0.7;">â¤¢</span>
    </div>
    <div class="mode-tog">
      <button class="mbtn active" id="btnDev" onclick="setMode('dev')">âŸ¨/âŸ© Developer</button>
      <button class="mbtn" id="btnBiz" onclick="setMode('biz')">ğŸ“Š Business</button>
    </div>
  </div>
</div>

<!-- ARCHITECTURE OVERLAY -->
<div class="arch-overlay" id="archOverlay" onclick="closeArchOutside(event)">
  <div class="arch-panel">
    <div class="arch-panel-top">
      <div style="font-size:1.4rem;">ğŸ›ï¸</div>
      <div>
        <div class="arch-panel-title">System Architecture Overview</div>
        <div class="arch-panel-sub">OCR Accuracy Pipeline Â· 4 systems Â· 5 phases Â· 25 BQ columns Â· 7 status values</div>
      </div>
      <div class="arch-close" onclick="closeArch()">âœ•</div>
    </div>
    <div class="arch-body">
      <div class="arch-grid">
        <div class="arch-node an-k">
          <div class="arch-node-icon">ğŸ“¡</div>
          <div class="arch-node-name">Apache Kafka</div>
          <div class="arch-node-tech">confluent_kafka Â· consumer</div>
          <div class="arch-node-detail">
            <div>Topic: invoice scan events</div><div>poll timeout: 50ms</div>
            <div>fetch.min.bytes: 64KB</div><div>max.partition: 4MB</div>
            <div>queued.min: 200k msgs</div><div>Window: T-1 full day</div>
          </div>
        </div>
        <div class="arch-node an-m">
          <div class="arch-node-icon">ğŸ—„ï¸</div>
          <div class="arch-node-name">MongoDB</div>
          <div class="arch-node-tech">motor / asyncio.to_thread</div>
          <div class="arch-node-detail">
            <div>Pool: 20â€“100 connections</div><div>Index: po_id_idx</div>
            <div>Query: $in (batch 100)</div><div>Project: req/res bodies</div>
            <div>LRU cache: 5000 entries</div><div>Cache None = no re-query</div>
          </div>
        </div>
        <div class="arch-node an-s">
          <div class="arch-node-icon">ğŸ—ƒï¸</div>
          <div class="arch-node-name">MySQL</div>
          <div class="arch-node-tech">PyMySQL Â· connection pool</div>
          <div class="arch-node-detail">
            <div>Pool size: 3 connections</div><div>Table: Dim_Sys_Plant</div>
            <div>Only NOT_FOUND rows</div><div>Deduped GSTINs â†’ 1 query</div>
            <div>Vertical filter applied</div><div>Company_ID â‰  1 filter</div>
          </div>
        </div>
        <div class="arch-node an-b">
          <div class="arch-node-icon">â˜ï¸</div>
          <div class="arch-node-name">Google BigQuery</div>
          <div class="arch-node-tech">google-cloud-bigquery</div>
          <div class="arch-node-detail">
            <div>Table: ocr_accuracy_results</div><div>25-column schema</div>
            <div>DAY partition on proc_ts</div><div>Streaming insert (async)</div>
            <div>Batch size: 500 rows</div><div>Auto-created if missing</div>
          </div>
        </div>
      </div>
      <div class="arch-divider">âš¡ Key Optimisations</div>
      <div class="arch-opts">
        <div class="arch-opt">
          <div class="arch-opt-badge" style="color:var(--c-g);border-color:rgba(52,211,153,0.3);background:rgba(52,211,153,0.08);">âš¡ Nâ†’1 Mongo Queries</div>
          <div class="arch-opt-title">Batch $in instead of N find_one</div>
          <div class="arch-opt-body">Collect 100 msgs â†’ one find({$in:[...]}) = 1 round-trip. Up to 100Ã— fewer DB calls.</div>
        </div>
        <div class="arch-opt">
          <div class="arch-opt-badge" style="color:var(--c-b);border-color:rgba(56,189,248,0.3);background:rgba(56,189,248,0.08);">âš¡ O(1) LRU Cache</div>
          <div class="arch-opt-title">OrderedDict replaces list-scan</div>
          <div class="arch-opt-body">move_to_end() and popitem(last=False) â€” both O(1). Caches None to prevent re-querying missing po_ids.</div>
        </div>
        <div class="arch-opt">
          <div class="arch-opt-badge" style="color:var(--c-a);border-color:rgba(251,191,36,0.3);background:rgba(251,191,36,0.08);">âš¡ MySQL Skip Logic</div>
          <div class="arch-opt-title">Legit rows never touch MySQL</div>
          <div class="arch-opt-body">Only PO_ID_NOT_FOUND rows query MySQL. GSTINs deduplicated â€” always 1 query per batch regardless of count.</div>
        </div>
        <div class="arch-opt">
          <div class="arch-opt-badge" style="color:var(--c-c);border-color:rgba(34,211,238,0.3);background:rgba(34,211,238,0.08);">âš¡ Rolling BQ Writes</div>
          <div class="arch-opt-title">Writes throughout, not at end</div>
          <div class="arch-opt-body">Every 500 rows â†’ classify + write to BQ â†’ clear buffer. RAM always bounded regardless of daily volume.</div>
        </div>
        <div class="arch-opt">
          <div class="arch-opt-badge" style="color:var(--c-p);border-color:rgba(167,139,250,0.3);background:rgba(167,139,250,0.08);">âš¡ Idempotent Resume</div>
          <div class="arch-opt-title">MAX(kafka_timestamp) offset</div>
          <div class="arch-opt-body">Safe to restart mid-run. start_from_ms = MAX(ts)+1ms. Never re-inserts already-written rows.</div>
        </div>
        <div class="arch-opt">
          <div class="arch-opt-badge" style="color:var(--c-r);border-color:rgba(251,113,133,0.3);background:rgba(251,113,133,0.08);">âš¡ Sync Post-Batch</div>
          <div class="arch-opt-title">No await inside row builder</div>
          <div class="arch-opt-body">build_bq_row() and determine_status() are synchronous â€” eliminates per-row thread dispatch overhead at high throughput.</div>
        </div>
      </div>
      <div class="arch-divider">ğŸ“‹ 7 Match Status Values</div>
      <div class="arch-statuses">
        <div class="arch-status" style="border-color:rgba(52,211,153,0.3);background:rgba(52,211,153,0.05);">
          <div class="arch-status-name" style="color:var(--c-g);">âœ… MATCHED</div>
          <div class="arch-status-desc">OCR doc found. Date + total present. time_diff within threshold.</div>
        </div>
        <div class="arch-status" style="border-color:rgba(251,113,133,0.3);background:rgba(251,113,133,0.05);">
          <div class="arch-status-name" style="color:var(--c-r);">âŒ PO_ID_NOT_FOUND</div>
          <div class="arch-status-desc">po_id in Kafka but no matching MongoDB doc. Triggers MySQL classification.</div>
        </div>
        <div class="arch-status" style="border-color:rgba(251,113,133,0.3);background:rgba(251,113,133,0.05);">
          <div class="arch-status-name" style="color:var(--c-r);">âš ï¸ PO_ID_MISSING_KAFKA</div>
          <div class="arch-status-desc">Kafka message had no po_id field at all. Skips Mongo â†’ empty row stored.</div>
        </div>
        <div class="arch-status" style="border-color:rgba(251,191,36,0.3);background:rgba(251,191,36,0.05);">
          <div class="arch-status-name" style="color:var(--c-a);">âš ï¸ MONGO_ALL_EMPTY</div>
          <div class="arch-status-desc">Doc found but all critical fields (date, total, GSTIN) are blank strings.</div>
        </div>
        <div class="arch-status" style="border-color:rgba(251,191,36,0.3);background:rgba(251,191,36,0.05);">
          <div class="arch-status-name" style="color:var(--c-a);">âš ï¸ INVOICE_DATE_MISSING</div>
          <div class="arch-status-desc">OCR doc found but ocr_invoice_date is empty â€” OCR failed to extract date.</div>
        </div>
        <div class="arch-status" style="border-color:rgba(251,191,36,0.3);background:rgba(251,191,36,0.05);">
          <div class="arch-status-name" style="color:var(--c-a);">âš ï¸ INVOICE_TOTAL_MISSING</div>
          <div class="arch-status-desc">OCR doc found but ocr_invoice_total is empty â€” OCR missed the amount.</div>
        </div>
        <div class="arch-status" style="border-color:rgba(167,139,250,0.3);background:rgba(167,139,250,0.05);">
          <div class="arch-status-name" style="color:var(--c-p);">â±ï¸ TIME_BUFFER_EXCEEDED</div>
          <div class="arch-status-desc">time_diff_seconds exceeds configured threshold. SLA breach detected.</div>
        </div>
        <div class="arch-status" style="border-color:rgba(56,189,248,0.3);background:rgba(56,189,248,0.05);">
          <div class="arch-status-name" style="color:var(--c-b);">ğŸ·ï¸ vendor_type values</div>
          <div class="arch-status-desc"><b style="color:var(--c-g);">Legit</b>: OCR worked. <b style="color:var(--c-a);">Manual</b>: External. <b style="color:var(--c-r);">Moglix</b>: Gap to fix.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DEVELOPER VIEW â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="view active" id="viewDev">
<div style="display:flex;flex-direction:column;align-items:center;padding:24px 16px 16px;gap:20px;">

  <!-- BQ SCHEMA BLOCK â€” UNTOUCHED -->
  <div class="arch-block" style="margin-bottom:10px;">
    <div class="arch-block-top">
      <div class="arch-block-icon">ğŸ›ï¸</div>
      <div>
        <div class="arch-block-title">ocr_accuracy_results Â· BigQuery Schema</div>
        <div class="arch-block-sub">project.dataset.ocr_accuracy_results Â· DAY partition on processing_timestamp Â· 25 columns from 4 sources</div>
      </div>
      <div class="arch-pills">
        <div class="arch-pill" style="color:#34d399;border-color:rgba(52,211,153,0.3);background:rgba(52,211,153,0.07);">ğŸ“¡ Kafka: 7</div>
        <div class="arch-pill" style="color:#6ee7b7;border-color:rgba(110,231,183,0.3);background:rgba(110,231,183,0.07);">ğŸ—„ï¸ Mongo: 10</div>
        <div class="arch-pill" style="color:#fbbf24;border-color:rgba(251,191,36,0.3);background:rgba(251,191,36,0.07);">ğŸ—ƒï¸ MySQL: 1</div>
        <div class="arch-pill" style="color:#a78bfa;border-color:rgba(167,139,250,0.3);background:rgba(167,139,250,0.07);">âš™ï¸ Pipeline: 7</div>
      </div>
    </div>
    <div class="colflow">
      <div class="cf-sources" id="cf-sources">
        <div class="cf-src cf-src-k" id="cf-src-k"><div class="cf-src-icon">ğŸ“¡</div><div class="cf-src-name">Kafka</div><div class="cf-src-cols" style="color:#34d399;">7 cols Â· msg payload</div></div>
        <div class="cf-src cf-src-m" id="cf-src-m"><div class="cf-src-icon">ğŸ—„ï¸</div><div class="cf-src-name">MongoDB</div><div class="cf-src-cols" style="color:#6ee7b7;">10 cols Â· req + resp</div></div>
        <div class="cf-src cf-src-s" id="cf-src-s"><div class="cf-src-icon">ğŸ—ƒï¸</div><div class="cf-src-name">MySQL</div><div class="cf-src-cols" style="color:#fbbf24;">1 col Â· Dim_Sys_Plant</div></div>
        <div class="cf-src cf-src-p" id="cf-src-p"><div class="cf-src-icon">âš™ï¸</div><div class="cf-src-name">Pipeline</div><div class="cf-src-cols" style="color:#a78bfa;">7 cols Â· computed</div></div>
      </div>
      <div class="cf-wires" id="cf-wires">
        <svg id="cf-svg" width="100%" height="100%"></svg>
      </div>
      <div class="cf-cols" id="cf-cols">
        <div class="cf-col" id="cf-col-0"><div class="cf-col-dot" id="cf-dot-0" style="background:#34d399;box-shadow:0 0 5px #34d39966;"></div><div class="cf-col-name" style="color:#34d399;">kafka_timestamp</div><div class="cf-col-type ct-int">INT</div><div class="cf-col-val" id="cf-val-0">1729123456789</div><div class="cf-col-src" style="color:#34d399;border-color:#34d39944;background:#34d39911;">Kafka</div></div>
        <div class="cf-col" id="cf-col-1"><div class="cf-col-dot" id="cf-dot-1" style="background:#34d399;box-shadow:0 0 5px #34d39966;"></div><div class="cf-col-name" style="color:#34d399;">po_id</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-1">PO-2024-88421</div><div class="cf-col-src" style="color:#34d399;border-color:#34d39944;background:#34d39911;">Kafka</div></div>
        <div class="cf-col" id="cf-col-2"><div class="cf-col-dot" id="cf-dot-2" style="background:#34d399;box-shadow:0 0 5px #34d39966;"></div><div class="cf-col-name" style="color:#34d399;">kafka_final_gstin</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-2">27AABCM1596J1ZQ</div><div class="cf-col-src" style="color:#34d399;border-color:#34d39944;background:#34d39911;">Kafka</div></div>
        <div class="cf-col" id="cf-col-3"><div class="cf-col-dot" id="cf-dot-3" style="background:#34d399;box-shadow:0 0 5px #34d39966;"></div><div class="cf-col-name" style="color:#34d399;">invoice_number_kafka</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-3">INV/2024/10091</div><div class="cf-col-src" style="color:#34d399;border-color:#34d39944;background:#34d39911;">Kafka</div></div>
        <div class="cf-col" id="cf-col-4"><div class="cf-col-dot" id="cf-dot-4" style="background:#34d399;box-shadow:0 0 5px #34d39966;"></div><div class="cf-col-name" style="color:#34d399;">invoice_amount_kafka</div><div class="cf-col-type ct-fl">FLT</div><div class="cf-col-val" id="cf-val-4">14250.00</div><div class="cf-col-src" style="color:#34d399;border-color:#34d39944;background:#34d39911;">Kafka</div></div>
        <div class="cf-col" id="cf-col-5"><div class="cf-col-dot" id="cf-dot-5" style="background:#34d399;box-shadow:0 0 5px #34d39966;"></div><div class="cf-col-name" style="color:#34d399;">invoice_date_kafka</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-5">2024-10-15</div><div class="cf-col-src" style="color:#34d399;border-color:#34d39944;background:#34d39911;">Kafka</div></div>
        <div class="cf-col" id="cf-col-6"><div class="cf-col-dot" id="cf-dot-6" style="background:#34d399;box-shadow:0 0 5px #34d39966;"></div><div class="cf-col-name" style="color:#34d399;">file_url</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-6">https://cdn.moglix.com/â€¦</div><div class="cf-col-src" style="color:#34d399;border-color:#34d39944;background:#34d39911;">Kafka</div></div>
        <div class="cf-col" id="cf-col-7"><div class="cf-col-dot" id="cf-dot-7" style="background:#6ee7b7;box-shadow:0 0 5px #6ee7b766;"></div><div class="cf-col-name" style="color:#6ee7b7;">ocr_invoice_date</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-7">2024-10-15</div><div class="cf-col-src" style="color:#6ee7b7;border-color:#6ee7b744;background:#6ee7b711;">MongoDB</div></div>
        <div class="cf-col" id="cf-col-8"><div class="cf-col-dot" id="cf-dot-8" style="background:#6ee7b7;box-shadow:0 0 5px #6ee7b766;"></div><div class="cf-col-name" style="color:#6ee7b7;">ocr_invoice_total</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-8">14250.00</div><div class="cf-col-src" style="color:#6ee7b7;border-color:#6ee7b744;background:#6ee7b711;">MongoDB</div></div>
        <div class="cf-col" id="cf-col-9"><div class="cf-col-dot" id="cf-dot-9" style="background:#6ee7b7;box-shadow:0 0 5px #6ee7b766;"></div><div class="cf-col-name" style="color:#6ee7b7;">ocr_gstin</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-9">27AABCM1596J1ZQ</div><div class="cf-col-src" style="color:#6ee7b7;border-color:#6ee7b744;background:#6ee7b711;">MongoDB</div></div>
        <div class="cf-col" id="cf-col-10"><div class="cf-col-dot" id="cf-dot-10" style="background:#6ee7b7;box-shadow:0 0 5px #6ee7b766;"></div><div class="cf-col-name" style="color:#6ee7b7;">ocr_qr_detected</div><div class="cf-col-type ct-bl">BOOL</div><div class="cf-col-val" id="cf-val-10">true</div><div class="cf-col-src" style="color:#6ee7b7;border-color:#6ee7b744;background:#6ee7b711;">MongoDB</div></div>
        <div class="cf-col" id="cf-col-11"><div class="cf-col-dot" id="cf-dot-11" style="background:#6ee7b7;box-shadow:0 0 5px #6ee7b766;"></div><div class="cf-col-name" style="color:#6ee7b7;">mongo_created_at</div><div class="cf-col-type ct-ts">TS</div><div class="cf-col-val" id="cf-val-11">2024-10-15 09:32:41</div><div class="cf-col-src" style="color:#6ee7b7;border-color:#6ee7b744;background:#6ee7b711;">MongoDB</div></div>
        <div class="cf-col" id="cf-col-12"><div class="cf-col-dot" id="cf-dot-12" style="background:#6ee7b7;box-shadow:0 0 5px #6ee7b766;"></div><div class="cf-col-name" style="color:#6ee7b7;">mongo_doc_id</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-12">670e4f2a3b8c1d00e9f44a12</div><div class="cf-col-src" style="color:#6ee7b7;border-color:#6ee7b744;background:#6ee7b711;">MongoDB</div></div>
        <div class="cf-col" id="cf-col-13"><div class="cf-col-dot" id="cf-dot-13" style="background:#6ee7b7;box-shadow:0 0 5px #6ee7b766;"></div><div class="cf-col-name" style="color:#6ee7b7;">request_gstin</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-13">27AABCM1596J1ZQ</div><div class="cf-col-src" style="color:#6ee7b7;border-color:#6ee7b744;background:#6ee7b711;">MongoDB</div></div>
        <div class="cf-col" id="cf-col-14"><div class="cf-col-dot" id="cf-dot-14" style="background:#6ee7b7;box-shadow:0 0 5px #6ee7b766;"></div><div class="cf-col-name" style="color:#6ee7b7;">request_invoice_no</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-14">INV/2024/10091</div><div class="cf-col-src" style="color:#6ee7b7;border-color:#6ee7b744;background:#6ee7b711;">MongoDB</div></div>
        <div class="cf-col" id="cf-col-15"><div class="cf-col-dot" id="cf-dot-15" style="background:#6ee7b7;box-shadow:0 0 5px #6ee7b766;"></div><div class="cf-col-name" style="color:#6ee7b7;">request_invoice_date</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-15">2024-10-15</div><div class="cf-col-src" style="color:#6ee7b7;border-color:#6ee7b744;background:#6ee7b711;">MongoDB</div></div>
        <div class="cf-col" id="cf-col-16"><div class="cf-col-dot" id="cf-dot-16" style="background:#6ee7b7;box-shadow:0 0 5px #6ee7b766;"></div><div class="cf-col-name" style="color:#6ee7b7;">request_total</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-16">14250.00</div><div class="cf-col-src" style="color:#6ee7b7;border-color:#6ee7b744;background:#6ee7b711;">MongoDB</div></div>
        <div class="cf-col" id="cf-col-17"><div class="cf-col-dot" id="cf-dot-17" style="background:#fbbf24;box-shadow:0 0 5px #fbbf2466;"></div><div class="cf-col-name" style="color:#fbbf24;">vendor_type</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-17">Legit</div><div class="cf-col-src" style="color:#fbbf24;border-color:#fbbf2444;background:#fbbf2411;">MySQL</div></div>
        <div class="cf-col" id="cf-col-18"><div class="cf-col-dot" id="cf-dot-18" style="background:#a78bfa;box-shadow:0 0 5px #a78bfa66;"></div><div class="cf-col-name" style="color:#a78bfa;">status</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-18">MATCHED</div><div class="cf-col-src" style="color:#a78bfa;border-color:#a78bfa44;background:#a78bfa11;">Pipeline</div></div>
        <div class="cf-col" id="cf-col-19"><div class="cf-col-dot" id="cf-dot-19" style="background:#a78bfa;box-shadow:0 0 5px #a78bfa66;"></div><div class="cf-col-name" style="color:#a78bfa;">time_diff_seconds</div><div class="cf-col-type ct-fl">FLT</div><div class="cf-col-val" id="cf-val-19">3.21</div><div class="cf-col-src" style="color:#a78bfa;border-color:#a78bfa44;background:#a78bfa11;">Pipeline</div></div>
        <div class="cf-col" id="cf-col-20"><div class="cf-col-dot" id="cf-dot-20" style="background:#a78bfa;box-shadow:0 0 5px #a78bfa66;"></div><div class="cf-col-name" style="color:#a78bfa;">processing_timestamp</div><div class="cf-col-type ct-ts">TS</div><span class="cf-part">âš‘ PARTITION</span><div class="cf-col-val" id="cf-val-20">2024-10-16 06:14:22</div><div class="cf-col-src" style="color:#a78bfa;border-color:#a78bfa44;background:#a78bfa11;">Pipeline</div></div>
        <div class="cf-col" id="cf-col-21"><div class="cf-col-dot" id="cf-dot-21" style="background:#a78bfa;box-shadow:0 0 5px #a78bfa66;"></div><div class="cf-col-name" style="color:#a78bfa;">pipeline_run_date</div><div class="cf-col-type ct-str">STR</div><div class="cf-col-val" id="cf-val-21">2024-10-15</div><div class="cf-col-src" style="color:#a78bfa;border-color:#a78bfa44;background:#a78bfa11;">Pipeline</div></div>
        <div class="cf-col" id="cf-col-22"><div class="cf-col-dot" id="cf-dot-22" style="background:#a78bfa;box-shadow:0 0 5px #a78bfa66;"></div><div class="cf-col-name" style="color:#a78bfa;">batch_id</div><div class="cf-col-type ct-int">INT</div><div class="cf-col-val" id="cf-val-22">42</div><div class="cf-col-src" style="color:#a78bfa;border-color:#a78bfa44;background:#a78bfa11;">Pipeline</div></div>
        <div class="cf-col" id="cf-col-23"><div class="cf-col-dot" id="cf-dot-23" style="background:#a78bfa;box-shadow:0 0 5px #a78bfa66;"></div><div class="cf-col-name" style="color:#a78bfa;">start_from_ms</div><div class="cf-col-type ct-int">INT</div><div class="cf-col-val" id="cf-val-23">1729036800000</div><div class="cf-col-src" style="color:#a78bfa;border-color:#a78bfa44;background:#a78bfa11;">Pipeline</div></div>
        <div class="cf-col" id="cf-col-24"><div class="cf-col-dot" id="cf-dot-24" style="background:#a78bfa;box-shadow:0 0 5px #a78bfa66;"></div><div class="cf-col-name" style="color:#a78bfa;">t1_end_ms</div><div class="cf-col-type ct-int">INT</div><div class="cf-col-val" id="cf-val-24">1729123199999</div><div class="cf-col-src" style="color:#a78bfa;border-color:#a78bfa44;background:#a78bfa11;">Pipeline</div></div>
      </div>
    </div>
    <!-- LIVE CSV TABLE -->
    <div class="csv-section">
      <div class="csv-hdr">
        <div class="live-dot"></div>
        <div class="csv-lbl">Live Streaming Rows</div>
        <div class="csv-sub">Â· insert_rows_json() Â· batch_size=500 Â· rolling mid-pipeline writes</div>
      </div>
      <div class="csv-scroll">
        <table class="csv-table">
          <thead><tr>
            <th style="color:#888;">#</th>
            <th style="color:#34d399;">kafka_timestamp</th>
            <th style="color:#34d399;">po_id</th>
            <th style="color:#34d399;">kafka_final_gstin</th>
            <th style="color:#34d399;">invoice_amount_kafka</th>
            <th style="color:#34d399;">invoice_date_kafka</th>
            <th style="color:#6ee7b7;">ocr_invoice_date</th>
            <th style="color:#6ee7b7;">ocr_invoice_total</th>
            <th style="color:#6ee7b7;">ocr_qr_detected</th>
            <th style="color:#fbbf24;">vendor_type</th>
            <th style="color:#a78bfa;">status</th>
            <th style="color:#a78bfa;">time_diff_seconds</th>
            <th style="color:#fda4af;">processing_timestamp âš‘</th>
          </tr></thead>
          <tbody id="dev-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- â•â• FLOWCHART â€” SVG CANVAS â•â• -->
  <div style="width:100%;border-top:1px solid rgba(167,139,250,0.12);padding-top:40px;margin-top:16px;">
    <div style="text-align:center;margin-bottom:28px;">
      <span style="font-family:var(--sans);font-size:0.85rem;font-weight:800;letter-spacing:0.18em;text-transform:uppercase;color:var(--c-p);background:rgba(167,139,250,0.06);border:1px solid rgba(167,139,250,0.18);padding:8px 28px;border-radius:8px;box-shadow:0 0 20px rgba(167,139,250,0.08);">
        âœ¦ &nbsp; PIPELINE EXECUTION FLOW &nbsp; âœ¦
      </span>
    </div>
    <div id="fc-svg-container">
      <svg id="pipeline-svg" viewBox="0 0 1400 2800" width="1400" style="max-width:100%;"></svg>
    </div>
  </div>

</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BUSINESS VIEW â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="view" id="viewBiz">
<div style="display:flex;flex-direction:column;align-items:center;padding:24px 16px 60px;gap:0;">

  <div class="biz-hero">
    <div class="biz-h">Invoice OCR Accuracy Pipeline</div>
    <div class="biz-sub">Automated daily run Â· Processes yesterday's invoice scan events Â· Results in BigQuery by morning</div>
  </div>
  <div class="pill-row">
    <div class="pill" style="border-color:rgba(52,211,153,0.3);color:var(--c-g);background:rgba(52,211,153,0.05);">âœ… Fully Automated</div>
    <div class="pill" style="border-color:rgba(34,211,238,0.3);color:var(--c-c);background:rgba(34,211,238,0.05);">ğŸ“… Daily Â· T-1 Window</div>
    <div class="pill" style="border-color:rgba(167,139,250,0.3);color:var(--c-p);background:rgba(167,139,250,0.05);">ğŸ”„ Idempotent Resume</div>
    <div class="pill" style="border-color:rgba(251,191,36,0.3);color:var(--c-a);background:rgba(251,191,36,0.05);">âš¡ High Throughput</div>
    <div class="pill" style="border-color:rgba(251,113,133,0.3);color:var(--c-r);background:rgba(251,113,133,0.05);">ğŸ›¡ï¸ Fault Tolerant</div>
  </div>

  <div style="font-family:var(--mono);font-size:0.6rem;font-weight:800;letter-spacing:0.2em;text-transform:uppercase;color:#3a4060;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.05);padding:5px 20px;border-radius:4px;margin-bottom:20px;text-align:center;">
    ğŸŒ… &nbsp;Pipeline Starts Every Morning Â· Fully Automated
  </div>

  <div class="biz-phase" style="border-color:rgba(167,139,250,0.28);max-width:860px;">
    <div class="biz-phase-bar" style="background:linear-gradient(90deg,var(--c-p),transparent);"></div>
    <div class="biz-phase-hdr"><div class="biz-phase-icon">âš™ï¸</div><div><div class="biz-phase-title" style="color:var(--c-p);">System Startup</div><div class="biz-phase-sub">Phase 0 Â· Initialisation Â· ~5 seconds</div></div><div class="biz-phase-badge" style="color:var(--c-p);border-color:rgba(167,139,250,0.3);background:rgba(167,139,250,0.08);">Automated</div></div>
    <div class="biz-cards">
      <div class="biz-card"><div class="biz-card-icon">ğŸ“…</div><div class="biz-card-title" style="color:var(--c-p);">Sets the Processing Window</div><div class="biz-card-text">Automatically targets yesterday's data (00:00â€“23:59 IST). Remembers exactly where the last run stopped â€” nothing is ever processed twice, even after a crash or restart.</div></div>
      <div class="biz-card"><div class="biz-card-icon">ğŸ”Œ</div><div class="biz-card-title" style="color:var(--c-p);">Opens All 4 Connections</div><div class="biz-card-text">Connects simultaneously to Kafka (event stream), MongoDB (OCR results), MySQL (vendor master), and BigQuery (reporting warehouse) using optimised connection pools.</div></div>
      <div class="biz-card"><div class="biz-card-icon">ğŸ“‹</div><div class="biz-card-title" style="color:var(--c-p);">Prepares the Report Table</div><div class="biz-card-text">Verifies the BigQuery 25-column table exists. Creates it automatically if missing â€” zero manual setup required, even on first ever run.</div></div>
    </div>
    <div class="biz-mini-row">
      <div class="biz-mini"><div class="biz-mini-v" style="color:var(--c-p);">4</div><div class="biz-mini-l">systems connected</div></div>
      <div class="biz-mini"><div class="biz-mini-v" style="color:var(--c-p);">25</div><div class="biz-mini-l">BQ columns</div></div>
      <div class="biz-mini"><div class="biz-mini-v" style="color:var(--c-p);">0</div><div class="biz-mini-l">duplicate rows ever</div></div>
      <div class="biz-mini"><div class="biz-mini-v" style="color:var(--c-p);">~5s</div><div class="biz-mini-l">startup time</div></div>
    </div>
  </div>
  <div style="width:3px;height:30px;background:linear-gradient(180deg,rgba(167,139,250,0.8),rgba(52,211,153,0.8));margin:0 auto;"></div>

  <div class="biz-phase" style="border-color:rgba(52,211,153,0.28);max-width:860px;">
    <div class="biz-phase-bar" style="background:linear-gradient(90deg,var(--c-g),transparent);"></div>
    <div class="biz-phase-hdr"><div class="biz-phase-icon">ğŸ“¨</div><div><div class="biz-phase-title" style="color:var(--c-g);">Read Invoice Scan Events</div><div class="biz-phase-sub">Phase 1 Â· Kafka Consumer Â· Streaming Â· Batched in groups of 100</div></div><div class="biz-phase-badge" style="color:var(--c-g);border-color:rgba(52,211,153,0.3);background:rgba(52,211,153,0.08);">High Throughput</div></div>
    <div class="biz-cards">
      <div class="biz-card"><div class="biz-card-icon">ğŸ“¥</div><div class="biz-card-title" style="color:var(--c-g);">What Comes In</div><div class="biz-card-text">Each event represents a completed invoice scan â€” contains PO ID, vendor GSTIN, invoice number, expected amount, expected date, and the file URL of the scanned image.</div></div>
      <div class="biz-card"><div class="biz-card-icon">ğŸ”</div><div class="biz-card-title" style="color:var(--c-g);">Smart Filtering</div><div class="biz-card-text">Automatically skips events already processed in prior runs. Only reads events within yesterday's window. Stops precisely at midnight â€” no cross-day data bleed ever occurs.</div></div>
      <div class="biz-card"><div class="biz-card-icon">âš¡</div><div class="biz-card-title" style="color:var(--c-g);">Batched â€” Not One-by-One</div><div class="biz-card-text">Events collected in groups of 100 before any DB lookup. This reduces MongoDB queries by up to 100Ã— versus the original design, dramatically speeding up the daily run.</div></div>
    </div>
    <div class="biz-outcomes">
      <div class="biz-outcome" style="border-color:rgba(52,211,153,0.3);background:rgba(52,211,153,0.04);"><div class="biz-outcome-val" style="color:var(--c-g);">âœ… Valid</div><div class="biz-outcome-lbl">Has PO ID Â· In time window</div></div>
      <div class="biz-outcome" style="border-color:rgba(251,113,133,0.3);background:rgba(251,113,133,0.04);"><div class="biz-outcome-val" style="color:var(--c-r);">âš ï¸ No PO ID</div><div class="biz-outcome-lbl">Recorded as MISSING, skipped</div></div>
      <div class="biz-outcome" style="border-color:rgba(148,163,184,0.3);background:rgba(148,163,184,0.04);"><div class="biz-outcome-val" style="color:#94a3b8;">â­ï¸ Already Done</div><div class="biz-outcome-lbl">Silently skipped</div></div>
    </div>
  </div>
  <div style="width:3px;height:30px;background:linear-gradient(180deg,rgba(52,211,153,0.8),rgba(110,231,183,0.8));margin:0 auto;"></div>

  <div class="biz-phase" style="border-color:rgba(110,231,183,0.28);max-width:860px;">
    <div class="biz-phase-bar" style="background:linear-gradient(90deg,var(--c-e),transparent);"></div>
    <div class="biz-phase-hdr"><div class="biz-phase-icon">ğŸ”</div><div><div class="biz-phase-title" style="color:var(--c-e);">Look Up OCR Scan Results</div><div class="biz-phase-sub">Phase 1b Â· MongoDB + Smart In-Memory Cache Â· 1 DB query per 100 events</div></div><div class="biz-phase-badge" style="color:var(--c-e);border-color:rgba(110,231,183,0.3);background:rgba(110,231,183,0.08);">Intelligent Caching</div></div>
    <div class="biz-cards">
      <div class="biz-card"><div class="biz-card-icon">ğŸ—„ï¸</div><div class="biz-card-title" style="color:var(--c-e);">What We Match</div><div class="biz-card-text">For each scan event, we find the matching OCR result in MongoDB â€” contains what the OCR engine extracted from the invoice image: date, total amount, GSTIN, and QR code status.</div></div>
      <div class="biz-card"><div class="biz-card-icon">âš¡</div><div class="biz-card-title" style="color:var(--c-e);">In-Memory Smart Cache</div><div class="biz-card-text">Recent lookups cached in memory (5,000 entries). Same PO ID appearing again = zero database queries. O(1) eviction â€” always fast, never stale, never wastes memory.</div></div>
      <div class="biz-card"><div class="biz-card-icon">ğŸ“Š</div><div class="biz-card-title" style="color:var(--c-e);">Quality Assessment</div><div class="biz-card-text">Each matched result assessed: Was the invoice date extracted? Was the total captured? Was the scan within the SLA time? Determines one of 7 match quality statuses for reporting.</div></div>
    </div>
    <div class="biz-outcomes">
      <div class="biz-outcome" style="border-color:rgba(52,211,153,0.3);background:rgba(52,211,153,0.04);"><div class="biz-outcome-val" style="color:var(--c-g);">âœ… MATCHED</div><div class="biz-outcome-lbl">OCR found and complete</div></div>
      <div class="biz-outcome" style="border-color:rgba(251,113,133,0.3);background:rgba(251,113,133,0.04);"><div class="biz-outcome-val" style="color:var(--c-r);">âŒ NOT FOUND</div><div class="biz-outcome-lbl">No OCR result in database</div></div>
      <div class="biz-outcome" style="border-color:rgba(251,191,36,0.3);background:rgba(251,191,36,0.04);"><div class="biz-outcome-val" style="color:var(--c-a);">âš ï¸ INCOMPLETE</div><div class="biz-outcome-lbl">Missing date / total / slow</div></div>
    </div>
    <div class="biz-mini-row">
      <div class="biz-mini"><div class="biz-mini-v" style="color:var(--c-e);">5,000</div><div class="biz-mini-l">LRU cache entries</div></div>
      <div class="biz-mini"><div class="biz-mini-v" style="color:var(--c-e);">O(1)</div><div class="biz-mini-l">eviction complexity</div></div>
      <div class="biz-mini"><div class="biz-mini-v" style="color:var(--c-e);">1</div><div class="biz-mini-l">Mongo query / batch</div></div>
      <div class="biz-mini"><div class="biz-mini-v" style="color:var(--c-e);">7</div><div class="biz-mini-l">match status types</div></div>
    </div>
  </div>
  <div style="width:3px;height:30px;background:linear-gradient(180deg,rgba(110,231,183,0.8),rgba(251,191,36,0.8));margin:0 auto;"></div>

  <div class="biz-phase" style="border-color:rgba(251,191,36,0.28);max-width:860px;">
    <div class="biz-phase-bar" style="background:linear-gradient(90deg,var(--c-a),transparent);"></div>
    <div class="biz-phase-hdr"><div class="biz-phase-icon">ğŸ·ï¸</div><div><div class="biz-phase-title" style="color:var(--c-a);">Classify Vendor Type</div><div class="biz-phase-sub">Phase 2 Â· Business Intelligence Â· MySQL Dim_Sys_Plant Â· Only NOT FOUND rows</div></div><div class="biz-phase-badge" style="color:var(--c-a);border-color:rgba(251,191,36,0.3);background:rgba(251,191,36,0.08);">Zero-cost for most rows</div></div>
    <div class="biz-cards">
      <div class="biz-card"><div class="biz-card-icon">ğŸ¤”</div><div class="biz-card-title" style="color:var(--c-a);">Why Classify?</div><div class="biz-card-text">When OCR result is missing, we need to understand why. Is this a Moglix vendor â€” an OCR gap to investigate? Or a Manual/external vendor where no OCR result is expected at all?</div></div>
      <div class="biz-card"><div class="biz-card-icon">ğŸ”</div><div class="biz-card-title" style="color:var(--c-a);">How It Works</div><div class="biz-card-text">Vendor's GSTIN cross-checked against Dim_Sys_Plant vendor master with business filters (vertical, company ID). Match â†’ Manual vendor (expected gap). No match â†’ Moglix vendor (OCR gap to fix).</div></div>
      <div class="biz-card"><div class="biz-card-icon">âš¡</div><div class="biz-card-title" style="color:var(--c-a);">Zero-Cost for Most Rows</div><div class="biz-card-text">Only NOT FOUND invoices trigger a MySQL query. All matched and incomplete rows tagged "Legit" instantly at zero DB cost. GSTINs are deduplicated â€” always 1 query per batch.</div></div>
    </div>
    <div class="biz-outcomes">
      <div class="biz-outcome" style="border-color:rgba(52,211,153,0.3);background:rgba(52,211,153,0.04);"><div class="biz-outcome-val" style="color:var(--c-g);">âœ… Legit</div><div class="biz-outcome-lbl">OCR found â€” working as expected</div></div>
      <div class="biz-outcome" style="border-color:rgba(251,191,36,0.3);background:rgba(251,191,36,0.04);"><div class="biz-outcome-val" style="color:var(--c-a);">ğŸ“‹ Manual</div><div class="biz-outcome-lbl">External vendor â€” expected gap</div></div>
      <div class="biz-outcome" style="border-color:rgba(167,139,250,0.3);background:rgba(167,139,250,0.04);"><div class="biz-outcome-val" style="color:var(--c-p);">ğŸ”´ Moglix</div><div class="biz-outcome-lbl">OCR gap â€” investigate</div></div>
    </div>
  </div>
  <div style="width:3px;height:30px;background:linear-gradient(180deg,rgba(251,191,36,0.8),rgba(34,211,238,0.8));margin:0 auto;"></div>

  <div class="biz-phase" style="border-color:rgba(34,211,238,0.28);max-width:860px;">
    <div class="biz-phase-bar" style="background:linear-gradient(90deg,var(--c-c),transparent);"></div>
    <div class="biz-phase-hdr"><div class="biz-phase-icon">ğŸ“¤</div><div><div class="biz-phase-title" style="color:var(--c-c);">Store in Reporting Warehouse</div><div class="biz-phase-sub">Phase 3 Â· BigQuery Streaming Insert Â· DAY Partitioned Â· Rolling writes throughout run</div></div><div class="biz-phase-badge" style="color:var(--c-c);border-color:rgba(34,211,238,0.3);background:rgba(34,211,238,0.08);">Memory Efficient</div></div>
    <div class="biz-cards">
      <div class="biz-card"><div class="biz-card-icon">ğŸ“Š</div><div class="biz-card-title" style="color:var(--c-c);">What Gets Stored</div><div class="biz-card-text">Every invoice event stored with 25 data points: 7 raw Kafka fields, 10 OCR results from MongoDB, 1 vendor classification from MySQL, and 7 pipeline-computed fields.</div></div>
      <div class="biz-card"><div class="biz-card-icon">âš¡</div><div class="biz-card-title" style="color:var(--c-c);">Always Rolling, Never Blocking</div><div class="biz-card-text">Records written in batches of 500 throughout the run â€” not accumulated until end. RAM usage stays flat whether processing 10,000 or 10 million records per day. Fully scalable.</div></div>
      <div class="biz-card"><div class="biz-card-icon">ğŸŒ…</div><div class="biz-card-title" style="color:var(--c-c);">Analyst-Ready by Morning</div><div class="biz-card-text">Table partitioned by processing date. Dashboards query only yesterday's partition â€” fast, cheap queries. Results available the moment the pipeline finishes, ready when your team starts work.</div></div>
    </div>
    <div class="biz-outcomes">
      <div class="biz-outcome" style="border-color:rgba(34,211,238,0.3);background:rgba(34,211,238,0.04);"><div class="biz-outcome-val" style="color:var(--c-c);">ğŸ“ˆ Full Day Report</div><div class="biz-outcome-lbl">Every invoice event recorded</div></div>
      <div class="biz-outcome" style="border-color:rgba(52,211,153,0.3);background:rgba(52,211,153,0.04);"><div class="biz-outcome-val" style="color:var(--c-g);">ğŸ¯ OCR Accuracy</div><div class="biz-outcome-lbl">Match rates by vendor & status</div></div>
      <div class="biz-outcome" style="border-color:rgba(167,139,250,0.3);background:rgba(167,139,250,0.04);"><div class="biz-outcome-val" style="color:var(--c-p);">ğŸ·ï¸ Vendor Split</div><div class="biz-outcome-lbl">Legit / Manual / Moglix</div></div>
    </div>
    <div class="biz-mini-row">
      <div class="biz-mini"><div class="biz-mini-v" style="color:var(--c-c);">500</div><div class="biz-mini-l">rows per BQ write</div></div>
      <div class="biz-mini"><div class="biz-mini-v" style="color:var(--c-c);">DAY</div><div class="biz-mini-l">partition granularity</div></div>
      <div class="biz-mini"><div class="biz-mini-v" style="color:var(--c-c);">Flat</div><div class="biz-mini-l">RAM at any volume</div></div>
      <div class="biz-mini"><div class="biz-mini-v" style="color:var(--c-c);">25</div><div class="biz-mini-l">columns per row</div></div>
    </div>
  </div>

  <div style="width:3px;height:30px;background:rgba(148,163,184,0.3);margin:0 auto;"></div>
  <div style="font-family:var(--mono);font-size:0.75rem;font-weight:800;color:#4a5580;text-align:center;padding:12px 24px;border:1px solid rgba(255,255,255,0.06);border-radius:30px;margin-bottom:60px;">
    âœ… Run Complete Â· Data Ready Â· Dashboards refresh automatically
  </div>

</div>
</div>

<script>
// â”€â”€ Mode â”€â”€
function setMode(m){
  ['Dev','Biz'].forEach(v=>{
    document.getElementById('view'+v).classList.toggle('active',v.toLowerCase()===m);
    document.getElementById('btn'+v).classList.toggle('active',v.toLowerCase()===m);
  });
  if(m==='dev'){setTimeout(()=>{drawWires();drawFlowchart();},200);}
}

// â”€â”€ Flow toggle â”€â”€
let flowOn=true;
function toggleFlow(){
  flowOn=!flowOn;
  document.getElementById('flowBtn').classList.toggle('flow-on',flowOn);
  document.querySelectorAll('.anim-dot').forEach(el=>el.style.animationPlayState=flowOn?'running':'paused');
  document.querySelectorAll('.flow-anim').forEach(el=>el.style.animationPlayState=flowOn?'running':'paused');
}

// â”€â”€ Arch overlay â”€â”€
function openArch(){document.getElementById('archOverlay').classList.add('open');}
function closeArch(){document.getElementById('archOverlay').classList.remove('open');}
function closeArchOutside(e){if(e.target===document.getElementById('archOverlay'))closeArch();}

// â”€â”€ Wire diagram (schema) â”€â”€
const COL_DEFS=[
  [0,'k','#34d399'],[1,'k','#34d399'],[2,'k','#34d399'],[3,'k','#34d399'],[4,'k','#34d399'],[5,'k','#34d399'],[6,'k','#34d399'],
  [7,'m','#6ee7b7'],[8,'m','#6ee7b7'],[9,'m','#6ee7b7'],[10,'m','#6ee7b7'],[11,'m','#6ee7b7'],[12,'m','#6ee7b7'],[13,'m','#6ee7b7'],[14,'m','#6ee7b7'],[15,'m','#6ee7b7'],[16,'m','#6ee7b7'],
  [17,'s','#fbbf24'],
  [18,'p','#a78bfa'],[19,'p','#a78bfa'],[20,'p','#a78bfa'],[21,'p','#a78bfa'],[22,'p','#a78bfa'],[23,'p','#a78bfa'],[24,'p','#a78bfa'],
];

function drawWires(){
  const svg=document.getElementById('cf-svg');
  const wiresDiv=document.getElementById('cf-wires');
  if(!svg||!wiresDiv)return;
  const wRect=wiresDiv.getBoundingClientRect();
  const W=wRect.width||120,H=wRect.height||480;
  svg.setAttribute('viewBox',`0 0 ${W} ${H}`);
  svg.setAttribute('width',W);svg.setAttribute('height',H);
  svg.innerHTML='';
  const defs=document.createElementNS('http://www.w3.org/2000/svg','defs');
  ['k','m','s','p'].forEach(sk=>{
    const f=document.createElementNS('http://www.w3.org/2000/svg','filter');
    f.setAttribute('id','glow-'+sk);f.setAttribute('x','-50%');f.setAttribute('y','-50%');
    f.setAttribute('width','200%');f.setAttribute('height','200%');
    const blur=document.createElementNS('http://www.w3.org/2000/svg','feGaussianBlur');
    blur.setAttribute('stdDeviation','2.5');blur.setAttribute('result','coloredBlur');
    const merge=document.createElementNS('http://www.w3.org/2000/svg','feMerge');
    const mn1=document.createElementNS('http://www.w3.org/2000/svg','feMergeNode');mn1.setAttribute('in','coloredBlur');
    const mn2=document.createElementNS('http://www.w3.org/2000/svg','feMergeNode');mn2.setAttribute('in','SourceGraphic');
    merge.appendChild(mn1);merge.appendChild(mn2);f.appendChild(blur);f.appendChild(merge);defs.appendChild(f);
  });
  svg.appendChild(defs);
  const srcEls={k:document.getElementById('cf-src-k'),m:document.getElementById('cf-src-m'),s:document.getElementById('cf-src-s'),p:document.getElementById('cf-src-p')};
  const srcColors={k:'#34d399',m:'#6ee7b7',s:'#fbbf24',p:'#a78bfa'};
  function relY(el){if(!el)return H/2;const r=el.getBoundingClientRect();return(r.top+r.height/2)-wRect.top;}
  function dotY(i){const el=document.getElementById('cf-dot-'+i);if(!el)return H/2;const r=el.getBoundingClientRect();return(r.top+r.height/2)-wRect.top;}
  COL_DEFS.forEach(([i,sk,color])=>{
    const srcEl=srcEls[sk];if(!srcEl)return;
    const y0=relY(srcEl),y1=dotY(i);
    if(y1<-10||y1>H+10)return;
    const x0=0,x1=W-2,cx0=x0+W*0.4,cx1=x1-W*0.4;
    const pathD=`M${x0},${y0} C${cx0},${y0} ${cx1},${y1} ${x1},${y1}`;
    const pid=`wire-${i}`;
    const g=document.createElementNS('http://www.w3.org/2000/svg','path');
    g.setAttribute('d',pathD);g.setAttribute('stroke',color);g.setAttribute('stroke-width','3');
    g.setAttribute('fill','none');g.setAttribute('opacity','0.07');g.setAttribute('filter',`url(#glow-${sk})`);
    svg.appendChild(g);
    const w=document.createElementNS('http://www.w3.org/2000/svg','path');
    w.setAttribute('id',pid);w.setAttribute('d',pathD);w.setAttribute('stroke',color);
    w.setAttribute('stroke-width','1.2');w.setAttribute('fill','none');w.setAttribute('opacity','0.5');
    w.setAttribute('stroke-dasharray','4 3');
    w.style.animation=`wireDash ${1.2+i*0.04}s linear infinite`;
    w.style.animationDelay=(i*0.05)+'s';
    svg.appendChild(w);
    const dot=document.createElementNS('http://www.w3.org/2000/svg','circle');
    dot.setAttribute('r','2.3');dot.setAttribute('fill',color);dot.setAttribute('opacity','0.95');
    dot.setAttribute('filter',`url(#glow-${sk})`);
    const am=document.createElementNS('http://www.w3.org/2000/svg','animateMotion');
    am.setAttribute('dur',(1.5+i*0.08)+'s');am.setAttribute('repeatCount','indefinite');
    am.setAttribute('calcMode','spline');am.setAttribute('keyTimes','0;1');
    am.setAttribute('keySplines','0.4 0 0.6 1');am.setAttribute('begin',(i*0.06)+'s');
    const mp=document.createElementNS('http://www.w3.org/2000/svg','mpath');
    mp.setAttribute('href','#'+pid);am.appendChild(mp);dot.appendChild(am);svg.appendChild(dot);
    const td=document.createElementNS('http://www.w3.org/2000/svg','circle');
    td.setAttribute('cx',x1);td.setAttribute('cy',y1);td.setAttribute('r','2');
    td.setAttribute('fill',color);td.setAttribute('opacity','0.65');svg.appendChild(td);
  });
  ['k','m','s','p'].forEach(sk=>{
    const el=srcEls[sk];if(!el)return;
    const sy=relY(el),color=srcColors[sk];
    const od=document.createElementNS('http://www.w3.org/2000/svg','circle');
    od.setAttribute('cx','0');od.setAttribute('cy',sy);od.setAttribute('r','4');
    od.setAttribute('fill',color);od.setAttribute('opacity','0.9');
    od.setAttribute('filter',`url(#glow-${sk})`);
    const pa=document.createElementNS('http://www.w3.org/2000/svg','animate');
    pa.setAttribute('attributeName','r');pa.setAttribute('values','3;5.5;3');
    pa.setAttribute('dur','1.8s');pa.setAttribute('repeatCount','indefinite');
    od.appendChild(pa);svg.appendChild(od);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FLOWCHART â€” v8: Fixed spacing, text, rich animations
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawFlowchart(){
  const svg = document.getElementById('pipeline-svg');
  if(!svg) return;
  svg.innerHTML = '';

  const W = 1400;
  const CX = W / 2;

  // SVG element helper
  function el(tag, attrs, text){
    const e = document.createElementNS('http://www.w3.org/2000/svg', tag);
    Object.entries(attrs||{}).forEach(([k,v])=>e.setAttribute(k,v));
    if(text !== undefined) e.textContent = text;
    return e;
  }
  function grp(){ return el('g',{}); }

  // â”€â”€ COLOURS â”€â”€
  const C = {
    purple: { fill:'rgba(167,139,250,0.13)', stroke:'#a78bfa', text:'#d4bbff', dim:'#a78bfa', glow:'rgba(167,139,250,0.5)' },
    green:  { fill:'rgba(52,211,153,0.11)',  stroke:'#34d399', text:'#7fffd4', dim:'#34d399', glow:'rgba(52,211,153,0.45)' },
    teal:   { fill:'rgba(110,231,183,0.11)', stroke:'#6ee7b7', text:'#b2fce4', dim:'#6ee7b7', glow:'rgba(110,231,183,0.4)' },
    blue:   { fill:'rgba(56,189,248,0.11)',  stroke:'#38bdf8', text:'#bae6fd', dim:'#38bdf8', glow:'rgba(56,189,248,0.4)' },
    amber:  { fill:'rgba(251,191,36,0.11)',  stroke:'#fbbf24', text:'#fef08a', dim:'#fbbf24', glow:'rgba(251,191,36,0.4)' },
    cyan:   { fill:'rgba(34,211,238,0.11)',  stroke:'#22d3ee', text:'#cffafe', dim:'#22d3ee', glow:'rgba(34,211,238,0.4)' },
    red:    { fill:'rgba(251,113,133,0.11)', stroke:'#fb7185', text:'#fecdd3', dim:'#fb7185', glow:'rgba(251,113,133,0.4)' },
    slate:  { fill:'rgba(148,163,184,0.08)', stroke:'#94a3b8', text:'#e2e8f0', dim:'#94a3b8', glow:'rgba(148,163,184,0.3)' },
  };
  function cn(c){ return Object.entries(C).find(([,v])=>v===c)?.[0]||'slate'; }

  // â”€â”€ DEFS: filters + markers â”€â”€
  const defs = el('defs');
  // Glow filters
  Object.entries(C).forEach(([name, c])=>{
    const f = el('filter',{id:`gf-${name}`,x:'-40%',y:'-40%',width:'180%',height:'180%'});
    const b1 = el('feGaussianBlur',{in:'SourceGraphic',stdDeviation:'3',result:'b1'});
    const b2 = el('feGaussianBlur',{in:'SourceGraphic',stdDeviation:'8',result:'b2'});
    const flood = el('feFlood',{'flood-color':c.glow,'flood-opacity':'0.6',result:'fc'});
    const comp = el('feComposite',{in:'fc',in2:'b1',operator:'in',result:'sg'});
    const merge = el('feMerge');
    [el('feMergeNode',{in:'sg'}), el('feMergeNode',{in:'SourceGraphic'})].forEach(n=>merge.appendChild(n));
    f.appendChild(b1); f.appendChild(b2); f.appendChild(flood); f.appendChild(comp); f.appendChild(merge);
    defs.appendChild(f);

    // Pulse filter (stronger glow for node pulse animation)
    const fp = el('filter',{id:`gfp-${name}`,x:'-50%',y:'-50%',width:'200%',height:'200%'});
    const bp = el('feGaussianBlur',{in:'SourceGraphic',stdDeviation:'6',result:'bp'});
    const fp2 = el('feFlood',{'flood-color':c.glow,'flood-opacity':'0.9',result:'fc2'});
    const cp = el('feComposite',{in:'fc2',in2:'bp',operator:'in',result:'sgp'});
    const mp = el('feMerge');
    [el('feMergeNode',{in:'sgp'}), el('feMergeNode',{in:'SourceGraphic'})].forEach(n=>mp.appendChild(n));
    fp.appendChild(bp); fp.appendChild(fp2); fp.appendChild(cp); fp.appendChild(mp);
    defs.appendChild(fp);
  });

  // Arrow markers (solid + for each color)
  Object.entries(C).forEach(([name, c])=>{
    const m = el('marker',{id:`arr-${name}`,markerWidth:'9',markerHeight:'7',refX:'8',refY:'3.5',orient:'auto'});
    m.appendChild(el('polygon',{points:'0 0, 9 3.5, 0 7',fill:c.stroke,opacity:'0.95'}));
    defs.appendChild(m);
    // small variant
    const ms = el('marker',{id:`arrs-${name}`,markerWidth:'6',markerHeight:'5',refX:'5',refY:'2.5',orient:'auto'});
    ms.appendChild(el('polygon',{points:'0 0, 6 2.5, 0 5',fill:c.stroke,opacity:'0.8'}));
    defs.appendChild(ms);
  });

  // Animated gradient for special connectors
  const lg = el('linearGradient',{id:'flow-grad',x1:'0%',y1:'0%',x2:'0%',y2:'100%'});
  lg.appendChild(el('stop',{offset:'0%','stop-color':'#a78bfa','stop-opacity':'0.9'}));
  lg.appendChild(el('stop',{offset:'50%','stop-color':'#34d399','stop-opacity':'0.9'}));
  lg.appendChild(el('stop',{offset:'100%','stop-color':'#22d3ee','stop-opacity':'0.9'}));
  defs.appendChild(lg);

  svg.appendChild(defs);

  // â”€â”€ PATH COUNTER for unique IDs â”€â”€
  let _pid = 0;
  const newPid = ()=>`p${++_pid}`;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // NODE DRAWING FUNCTIONS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // START / END terminal pill with pulsing glow ring
  function terminal(cx, cy, w, h, text, c){
    const g2 = grp();
    // outer glow ring animation
    const ring = el('rect',{x:cx-w/2-4,y:cy-h/2-4,width:w+8,height:h+8,rx:h/2+4,fill:'none',stroke:c.stroke,'stroke-width':'2',opacity:'0'});
    const ra = el('animate',{attributeName:'opacity',values:'0;0.6;0',dur:'2.5s',repeatCount:'indefinite'});
    const ra2 = el('animate',{attributeName:'stroke-width',values:'2;6;2',dur:'2.5s',repeatCount:'indefinite'});
    ring.appendChild(ra); ring.appendChild(ra2); g2.appendChild(ring);
    // main pill
    g2.appendChild(el('rect',{x:cx-w/2,y:cy-h/2,width:w,height:h,rx:h/2,fill:c.fill,stroke:c.stroke,'stroke-width':'2.5',filter:`url(#gf-${cn(c)})`}));
    g2.appendChild(el('text',{x:cx,y:cy+1,'text-anchor':'middle','dominant-baseline':'middle',fill:c.text,'font-family':'Syne,sans-serif','font-size':'18','font-weight':'800','letter-spacing':'0.5px'},text));
    return g2;
  }

  // Process box â€” auto-height, clean non-overlapping layout
  // Stripe: 40px | Title: y+62 | Lines: y+90 step 24px | Chips: last 34px | bottom pad 18px
  function processBox(cx, y, w, phase, title, lines, c, chips=[]){
    const hasChips = chips.length > 0;
    const h = 40 + 34 + lines.length * 24 + (hasChips ? 38 : 14) + 18;
    const x = cx - w/2;
    const g2 = grp();

    // drop shadow
    g2.appendChild(el('rect',{x:x+4,y:y+4,width:w,height:h,rx:12,fill:c.stroke,opacity:'0.07'}));
    // main box
    const box = el('rect',{x,y,width:w,height:h,rx:12,fill:c.fill,stroke:c.stroke,'stroke-width':'1.8'});
    g2.appendChild(box);
    // top accent stripe (40px tall)
    g2.appendChild(el('rect',{x,y,width:w,height:40,rx:12,fill:c.stroke,opacity:'0.14'}));
    g2.appendChild(el('rect',{x,y:y+28,width:w,height:12,fill:c.stroke,opacity:'0.14'}));
    // left accent bar below stripe
    g2.appendChild(el('rect',{x,y:y+40,width:3,height:h-54,rx:1.5,fill:c.stroke,opacity:'0.45'}));

    // Phase label â€” vertically centred in 40px stripe
    g2.appendChild(el('text',{x:x+16,y:y+23,'text-anchor':'start','dominant-baseline':'middle',fill:c.text,'font-family':'IBM Plex Mono,monospace','font-size':'11.5','font-weight':'700','letter-spacing':'0.08em',opacity:'0.9'},phase));

    // Title â€” below stripe
    g2.appendChild(el('text',{x:x+18,y:y+62,'text-anchor':'start','dominant-baseline':'middle',fill:c.text,'font-family':'Syne,sans-serif','font-size':'16','font-weight':'800','letter-spacing':'-0.01em'},title));

    // Body lines â€” start at y+90, step 24px
    lines.forEach((line,i)=>{
      g2.appendChild(el('text',{x:x+18,y:y+90+i*24,'text-anchor':'start','dominant-baseline':'middle',fill:'#c5d4ea','font-family':'IBM Plex Mono,monospace','font-size':'11.5','letter-spacing':'0.01em'},line));
    });

    // Chips row â€” pinned 18px from bottom
    if(hasChips){
      let cx2 = x+18;
      const chipY = y+h-32;
      chips.forEach(([label2, cc])=>{
        const tw = label2.length*7.2+18;
        g2.appendChild(el('rect',{x:cx2,y:chipY,width:tw,height:22,rx:6,fill:cc.fill,stroke:cc.stroke,'stroke-width':'1.2'}));
        g2.appendChild(el('text',{x:cx2+tw/2,y:chipY+11,'text-anchor':'middle','dominant-baseline':'middle',fill:cc.text,'font-family':'IBM Plex Mono,monospace','font-size':'10','font-weight':'700'},label2));
        cx2 += tw+8;
      });
    }

    // border pulse
    const pa = el('animate',{attributeName:'opacity',values:'1;0.82;1',dur:'3.5s',repeatCount:'indefinite',begin:`${(Math.random()*2).toFixed(1)}s`});
    box.appendChild(pa);

    return { node: g2, h };
  }

  // Diamond decision node
  function diamond(cx, cy, w, h, lines, c){
    const g2 = grp();
    const d = `M ${cx} ${cy-h/2} L ${cx+w/2} ${cy} L ${cx} ${cy+h/2} L ${cx-w/2} ${cy} Z`;
    g2.appendChild(el('path',{d,fill:c.stroke,opacity:'0.07',transform:'translate(4,4)'}));
    g2.appendChild(el('path',{d,fill:c.fill,stroke:c.stroke,'stroke-width':'2.2',filter:`url(#gf-${cn(c)})`}));
    const textLines = lines.split('\n');
    textLines.forEach((line,i)=>{
      g2.appendChild(el('text',{x:cx,y:cy+(i-(textLines.length-1)/2)*18,'text-anchor':'middle','dominant-baseline':'middle',fill:c.text,'font-family':'Syne,sans-serif','font-size':'14','font-weight':'800'},line));
    });
    return g2;
  }

  // DB cylinder node â€” auto-height, precise layout
  function dbBox(cx, y, w, dbLabel, title, lines, c){
    const EH = 20; // ellipse half-height
    const h = EH + 36 + lines.length * 24 + 22;
    const x = cx - w/2;
    const g2 = grp();

    // body rect starts at EH to merge with ellipse bottom
    g2.appendChild(el('rect',{x,y:y+EH,width:w,height:h-EH,rx:8,fill:c.fill,stroke:c.stroke,'stroke-width':'1.8'}));
    // top ellipse (disk top)
    g2.appendChild(el('ellipse',{cx,cy:y+EH,rx:w/2,ry:EH,fill:c.fill,stroke:c.stroke,'stroke-width':'1.8'}));
    // tinted top disk
    g2.appendChild(el('ellipse',{cx,cy:y+EH,rx:w/2,ry:EH,fill:c.stroke,opacity:'0.20'}));
    // cover seam line
    g2.appendChild(el('rect',{x:x+2,y:y+EH,width:w-4,height:10,fill:c.fill}));
    // left bar
    g2.appendChild(el('rect',{x,y:y+EH*2,width:3,height:h-EH*2-8,rx:1.5,fill:c.stroke,opacity:'0.45'}));

    // DB type label on disk â€” centred vertically in ellipse
    g2.appendChild(el('text',{x:cx,y:y+EH,'text-anchor':'middle','dominant-baseline':'middle',fill:c.text,'font-family':'IBM Plex Mono,monospace','font-size':'11','font-weight':'800','letter-spacing':'0.09em'},dbLabel));

    // Title â€” below disk seam
    g2.appendChild(el('text',{x:x+18,y:y+EH+30,'text-anchor':'start','dominant-baseline':'middle',fill:c.text,'font-family':'Syne,sans-serif','font-size':'15','font-weight':'800'},title));

    // Body lines â€” start at EH+56, step 24px
    lines.forEach((line,i)=>{
      g2.appendChild(el('text',{x:x+18,y:y+EH+56+i*24,'text-anchor':'start','dominant-baseline':'middle',fill:'#c5d4ea','font-family':'IBM Plex Mono,monospace','font-size':'11.5','letter-spacing':'0.01em'},line));
    });

    return { node: g2, h };
  }

  // IO parallelogram
  function ioBox(cx, y, w, h, title, sub, c){
    const x = cx - w/2, sk = 22;
    const d = `M ${x+sk} ${y} L ${x+w} ${y} L ${x+w-sk} ${y+h} L ${x} ${y+h} Z`;
    const g2 = grp();
    g2.appendChild(el('path',{d,fill:c.fill,stroke:c.stroke,'stroke-width':'1.8',filter:`url(#gf-${cn(c)})`}));
    g2.appendChild(el('text',{x:cx,y:y+h/2-10,'text-anchor':'middle','dominant-baseline':'middle',fill:c.text,'font-family':'Syne,sans-serif','font-size':'15','font-weight':'800'},title));
    g2.appendChild(el('text',{x:cx,y:y+h/2+12,'text-anchor':'middle','dominant-baseline':'middle',fill:'#b0cce8','font-family':'IBM Plex Mono,monospace','font-size':'11'},sub));
    return g2;
  }

  // Side dead-end box (for branch exits)
  function sideBox(bx, cy, w, h, title, lines, c){
    const g2 = grp();
    const ty = cy - h/2;
    g2.appendChild(el('rect',{x:bx,y:ty,width:w,height:h,rx:9,fill:c.fill,stroke:c.stroke,'stroke-width':'1.5','stroke-dasharray':'5 3'}));
    // header stripe 22px tall
    g2.appendChild(el('rect',{x:bx,y:ty,width:w,height:22,rx:9,fill:c.stroke,opacity:'0.13'}));
    g2.appendChild(el('rect',{x:bx,y:ty+14,width:w,height:8,fill:c.stroke,opacity:'0.13'}));
    // title vertically centred in stripe
    g2.appendChild(el('text',{x:bx+w/2,y:ty+12,'text-anchor':'middle','dominant-baseline':'middle',fill:c.text,'font-family':'Syne,sans-serif','font-size':'11.5','font-weight':'800'},title));
    // body lines â€” first line at ty+38, step 18px (clear of 22px stripe)
    lines.forEach((line,i)=>{
      g2.appendChild(el('text',{x:bx+10,y:ty+38+i*18,'text-anchor':'start','dominant-baseline':'middle',fill:'#8896b3','font-family':'IBM Plex Mono,monospace','font-size':'10.5'},line));
    });
    return g2;
  }

  // Section divider label
  function sectionLabel(cx, y, text, c){
    const g2 = grp();
    const tw = text.length*7.5+30;
    const tx = cx - tw/2;
    g2.appendChild(el('line',{x1:cx-300,y1:y,x2:tx-10,y2:y,stroke:c?c.stroke:'rgba(255,255,255,0.06)','stroke-width':'1'}));
    g2.appendChild(el('line',{x1:tx+tw+10,y1:y,x2:cx+300,y2:y,stroke:c?c.stroke:'rgba(255,255,255,0.06)','stroke-width':'1'}));
    g2.appendChild(el('rect',{x:tx,y:y-9,width:tw,height:18,rx:9,fill:c?c.fill:'rgba(255,255,255,0.03)',stroke:c?c.stroke:'rgba(255,255,255,0.1)','stroke-width':'1'}));
    g2.appendChild(el('text',{x:cx,y:y+1,'text-anchor':'middle','dominant-baseline':'middle',fill:c?c.text:'#5a6888','font-family':'IBM Plex Mono,monospace','font-size':'11.5','font-weight':'800','letter-spacing':'0.12em'},text));
    return g2;
  }

  // YES/NO branch pill tag
  function tag(x, y, text, c){
    const g2 = grp();
    const tw = text.length*8+16;
    g2.appendChild(el('rect',{x:x-tw/2,y:y-10,width:tw,height:20,rx:10,fill:c.fill,stroke:c.stroke,'stroke-width':'1.8'}));
    g2.appendChild(el('text',{x,y:y+1,'text-anchor':'middle','dominant-baseline':'middle',fill:c.text,'font-family':'Syne,sans-serif','font-size':'12.5','font-weight':'800'},text));
    return g2;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CONNECTOR â€” animated flowing line with multiple dots
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function conn(d, c, opts={}){
    const pid = newPid();
    const g2 = grp();
    const {label='', nDots=2, speed=2.0, dashed=false, thick=false} = opts;

    // Glow underlay
    g2.appendChild(el('path',{d,stroke:c.stroke,'stroke-width': thick?'7':'5',fill:'none',opacity:'0.08',filter:`url(#gf-${cn(c)})`}));
    // Main line
    const ln = el('path',{id:pid,d,stroke:c.stroke,'stroke-width': thick?'2.5':'2',fill:'none',opacity:'0.85'});
    if(dashed) ln.setAttribute('stroke-dasharray','7 5');
    else ln.setAttribute('stroke-dasharray','8 5');
    ln.style.animation = `wireDash ${dashed?2.5:1.8}s linear infinite`;
    ln.classList.add('flow-anim');
    g2.appendChild(ln);

    // Multiple animated dots at staggered delays
    for(let di=0; di<nDots; di++){
      const dot = el('circle',{r: di===0?'5':'3.5', fill: c.stroke, filter:`url(#gfp-${cn(c)})`, opacity: di===0?'1':'0.7'});
      const am = el('animateMotion',{dur:`${speed}s`,repeatCount:'indefinite',begin:`${(di/nDots)*speed}s`,calcMode:'spline',keyTimes:'0;1',keySplines:'0.25 0 0.75 1'});
      am.classList.add('flow-anim');
      const mp = el('mpath',{'href':'#'+pid});
      am.appendChild(mp); dot.appendChild(am);
      g2.appendChild(dot);
    }

    // Label badge on connector midpoint
    if(label){
      const nums = d.match(/-?\d+(\.\d+)?/g).map(Number);
      const mx = (nums[0]+nums[nums.length-2])/2;
      const my = (nums[1]+nums[nums.length-1])/2;
      const lw = label.length*7+16;
      g2.appendChild(el('rect',{x:mx-lw/2,y:my-9,width:lw,height:18,rx:9,fill:'#060813',stroke:c.stroke,'stroke-width':'1',opacity:'0.95'}));
      g2.appendChild(el('text',{x:mx,y:my+1,'text-anchor':'middle','dominant-baseline':'middle',fill:c.text,'font-family':'IBM Plex Mono,monospace','font-size':'9.5','font-weight':'700'},label));
    }
    return g2;
  }

  // Arrow tip (standalone polygon)
  function arrow(x, y, dir, c){
    const sz = 8;
    let pts;
    if(dir==='down')  pts=`${x-sz/1.5},${y-sz} ${x+sz/1.5},${y-sz} ${x},${y}`;
    if(dir==='left')  pts=`${x+sz},${y-sz/1.5} ${x+sz},${y+sz/1.5} ${x},${y}`;
    if(dir==='right') pts=`${x-sz},${y-sz/1.5} ${x-sz},${y+sz/1.5} ${x},${y}`;
    if(dir==='up')    pts=`${x-sz/1.5},${y+sz} ${x+sz/1.5},${y+sz} ${x},${y}`;
    return el('polygon',{points:pts,fill:c.stroke,opacity:'0.95'});
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // LAYOUT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  let y = 40;
  const BW = 480;      // main box width (wider for text)
  const LX = 140;      // left side exit x
  const RX = W-140;    // right side exit x
  const SBW = 190;     // side box width
  const DW = 290, DH = 100; // diamond width/height
  const GAP = 38;      // standard connector gap

  // â”€â”€ PHASE 0 STARTUP â”€â”€
  svg.appendChild(sectionLabel(CX, y, 'âš™  PHASE 0  Â·  PIPELINE STARTUP', C.purple));
  y += 25;

  // START
  const startG = terminal(CX, y+28, 400, 52, 'ğŸš€  run_pipeline()  Â·  Pipeline Start', C.purple);
  svg.appendChild(startG);
  y += 48;

  svg.appendChild(conn(`M ${CX} ${y} L ${CX} ${y+GAP}`, C.purple, {nDots:1,speed:1.5}));
  svg.appendChild(arrow(CX,y+GAP,'down',C.purple));
  y += GAP;

  // PipelineConfig
  const cfg = processBox(CX, y, BW, 'âš™ï¸  PROCESS  Â·  PHASE 0', 'PipelineConfig()', [
    'Load .env Â· Compute T-1 window (yesterday 00:00â†’23:59 IST)',
    'Query BQ MAX(kafka_timestamp) â†’ start_from_ms = ts+1ms',
    'Idempotent: safe to restart at any point mid-run'
  ], C.purple, [['pipeline_run_date',C.purple],['start_from_ms',C.purple],['t1_end_ms',C.purple]]);
  svg.appendChild(cfg.node); y += cfg.h;

  svg.appendChild(conn(`M ${CX} ${y} L ${CX} ${y+GAP}`, C.purple, {nDots:1,speed:1.5}));
  svg.appendChild(arrow(CX,y+GAP,'down',C.purple));
  y += GAP;

  // DB Init
  const dbi = dbBox(CX, y, BW, 'ğŸ”Œ  DATABASE INIT', 'DatabaseConnections.initialize()', [
    'MongoDB: pool 20â€“100 connections Â· index po_id_idx',
    'BigQuery: 25-col table auto-create Â· DAY partition',
    'MySQL: pool=3 Â· Kafka: fetch 64KB min / 4MB max'
  ], C.purple);
  svg.appendChild(dbi.node); y += dbi.h;

  svg.appendChild(conn(`M ${CX} ${y} L ${CX} ${y+GAP}`, C.purple, {nDots:1,speed:1.8}));
  svg.appendChild(arrow(CX,y+GAP,'down',C.purple));
  y += GAP;

  const proc = processBox(CX, y, BW, 'âš™ï¸  PROCESS', 'PipelineProcessor.__init__()', [
    'PipelineStats() Â· MongoCache(OrderedDict, max=5000)',
    'VendorTypeClassifier Â· Init kafka_pending=[] bq_pending=[]'
  ], C.purple, []);
  svg.appendChild(proc.node); y += proc.h;

  // â”€â”€ KAFKA LOOP START â”€â”€
  svg.appendChild(conn(`M ${CX} ${y} L ${CX} ${y+GAP+10}`, C.green, {nDots:3,speed:1.4,label:'begin Kafka polling loop'}));
  svg.appendChild(arrow(CX,y+GAP+10,'down',C.green));
  y += GAP+10;
  y += 16;
  svg.appendChild(sectionLabel(CX, y-10, 'ğŸ“¡  PHASE 1  Â·  KAFKA POLL LOOP', C.green));
  y += 14;

  // consumer.poll IO
  svg.appendChild(ioBox(CX, y, BW+30, 62, 'ğŸ“¡  consumer.poll( timeout = 0.05 s )', 'fetch.min.bytes=64KB Â· max.partition=4MB Â· queued.min=200k msgs', C.green));
  y += 56;

  svg.appendChild(conn(`M ${CX} ${y} L ${CX} ${y+GAP}`, C.green, {nDots:2,speed:1.4}));
  svg.appendChild(arrow(CX,y+GAP,'down',C.green));
  y += GAP;

  // DECISION 1 â€” msg is None?
  svg.appendChild(diamond(CX, y+DH/2, DW, DH, 'msg\nis None?', C.green));
  // YES â†’ right
  svg.appendChild(conn(`M ${CX+DW/2} ${y+DH/2} L ${RX-SBW} ${y+DH/2}`, C.red, {nDots:1,speed:1.2,dashed:true}));
  svg.appendChild(arrow(RX-SBW,y+DH/2,'right',C.red));
  svg.appendChild(tag(CX+DW/2+40, y+DH/2-16, 'YES', C.red));
  svg.appendChild(sideBox(RX-SBW, y+DH/2, SBW, 72, 'empty_polls++', ['>100 polls + processed>0','â†’ END STREAM'], C.red));
  // NO â†“
  svg.appendChild(tag(CX+14, y+DH+8, 'NO', C.green));
  svg.appendChild(conn(`M ${CX} ${y+DH} L ${CX} ${y+DH+GAP}`, C.green, {nDots:1,speed:1.4}));
  svg.appendChild(arrow(CX,y+DH+GAP,'down',C.green));
  y += DH + GAP;

  // DECISION 2 â€” msg.error?
  svg.appendChild(diamond(CX, y+DH/2, DW, DH, 'msg\n.error()?', C.green));
  // YES â†’ right
  svg.appendChild(conn(`M ${CX+DW/2} ${y+DH/2} L ${RX-SBW} ${y+DH/2}`, C.red, {nDots:1,speed:1.2,dashed:true}));
  svg.appendChild(arrow(RX-SBW,y+DH/2,'right',C.red));
  svg.appendChild(tag(CX+DW/2+40, y+DH/2-16, 'YES', C.red));
  svg.appendChild(sideBox(RX-SBW, y+DH/2, SBW, 66, 'log WARNING', ['skip msg','continue loop â†’ poll()'], C.red));
  // NO â†“
  svg.appendChild(tag(CX+14, y+DH+8, 'NO', C.green));
  svg.appendChild(conn(`M ${CX} ${y+DH} L ${CX} ${y+DH+GAP}`, C.green, {nDots:1,speed:1.4}));
  svg.appendChild(arrow(CX,y+DH+GAP,'down',C.green));
  y += DH + GAP;

  // Timestamp Filter
  const tsf = processBox(CX, y, BW, 'ğŸ•  PROCESS  Â·  PHASE 1  â€”  TIMESTAMP WINDOW FILTER', 'Timestamp Filter', [
    'ts â‰¤ 0 â†’ skip invalid epoch',
    'ts â‰¤ start_from_ms â†’ skipped_old++ Â· log every 500',
    'ts > t1_end_ms â†’ STOP LOOP (exit condition)',
    'Else â†’ valid event â†’ append to buffer'
  ], C.green, [['kafka_timestamp',C.green]]);
  svg.appendChild(tsf.node); y += tsf.h;

  svg.appendChild(conn(`M ${CX} ${y} L ${CX} ${y+GAP}`, C.green, {nDots:2,speed:1.4}));
  svg.appendChild(arrow(CX,y+GAP,'down',C.green));
  y += GAP;

  // IO: Parse
  svg.appendChild(ioBox(CX, y, BW+30, 62, 'ğŸ“¥  Parse JSON  â†’  kafka_pending.append()', 'Extract: po_id Â· gstin Â· inv_date Â· inv_total Â· file_url Â· ts_ms', C.green));
  y += 56;

  svg.appendChild(conn(`M ${CX} ${y} L ${CX} ${y+GAP}`, C.green, {nDots:2,speed:1.4}));
  svg.appendChild(arrow(CX,y+GAP,'down',C.green));
  y += GAP;

  // DECISION 3 â€” buffer >= 100?
  svg.appendChild(diamond(CX, y+DH/2, DW+30, DH, 'len(kafka_pending)\nâ‰¥ 100?', C.green));

  // NO â†’ right, loop back
  const loopRightY = y+DH/2;
  svg.appendChild(conn(`M ${CX+DW/2+15} ${loopRightY} L ${RX-SBW} ${loopRightY}`, C.slate, {nDots:1,speed:1.8,dashed:true}));
  svg.appendChild(arrow(RX-SBW,loopRightY,'right',C.slate));
  svg.appendChild(tag(CX+DW/2+55, loopRightY-16, 'NO', C.slate));
  svg.appendChild(sideBox(RX-SBW, loopRightY, SBW, 60, 'â† poll next msg', ['loop back to','consumer.poll()'], C.slate));

  // Loop-back line up the right rail
  const loopRailX = RX-SBW+SBW+12;
  const loopTopY = y - DH*4.2 - 30; // target the IO poll box
  svg.appendChild(conn(
    `M ${loopRailX} ${loopRightY} L ${loopRailX+50} ${loopRightY} L ${loopRailX+50} ${loopTopY} L ${CX+BW/2+20} ${loopTopY}`,
    C.slate, {nDots:1, speed:3.5, dashed:true}
  ));
  svg.appendChild(arrow(CX+BW/2+20, loopTopY, 'left', C.slate));

  // YES â†“
  svg.appendChild(tag(CX+14, y+DH+8, 'YES', C.teal));
  svg.appendChild(conn(`M ${CX} ${y+DH} L ${CX} ${y+DH+GAP+10}`, C.teal, {nDots:3,speed:1.3,label:'flush batch â†’ process_kafka_batch()'}));
  svg.appendChild(arrow(CX,y+DH+GAP+10,'down',C.teal));
  y += DH + GAP + 10;
  y += 18;
  svg.appendChild(sectionLabel(CX, y-12, 'âœ‚  PHASE 1b  Â·  BATCH PROCESSING  (100 msgs)', C.teal));
  y += 14;

  // Split box
  const split = processBox(CX, y, BW, 'âœ‚ï¸  PROCESS  Â·  PHASE 1b  â€”  SPLIT ON po_id', 'process_kafka_batch() â†’ split', [
    'Partition: has_po_id list  vs  missing_po list',
    'missing_po â†’ _empty_row(PO_ID_MISSING_KAFKA) immediately',
    'Zero MongoDB cost for missing po_id rows'
  ], C.teal, []);
  svg.appendChild(split.node);

  // LEFT exit â€” MISSING_KAFKA
  const misY = y + split.h/2;
  svg.appendChild(conn(`M ${CX-BW/2} ${misY} L ${LX+SBW} ${misY}`, C.red, {nDots:1,speed:1.2,dashed:true}));
  svg.appendChild(arrow(LX+SBW,misY,'left',C.red));
  svg.appendChild(sideBox(LX, misY, SBW, 66, 'âš  MISSING_KAFKA', ['po_id absent from msg','â†’ empty BQ row'], C.red));

  y += split.h;
  svg.appendChild(conn(`M ${CX} ${y} L ${CX} ${y+GAP}`, C.teal, {nDots:2,speed:1.5}));
  svg.appendChild(arrow(CX,y+GAP,'down',C.teal));
  y += GAP;

  // LRU Cache
  const lru = processBox(CX, y, BW, 'ğŸ’¾  CACHE  Â·  O(1) LRU  â€”  MongoCache', 'MongoCache._cache_lookup( po_id )', [
    'OrderedDict LRU max=5,000 entries',
    'HIT â†’ move_to_end() O(1) â†’ return cached doc',
    'MISS â†’ add to to_fetch[] for batch query',
    'Caches None sentinel â†’ prevents re-querying missing'
  ], C.blue, []);
  svg.appendChild(lru.node); y += lru.h;

  svg.appendChild(conn(`M ${CX} ${y} L ${CX} ${y+GAP}`, C.blue, {nDots:2,speed:1.4}));
  svg.appendChild(arrow(CX,y+GAP,'down',C.teal));
  y += GAP;

  // MongoDB
  const mdb = dbBox(CX, y, BW, 'ğŸ—„  MONGODB  Â·  âš¡ 1 QUERY / 100 MSGS', 'fetch_mongo_batch() â€” single $in query', [
    'find({request_body.po_id:{$in:[...all_miss_ids]}}) Â· asyncio.to_thread',
    'Project: request_body, response_body, created_at, _id',
    'Was N separate find_one calls â€” now 1 round-trip'
  ], C.teal);
  svg.appendChild(mdb.node); y += mdb.h;

  svg.appendChild(conn(`M ${CX} ${y} L ${CX} ${y+GAP}`, C.teal, {nDots:2,speed:1.5}));
  svg.appendChild(arrow(CX,y+GAP,'down',C.teal));
  y += GAP;

  // build_bq_row
  const bqr = processBox(CX, y, BW, 'ğŸ—  PROCESS  Â·  SYNCHRONOUS  â€”  build_bq_row', 'build_bq_row() â†’ determine_status()', [
    'Compute time_diff_seconds = mongo_created_at âˆ’ kafka_ts_ms',
    'Determine one of 7 status values (see fan-out below)',
    'vendor_type = None initially (stamped in Phase 2)'
  ], C.teal, [['status',C.teal],['time_diff_seconds',C.teal],['batch_id',C.teal]]);
  svg.appendChild(bqr.node); y += bqr.h;

  // â”€â”€ 7 STATUS FAN-OUT â”€â”€
  svg.appendChild(conn(`M ${CX} ${y} L ${CX} ${y+20}`, C.teal, {nDots:1,speed:1.3}));
  y += 20;
  y += 14;
  svg.appendChild(sectionLabel(CX, y-10, 'â†™  7 STATUS OUTCOMES  â†˜', C.teal));
  y += 14;

  // Horizontal dispatch bus with animated sweep
  const busY2 = y;
  const busL = 55, busR = W-55;
  // animated bus line
  const busId = newPid();
  svg.appendChild(el('path',{id:busId,d:`M ${busL} ${busY2} L ${busR} ${busY2}`,stroke:C.teal.stroke,'stroke-width':'2.5','stroke-dasharray':'8 4',opacity:'0.5'}));
  // animated pulse along bus
  for(let bi=0;bi<3;bi++){
    const bd = el('circle',{r:'4',fill:C.teal.stroke,filter:`url(#gfp-teal)`});
    const ba = el('animateMotion',{dur:'3s',repeatCount:'indefinite',begin:`${bi}s`});
    ba.classList.add('flow-anim');
    const bm = el('mpath',{'href':'#'+busId});
    ba.appendChild(bm); bd.appendChild(ba);
    svg.appendChild(bd);
  }

  // 7 outcome columns â€” evenly spaced
  const outcomes2 = [
    {label:'âœ… MATCHED',       sub:['Date+total present','time_diff within SLA'],   color:C.green},
    {label:'âš  MONGO_EMPTY',   sub:['Doc found but all','critical fields blank'],    color:C.amber},
    {label:'âš  DATE_MISSING',  sub:['OCR failed to','extract invoice date'],         color:C.amber},
    {label:'âš  TOTAL_MISSING', sub:['OCR missed','invoice amount field'],            color:C.amber},
    {label:'â± TIME_EXCEEDED', sub:['time_diff > threshold','SLA breach detected'],  color:C.purple},
    {label:'âŒ NOT_FOUND',    sub:['No MongoDB doc','â†’ triggers MySQL Phase 2'],     color:C.red},
    {label:'âš  PO_MISSING',   sub:['Kafka msg has','no po_id field at all'],         color:C.red},
  ];
    const nOut = outcomes2.length;
  const outBW = 160, outH = 92, outDrop = 34;
  const outSpan = busR - busL;
  outcomes2.forEach((o,i)=>{
    const ox = busL + (i+0.5)*(outSpan/nOut);
    // vertical drop
    svg.appendChild(conn(`M ${ox} ${busY2} L ${ox} ${busY2+outDrop}`, o.color, {nDots:1,speed:1.0+i*0.1}));
    svg.appendChild(arrow(ox, busY2+outDrop, 'down', o.color));
    // outcome box
    const og = grp();
    const obx = ox - outBW/2;
    og.appendChild(el('rect',{x:obx,y:busY2+outDrop,width:outBW,height:outH,rx:9,fill:o.color.fill,stroke:o.color.stroke,'stroke-width':'1.6','stroke-dasharray':'5 3'}));
    // top tint stripe
    og.appendChild(el('rect',{x:obx,y:busY2+outDrop,width:outBW,height:20,rx:9,fill:o.color.stroke,opacity:'0.14'}));
    og.appendChild(el('rect',{x:obx,y:busY2+outDrop+12,width:outBW,height:8,fill:o.color.stroke,opacity:'0.14'}));
    og.appendChild(el('text',{x:ox,y:busY2+outDrop+16,'text-anchor':'middle','dominant-baseline':'middle',fill:o.color.text,'font-family':'Syne,sans-serif','font-size':'11','font-weight':'800'},o.label));
    o.sub.forEach((s,si)=>{
      og.appendChild(el('text',{x:ox,y:busY2+outDrop+38+si*18,'text-anchor':'middle',fill:'#8896b3','font-family':'IBM Plex Mono,monospace','font-size':'10'},s));
    });
    svg.appendChild(og);
  });

  y = busY2 + outDrop + outH + 28;

  // Re-join bus
  const rjY = y;
  svg.appendChild(el('line',{x1:busL,y1:rjY,x2:busR,y2:rjY,stroke:'rgba(251,191,36,0.35)','stroke-width':'1.5','stroke-dasharray':'6 4'}));
  svg.appendChild(el('text',{x:CX,y:rjY-10,'text-anchor':'middle',fill:'#5a6480','font-family':'IBM Plex Mono,monospace','font-size':'10','font-weight':'700'},'bq_pending >= 500  ->  classify_and_write()'));

  svg.appendChild(conn(`M ${CX} ${rjY} L ${CX} ${rjY+GAP+8}`, C.amber, {nDots:3,speed:1.4}));
  svg.appendChild(arrow(CX,rjY+GAP+8,'down',C.amber));
  y = rjY + GAP + 8;
  y += 18;
  svg.appendChild(sectionLabel(CX, y-12, 'ğŸ·  PHASE 2  Â·  VENDOR CLASSIFICATION', C.amber));
  y += 14;

  // classify_and_write
  const caw = processBox(CX, y, BW, 'âœ‚ï¸  PROCESS  Â·  PHASE 2  â€”  VENDOR CLASSIFY', 'classify_and_write( batch ) â†’ split', [
    'legit_rows (status â‰  NOT_FOUND) â†’ tagged Legit instantly',
    'not_found_rows â†’ GSTIN dedup + MySQL query',
    'Zero MySQL cost for all matched / incomplete rows'
  ], C.amber, []);
  svg.appendChild(caw.node); y += caw.h;

  svg.appendChild(conn(`M ${CX} ${y} L ${CX} ${y+GAP}`, C.amber, {nDots:2,speed:1.4}));
  svg.appendChild(arrow(CX,y+GAP,'down',C.amber));
  y += GAP;

  // DECISION 4 â€” NOT_FOUND?
  svg.appendChild(diamond(CX, y+DH/2, DW+20, DH, 'status ==\nPO_ID_NOT_FOUND?', C.amber));
  // NO â†’ left: Legit
  svg.appendChild(conn(`M ${CX-DW/2-10} ${y+DH/2} L ${LX+SBW} ${y+DH/2}`, C.green, {nDots:1,speed:1.2,dashed:true}));
  svg.appendChild(arrow(LX+SBW,y+DH/2,'left',C.green));
  svg.appendChild(tag(CX-DW/2-55, y+DH/2-16, 'NO', C.green));
  svg.appendChild(sideBox(LX, y+DH/2, SBW, 72, 'âœ… vendor_type = Legit', ['OCR pipeline worked','no MySQL touch needed'], C.green));
  // YES â†“
  svg.appendChild(tag(CX+14, y+DH+8, 'YES', C.amber));
  svg.appendChild(conn(`M ${CX} ${y+DH} L ${CX} ${y+DH+GAP}`, C.amber, {nDots:2,speed:1.4}));
  svg.appendChild(arrow(CX,y+DH+GAP,'down',C.amber));
  y += DH + GAP;

  // MySQL
  const mysql = dbBox(CX, y, BW, 'ğŸ—ƒ  MYSQL  Â·  Dim_Sys_Plant  Â·  âš¡ 1 QUERY / BATCH', 'Dedup GSTINs â†’ Dim_Sys_Plant query', [
    'Set comprehension on not_found_rows.final_gstin â†’ dedup',
    'SELECT DISTINCT WHERE GSTIN IN (%s)',
    'AND Vertical NOT IN (ALL, ABFRL) AND Company_ID <> 1'
  ], C.amber);
  svg.appendChild(mysql.node); y += mysql.h;

  svg.appendChild(conn(`M ${CX} ${y} L ${CX} ${y+GAP}`, C.amber, {nDots:2,speed:1.5}));
  svg.appendChild(arrow(CX,y+GAP,'down',C.amber));
  y += GAP;

  // Stamp vendor_type
  const stamp = processBox(CX, y, BW, 'ğŸ·ï¸  PROCESS  â€”  STAMP vendor_type', 'row["vendor_type"] = ?', [
    'â‰  NOT_FOUND  â†’  Legit (OCR worked)',
    'NOT_FOUND + GSTIN in manual_set  â†’  Manual (expected gap)',
    'NOT_FOUND + not in set  â†’  Moglix (OCR gap to fix)',
    'MySQL ERROR  â†’  fallback all â†’ Moglix  (non-fatal)'
  ], C.amber, [['âœ… Legit',C.green],['ğŸ“‹ Manual',C.amber],['ğŸ”´ Moglix',C.red]]);
  svg.appendChild(stamp.node);

  // 3-way exits from stamp box
  const stampMidY = y + stamp.h/2;
  // Legit LEFT
  svg.appendChild(conn(`M ${CX-BW/2} ${stampMidY-18} L ${LX+SBW} ${stampMidY-18}`, C.green, {nDots:1,speed:1.1,dashed:true}));
  svg.appendChild(arrow(LX+SBW,stampMidY-18,'left',C.green));
  svg.appendChild(sideBox(LX, stampMidY-18, SBW, 54, 'âœ… Legit', ['status â‰  NOT_FOUND'], C.green));
  // Manual LEFT
  svg.appendChild(conn(`M ${CX-BW/2} ${stampMidY+22} L ${LX+SBW} ${stampMidY+22}`, C.amber, {nDots:1,speed:1.1,dashed:true}));
  svg.appendChild(arrow(LX+SBW,stampMidY+22,'left',C.amber));
  svg.appendChild(sideBox(LX, stampMidY+22, SBW, 54, 'ğŸ“‹ Manual', ['GSTIN in manual_set'], C.amber));
  // Moglix RIGHT
  svg.appendChild(conn(`M ${CX+BW/2} ${stampMidY} L ${RX-SBW} ${stampMidY}`, C.red, {nDots:1,speed:1.1,dashed:true}));
  svg.appendChild(arrow(RX-SBW,stampMidY,'right',C.red));
  svg.appendChild(sideBox(RX-SBW, stampMidY, SBW, 54, 'ğŸ”´ Moglix', ['GSTIN not in manual_set'], C.red));

  y += stamp.h;

  // â”€â”€ PHASE 3: BQ WRITE â”€â”€
  svg.appendChild(conn(`M ${CX} ${y} L ${CX} ${y+GAP+10}`, C.cyan, {nDots:3,speed:1.3,label:'all 25 fields ready â†’ serialize â†’ insert'}));
  svg.appendChild(arrow(CX,y+GAP+10,'down',C.cyan));
  y += GAP+10;
  y += 18;
  svg.appendChild(sectionLabel(CX, y-12, 'â˜  PHASE 3  Â·  BIGQUERY STREAMING INSERT', C.cyan));
  y += 14;

  const ser = processBox(CX, y, BW, 'ğŸ”„  PROCESS  Â·  PHASE 3  â€”  SERIALIZE', 'serialize_for_json()', [
    'datetime â†’ ISO 8601 string Â· None â†’ JSON null',
    'Primitives pass-through Â· Dicts/lists recurse',
    'Prepares complete BQ streaming insert payload'
  ], C.cyan, []);
  svg.appendChild(ser.node); y += ser.h;

  svg.appendChild(conn(`M ${CX} ${y} L ${CX} ${y+GAP}`, C.cyan, {nDots:2,speed:1.5}));
  svg.appendChild(arrow(CX,y+GAP,'down',C.cyan));
  y += GAP;

  // BQ Insert DB
  const bqi = dbBox(CX, y, BW, 'â˜  BIGQUERY  Â·  STREAMING INSERT  Â·  asyncio.to_thread', 'insert_rows_json() â€” 500-row rolling batch', [
    'BQ streaming â†’ project.dataset.ocr_accuracy_results',
    'Partitioned by processing_timestamp (DAY partition)',
    'âš¡ Rolling mid-pipeline â†’ flat RAM at any daily volume',
    'Errors: log + stats.errors+=N Â· non-fatal, continues'
  ], C.cyan);
  svg.appendChild(bqi.node);

  // Error LEFT, Success RIGHT
  const bqMidY = y + bqi.h/2;
  svg.appendChild(conn(`M ${CX-BW/2} ${bqMidY} L ${LX+SBW} ${bqMidY}`, C.red, {nDots:1,speed:1.2,dashed:true}));
  svg.appendChild(arrow(LX+SBW,bqMidY,'left',C.red));
  svg.appendChild(sideBox(LX, bqMidY, SBW, 62, 'âš  Insert Error', ['log + stats.errors+=N','non-fatal, continues'], C.red));

  svg.appendChild(conn(`M ${CX+BW/2} ${bqMidY} L ${RX-SBW} ${bqMidY}`, C.green, {nDots:1,speed:1.2,dashed:true}));
  svg.appendChild(arrow(RX-SBW,bqMidY,'right',C.green));
  svg.appendChild(sideBox(RX-SBW, bqMidY, SBW, 62, 'âœ… Batch Written', ['total_batches++','on_batch_written() hook'], C.green));

  y += bqi.h;

  svg.appendChild(conn(`M ${CX} ${y} L ${CX} ${y+GAP}`, C.cyan, {nDots:2,speed:1.5}));
  svg.appendChild(arrow(CX,y+GAP,'down',C.cyan));
  y += GAP;

  // Finalise
  const fin = processBox(CX, y, BW, 'ğŸ”š  PROCESS  Â·  FINALISE', 'Drain + connections.close()', [
    'on_batch_written() hook â†’ override for Slack / metrics',
    'Flush remaining kafka_pending + bq_pending buffers',
    'stats.log_summary() â†’ totals, cache ratio, vendor counts',
    'finally block cleanly closes all 4 connections'
  ], C.cyan, []);
  svg.appendChild(fin.node); y += fin.h;

  svg.appendChild(conn(`M ${CX} ${y} L ${CX} ${y+GAP}`, C.slate, {nDots:1,speed:2}));
  svg.appendChild(arrow(CX,y+GAP,'down',C.slate));
  y += GAP;

  // END
  svg.appendChild(terminal(CX, y+28, 440, 56, 'âœ…  Pipeline Complete  Â·  All connections closed', C.slate));
  y += 60;

  // Update viewBox to fit all content
  svg.setAttribute('viewBox', `0 0 ${W} ${y+20}`);
  svg.setAttribute('width', W);
  svg.setAttribute('height', y+20);
}

// â”€â”€ CSV streaming â”€â”€
const STATUSES=['MATCHED','MATCHED','MATCHED','PO_ID_NOT_FOUND','INVOICE_DATE_MISSING','INVOICE_TOTAL_MISSING','TIME_BUFFER_EXCEEDED','MONGO_ALL_EMPTY'];
const GSTINS=['27AABCM1596J1ZQ','29AABCP6984L1ZS','07AAACT2727Q1Z4','33AABCE4747C1ZN'];
const PO_IDS=['PO-2024-88421','PO-2024-88422','PO-2024-88423','PO-2024-88424','PO-2024-88425'];
const AMTS=[14250.00,87300.50,3400.00,126000.00,9875.25];
let rowCtrs={dev:1,biz:1};
function rnd(a){return a[Math.floor(Math.random()*a.length)];}
function fmtTs(ms){return new Date(ms).toISOString().replace('T',' ').slice(0,19);}

function makeRow(){
  const st=rnd(STATUSES),ok=st==='MATCHED';
  const vt=st==='PO_ID_NOT_FOUND'?(Math.random()>0.5?'Moglix':'Manual'):'Legit';
  const kts=Date.now()-Math.floor(Math.random()*3600000);
  const mts=kts+Math.floor(Math.random()*30000);
  return{kts:String(kts),po:rnd(PO_IDS),gstin:rnd(GSTINS),amt:rnd(AMTS).toFixed(2),invDate:'2024-10-15',
    ocrDate:ok?'2024-10-15':'',ocrTotal:ok?rnd(AMTS).toFixed(2):'',qr:ok?(Math.random()>0.35?'true':'false'):'false',
    vt,status:st,diff:((mts-kts)/1000).toFixed(2),pts:fmtTs(Date.now())};
}
function sc(s){if(s==='MATCHED')return'cv-ok';if(s.includes('MISSING')||s.includes('EMPTY')||s.includes('EXCEEDED'))return'cv-warn';return'cv-err';}
function vc(v){if(v==='Legit')return'cv-ok';if(v==='Manual')return'cv-warn';return'cv-err';}

function appendRow(tbodyId,key){
  const tbody=document.getElementById(tbodyId);if(!tbody)return;
  const d=makeRow(),n=rowCtrs[key]++;
  const tr=document.createElement('tr');tr.className='fresh-row';
  tr.innerHTML=`
    <td style="color:rgba(255,255,255,0.3);width:26px;">${n}</td>
    <td class="cv-k">${d.kts}</td><td class="cv-k">${d.po}</td><td class="cv-k">${d.gstin}</td>
    <td class="cv-num">${d.amt}</td><td class="cv-k">${d.invDate}</td>
    <td class="${d.ocrDate?'cv-m':'cv-null'}">${d.ocrDate||'null'}</td>
    <td class="${d.ocrTotal?'cv-m':'cv-null'}">${d.ocrTotal||'null'}</td>
    <td class="cv-m">${d.qr}</td>
    <td class="${vc(d.vt)}">${d.vt}</td>
    <td class="${sc(d.status)}">${d.status}</td>
    <td class="cv-num">${d.diff}</td>
    <td class="cv-ts">${d.pts}</td>`;
  tbody.insertBefore(tr,tbody.firstChild);
  for(let i=0;i<25;i++){const r=document.getElementById('cf-col-'+i);if(r){r.classList.remove('col-flash');void r.offsetWidth;r.classList.add('col-flash');}}
  while(tbody.children.length>6)tbody.removeChild(tbody.lastChild);
}

window.addEventListener('load',()=>{
  setTimeout(()=>{
    for(let i=0;i<5;i++){appendRow('dev-tbody','dev');appendRow('biz-tbody','biz');}
    drawWires();
    drawFlowchart();
    setInterval(()=>appendRow('dev-tbody','dev'),2000);
    setInterval(()=>appendRow('biz-tbody','biz'),2400);
  },500);
});
window.addEventListener('resize',()=>{clearTimeout(window._rt);window._rt=setTimeout(()=>{drawWires();},200);});
</script>
</body>
</html>